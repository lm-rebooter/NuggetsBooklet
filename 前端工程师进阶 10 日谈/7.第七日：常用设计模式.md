# ç¬¬ä¸ƒå¤© å¸¸ç”¨è®¾è®¡æ¨¡å¼

## ç¬¬ä¸€ä¸ªæ•…äº‹ï¼šå›¾ç‰‡é¢„è§ˆ

å¦‚æœè¯´ç»„ä»¶å°è£…æ˜¯ä¸ºäº†è®©å…¶ä»–ç¨‹åºå‘˜èƒ½å¤Ÿå¤ç”¨å’Œæ‰©å±•æˆ‘ä»¬çš„UIç»„ä»¶ï¼Œé‚£ä¹ˆè®¾è®¡æ¨¡å¼çš„æ„ä¹‰åˆ™åœ¨äºè®©å…¶ä»–ç¨‹åºå‘˜èƒ½å¤Ÿå¤ç”¨æˆ‘ä»¬çš„**è§£å†³æ–¹æ¡ˆ**ã€‚è®¾è®¡æ¨¡å¼ç®€å•æ¥è¯´å°±æ˜¯è§£å†³åœ¨ä¸€ä¸ªç‰¹å®šä¸Šä¸‹æ–‡ä¸­ä¸€ä¸ªé—®é¢˜çš„ä¸€ç§è§£å†³æ–¹æ¡ˆã€‚æ‰€ä»¥ï¼Œä»Šå¤©çš„æ•…äº‹ï¼Œæˆ‘ä»¬å°±æ¥èŠèŠå‰ç«¯å¼€å‘ä¸­å¸¸ç”¨çš„è®¾è®¡æ¨¡å¼ã€‚

### æŠ½è±¡è¡Œä¸ºï¼ˆbehaviorï¼‰

æˆ‘ä»¬çš„ä»»åŠ¡æ˜¯è¿™æ ·çš„ï¼Œç»™ä¸€ä¸ªå›ºå®šåˆ—è¡¨ä¸­çš„å›¾ç‰‡å…ƒç´ å¢åŠ â€œé¢„è§ˆâ€åŠŸèƒ½ã€‚

å¯¹åº”çš„HTMLé¡µé¢å¦‚ä¸‹æ‰€ç¤ºï¼š

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>å›¾ç‰‡é¢„è§ˆ</title>
  <style>
    #list {
      list-style-type: none;
      justify-content: flex-start;
      display: flex;
      flex-wrap: wrap;
    }

    #list li {
      padding: 10px;
      margin: 0;
    }
    #list img {
      height: 200px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <ul id="list">
    <li>
      <img src="https://p4.ssl.qhimg.com/t01713d89cfdb45cdf5.jpg">
    </li>
    <li>
      <img src="https://p4.ssl.qhimg.com/t01e456146c8f8a639a.jpg">
    </li>
    <li>
      <img src="https://p1.ssl.qhimg.com/t015f613e2205b573d8.jpg">
    </li>
    <li>
      <img src="https://p0.ssl.qhimg.com/t01290338a28018d404.jpg">
    </li>
    <li>
      <img src="https://p3.ssl.qhimg.com/t01d9aa5ae469c8862e.jpg">
    </li>
    <li>
      <img src="https://p3.ssl.qhimg.com/t01cb20d35fc4aa3c0d.jpg">
    </li>
    <li>
      <img src="https://p5.ssl.qhimg.com/t0110b30256941b9611.jpg">
    </li>
  </ul>
</body>
</html>
```

æ˜¾ç¤ºçš„UIæ•ˆæœå¦‚å›¾æ‰€ç¤ºï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/15e3be30345e45ce8b4b74659c3e526e~tplv-k3u1fbpfcp-zoom-1.image)

è¦å®ç°çš„åŠŸèƒ½æ˜¯ï¼Œé¼ æ ‡ç‚¹å‡»åˆ°åˆ—è¡¨ä¸­çš„å›¾ç‰‡ä¸Šï¼Œæ˜¾ç¤ºå¯¹åº”å›¾ç‰‡ï¼ˆç¼©ç•¥å›¾ï¼‰çš„é«˜æ¸…å¤§å›¾å¹¶å¸¦æœ‰â€œä¸Šä¸€å¼ â€ã€â€œä¸‹ä¸€å¼ â€çš„åˆ‡æ¢æŒ‰é’®ã€‚

è¿™ä¸ªä»»åŠ¡çš„è§£å†³æ–¹æ¡ˆå¾ˆå¤šï¼šä½ å¯ä»¥æŒ‰ç…§å¸¸è§„åšæ³•ï¼Œç»™æ¯å¼ å›¾ç‰‡æ³¨å†Œä¸€ä¸ªäº‹ä»¶ç›‘å¬å™¨ï¼Œå“åº”ç”¨æˆ·çš„ç‚¹å‡»ï¼Œæ˜¾ç¤ºè¯¥å›¾çš„é¢„è§ˆï¼›ä½ ä¹Ÿå¯ä»¥æŒ‰ç…§ç»„ä»¶å°è£…çš„æ€è·¯ï¼Œè®¾è®¡ä¸€ä¸ªé¢„è§ˆåŠŸèƒ½çš„UIç»„ä»¶ã€‚ä½†æ˜¯ï¼Œä»Šå¤©æˆ‘ä»¬çš„ä¸»é¢˜æ˜¯è®¾è®¡æ¨¡å¼ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬æƒ³ä½¿ç”¨â€œæŠ½è±¡è¡Œä¸ºâ€çš„è®¾è®¡æ¨¡å¼æ¥å®ç°è¿™ä¸ªä»»åŠ¡ã€‚è¿™ç§æ¨¡å¼åº”ç”¨äº†ç¬¬å››æ—¥çš„è¿‡ç¨‹æŠ½è±¡çš„æ€æƒ³ï¼Œæ˜¯æ¯”ç»„ä»¶åŒ–æ›´åŠ è½»é‡çš„ä¸€ç§è§£å†³æ€è·¯ã€‚
<!-- åœ¨ç¬¬å››æ—¥ï¼Œæˆ‘ä»¬å·²ç»è®¨è®ºè¿‡äº†ç»„ä»¶å°è£…ã€‚åƒè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å½“ç„¶ä¹Ÿå¯ä»¥ç”¨ç»„ä»¶åŒ–çš„æ€è·¯å»è§£å†³å®ƒã€‚ä¸è¿‡é™¤äº†ç»„ä»¶åŒ–ï¼Œæˆ‘ä»¬ä¹Ÿè¿˜æœ‰å¦ä¸€ç§é€‰æ‹©ï¼Œä½¿ç”¨â€œè¡Œä¸ºæŠ½è±¡â€çš„è®¾è®¡æ¨¡å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚è¿™æ˜¯ä¸€ç§åº”ç”¨ç¬¬äº”æ—¥è¿‡ç¨‹æŠ½è±¡æ€æƒ³ï¼Œæ¯”ç»„ä»¶åŒ–æ›´è½»é‡çš„è§£å†³æ€è·¯ã€‚ -->

ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€çœ‹æŠ½è±¡è¡Œä¸ºæ˜¯å¦‚ä½•å®ç°è¿™ä¸ªé¢„è§ˆè¡Œä¸ºçš„ï¼š

```js
const list = document.getElementById('list');
list.addEventListener('click', (evt) => {
  const target = evt.target;
  if(target.tagName === 'IMG') {
    preview(list, target);
  }
});
```
ä¸Šé¢çš„ä»£ç æ˜¯`click`äº‹ä»¶å¤„ç†å‡½æ•°ã€‚å½“ç‚¹å‡»çš„`target`æ˜¯å›¾ç‰‡æ—¶ï¼Œåˆ™æ‰§è¡Œ`preview(list,target)`å‡½æ•°ã€‚è¿™ä¸ª`preview`å‡½æ•°å°±æ˜¯æˆ‘ä»¬çš„é¢„è§ˆè¡Œä¸ºã€‚

ä¸‹é¢æˆ‘ä»¬é‡ç‚¹çœ‹çœ‹`preview`è¡Œä¸ºæ˜¯å¦‚ä½•è¢«æŠ½è±¡å‡ºæ¥çš„ï¼š

```js
function useBehavior(context) {
  const {type, getDetail} = context;
  return function (subject, target) {
    const event = new CustomEvent(type, {bubbles: true, detail: getDetail.call(context, subject, target)});
    target.dispatchEvent(event);
  };
}
```

å¦‚ä¸Šä»£ç æ‰€ç¤ºï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå¾ˆç®€çŸ­çš„å‡½æ•°`useBehavior(context)`ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯ä¸€ä¸ªé«˜é˜¶å‡½æ•°ï¼Œå®ƒè¿”å›çš„æ˜¯ä»£è¡¨ç‰¹å®šè¡Œä¸ºçš„æ–¹æ³•ã€‚å½“è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ—¶ï¼Œä¼ å…¥`subject`å’Œ`target`ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰äº‹ä»¶ï¼Œå¹¶é€šè¿‡æ‰§è¡Œ`getDetail`è·å–åˆ°èµ‹ç»™è¯¥äº‹ä»¶å‚æ•°çš„detailå†…å®¹ï¼Œç„¶åä»¥`target`ä¸ºç›®æ ‡æ´¾å‘è¿™ä¸ªè‡ªå®šä¹‰äº‹ä»¶ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡å®ƒå®šä¹‰ä¸€ä¸ªå«åšâ€œpreviewâ€çš„è¡Œä¸ºï¼š

```js
const preview = useBehavior({
  type: 'preview',

  /*
    @subject: <ul>å…ƒç´ 
    @target: é€‰ä¸­çš„å›¾ç‰‡å…ƒç´ 
  */
  getDetail(subject, target) {
    const imgs = Array.from(subject.querySelectorAll('img'));
    const selected = imgs.indexOf(target); // è·å–é€‰ä¸­å›¾ç‰‡åœ¨å›¾ç‰‡é›†åˆä¸­çš„ç´¢å¼•å·
    let mask = document.getElementById('mask');

    // å¦‚æœmaskä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªmaskå…ƒç´ 
    if(!mask) {
      mask = document.createElement('div');
      mask.id = 'mask';
      mask.innerHTML = `
        <a class="previous" href="###">&lt;</a>
        <img src="${imgs[selected].src}">
        <a class="next" href="###">&gt;</a>    
      `;
      // ç»™ #mask å…ƒç´ è®¾ç½®æ ·å¼ï¼š
      Object.assign(mask.style, {
        position: 'absolute',
        left: 0,
        top: 0,
        width: '100%',
        height: '100%',
        backgroundColor: 'rgba(0,0,0,0.8)',
        display: 'none',
        alignItems: 'center',
        justifyContent: 'space-between',
      });

      // ç»™ #mask å…ƒç´ å·¦å³ä¸¤è¾¹çš„<a>å…ƒç´ è®¾ç½®æ ·å¼ï¼š
      mask.querySelectorAll('a').forEach((a) => {
        Object.assign(a.style, {
          width: '30px',
          textAlign: 'center',
          fontSize: '2rem',
          color: '#fff',
          textDecoration: 'none',
        });
      });
      document.body.appendChild(mask);

      // ç»™#maskå…ƒç´ æ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†å‡½æ•°ï¼š
      let idx = selected;
      mask.addEventListener('click', (evt) => {
        const target = evt.target;
        if(target === mask) { // å¦‚æœç‚¹å‡»çš„å¯¹è±¡æ˜¯maskå…ƒç´ ï¼Œåˆ™éšè—maskå…ƒç´ 
          mask.style.display = 'none';
        } else if(target.className === 'previous') { // æ˜¾ç¤ºä¸Šä¸€å¼ å›¾ç‰‡
          update(--idx);
        } else if(target.className === 'next') { // æ˜¾ç¤ºä¸‹ä¸€å¼ å›¾ç‰‡
          update(++idx);
        }
      });
    }

    // è®¾ç½®imgå…ƒç´ çš„srcå±æ€§æŒ‡å‘æŒ‡å®šå›¾ç‰‡
    function update(idx) {
      const [previous, next] = [...mask.querySelectorAll('a')];
      previous.style.visibility = idx ? 'visible' : 'hidden';
      next.style.visibility = idx < imgs.length - 1 ? 'visible' : 'hidden';
      const img = mask.querySelector('img');
      img.src = imgs[idx].src;
    }

    return {
      showMask() { // æ˜¾ç¤ºé€‰ä¸­å›¾ç‰‡çš„é¢„è§ˆ
        mask.style.display = 'flex';
        update(selected);
      },
    };
  },
});
```

åœ¨`getDetail`æ–¹æ³•é‡Œï¼Œæˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ª`id=mask`çš„`<div>`å…ƒç´ ï¼Œå®ƒçš„ç»“æ„å¦‚ä¸‹ï¼š

```html
<div id="mask">
  <a class="previous" href="###">&lt;</a>
  <img src="${imgs[selected].src}">
  <a class="next" href="###">&gt;</a>
</div>
```

ç„¶åç»™`#mask`å…ƒç´ è®¾ç½®æ ·å¼ï¼š

```js
Object.assign(mask.style, {
  position: 'absolute',
  left: 0,
  top: 0,
  width: '100%',
  height: '100%',
  backgroundColor: 'rgba(0,0,0,0.8)',
  display: 'flex',
  alignItems: 'center',
  justifyContent: 'space-between',
});
mask.querySelectorAll('a').forEach((a) => {
  Object.assign(a.style, {
    width: '30px',
    textAlign: 'center',
    fontSize: '2rem',
    color: '#fff',
    textDecoration: 'none',
  });
});
document.body.appendChild(mask);
```

æ¥ç€æ·»åŠ é¼ æ ‡ç‚¹å‡»`mask`å…ƒç´ ï¼Œä»¥åŠå·¦å³ä¸¤ä¾§ç®­å¤´ï¼ˆå³`a.previous`å’Œ`a.next`ä¸¤ä¸ªå…ƒç´ ï¼‰æ—¶è§¦å‘çš„åŠ¨ä½œï¼š

```js
mask.addEventListener('click', (evt) => {
  const target = evt.target;
  if(target === mask) {
    mask.style.display = 'none';
  } else if(target.className === 'previous') {
    update(--idx);
  } else if(target.className === 'next') {
    update(++idx);
  }
});
```

`update`æ–¹æ³•æ˜¾ç¤º`idx`å¯¹åº”çš„å›¾ç‰‡ï¼Œä»¥åŠæ ¹æ®å›¾ç‰‡çš„ä½ç½®å†³å®šæ˜¯å¦æ˜¾ç¤ºå·¦å³ç®­å¤´:

```js
function update(idx) {
  const [previous, next] = [...mask.querySelectorAll('a')];
  previous.style.visibility = idx ? 'visible' : 'hidden';
  next.style.visibility = idx < imgs.length - 1 ? 'visible' : 'hidden';
  const img = mask.querySelector('img');
  img.src = imgs[idx].src;
}
```

æœ€åï¼Œæˆ‘ä»¬è¿”å›ä¸€ä¸ª`showMask()`æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯å°†`id=mask`çš„`<div>`å…ƒç´ çœŸæ­£æ˜¾ç¤ºå‡ºæ¥ã€‚

```js
return {
  showMask(){
    mask.style.display = 'flex';
    update(selected);
  },
};
```
<!-- è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨listä¸Šè§¦å‘è¿™ä¸ªpreviewè¡Œä¸ºï¼š

```js
const list = document.getElementById('list');
list.addEventListener('click', (evt) => {
  const target = evt.target;
  if(target.tagName === 'IMG') {
    preview(list, target);
  }
}); 
``` -->

æ¥ç€æˆ‘ä»¬è¦é€šè¿‡é¼ æ ‡clickäº‹ä»¶è§¦å‘previewè¡Œä¸ºï¼š

```js
const list = document.getElementById('list');
list.addEventListener('click', (evt) => {
  const target = evt.target;
  if(target.tagName === 'IMG') {
    preview(list, target);
  }
});
```

ç„¶åï¼Œæˆ‘ä»¬è®©`#list`å…ƒç´ ç›‘å¬`preview`äº‹ä»¶ï¼š

```js
list.addEventListener('preview', ({detail}) => {
  detail.showMask();
});
```

åœ¨`preview`äº‹ä»¶ç›‘å¬å™¨ä¸­æˆ‘ä»¬æ‰§è¡Œ`detail.showMask()`ï¼Œå°±èƒ½è§¦å‘å›¾ç‰‡é¢„è§ˆçš„åŠŸèƒ½äº†ã€‚[åœ¨çº¿æ¼”ç¤º](https://junyux.github.io/FE-Advance/day07/index1.html)

ä»ä¸Šè¿°çš„è§£å†³æ–¹æ¡ˆï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡æŠ½è±¡è¡Œä¸ºçš„æ¨¡å¼ï¼Œæˆ‘ä»¬å°†â€œé¢„è§ˆâ€è¿™ä¸ªè¡Œä¸ºä»ç»„ä»¶ä¸­å‰¥ç¦»å‡ºæ¥ï¼Œé™ä½äº†ç»„ä»¶å’Œè¡Œä¸ºçš„è€¦åˆåº¦ã€‚è¿™æ ·åšç©¶ç«Ÿæœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿ

<!-- çœ‹åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½ä¼šå¯¹è¿™ä¸ªé™ä½ç»„ä»¶è¡Œä¸ºè€¦åˆåº¦çš„è®¾è®¡æ€æƒ³æœ‰æ‰€ä½“ä¼šï¼Œä½†åŒæ—¶ä¹Ÿä¼šè§‰å¾—æœ‰äº›ç–‘é—®ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬è¦ç»•ä¸€å¤§åœˆï¼Œå…ˆè®¾è®¡ä¸€ä¸ª`useBehavior`ï¼Œå†é€šè¿‡`useBehavior`å®šä¹‰`preview`è¡Œä¸ºï¼Œç„¶ååœ¨`preview`è¡Œä¸ºçš„`getDetail`æ–¹æ³•é‡Œè¿”å›`showMask`ï¼Œæœ€åå†åœ¨`preview`äº‹ä»¶ä¸­è°ƒç”¨`showMask()`ï¼Ÿ

æ²¡æœ‰å…³ç³»ï¼Œä½ å¯ä»¥å…ˆå¸¦ç€è¿™ä¸ªç–‘é—®ï¼Œéšç»§ç»­æˆ‘ä»¬æ·±å…¥ä¸‹å»ï¼Œçœ‹çœ‹è¿™ä¹ˆè®¾è®¡ç©¶ç«Ÿæœ‰ä»€ä¹ˆå¥½å¤„ã€‚ -->

## ç¬¬äºŒä¸ªæ•…äº‹ï¼šå›¾ç‰‡é€‰æ‹©å™¨

è¿™ä¸ªæ•…äº‹ï¼Œæˆ‘ä»¬ä¾ç„¶ä½¿ç”¨å’Œç¬¬ä¸€ä¸ªæ•…äº‹ç›¸ä¼¼çš„HTMLç»“æ„ï¼Œå®ç°ä¸€ä¸ªä¸å›¾ç‰‡é¢„è§ˆç±»ä¼¼çš„åŠŸèƒ½ï¼Œå«åšå›¾ç‰‡é€‰æ‹©å™¨ï¼š

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>æŠ½è±¡è¡Œä¸º</title>
  <style>
    #list {
      list-style-type: none;
      justify-content: flex-start;
      display: flex;
      flex-wrap: wrap;
    }

    #list li {
      padding: 10px;
      margin: 0;
    }
    #list img {
      height: 200px;
      cursor: pointer;
      box-sizing: border-box;
      padding: 5px;
    }

    #list img.selected {
      border: solid 5px #37c;
      padding: 0;
    }
  </style>
</head>
<body>
  <ul id="list">
    <li>
      <img src="https://p4.ssl.qhimg.com/t01713d89cfdb45cdf5.jpg">
    </li>
    <li>
      <img src="https://p4.ssl.qhimg.com/t01e456146c8f8a639a.jpg">
    </li>
    <li>
      <img src="https://p1.ssl.qhimg.com/t015f613e2205b573d8.jpg">
    </li>
    <li>
      <img src="https://p0.ssl.qhimg.com/t01290338a28018d404.jpg">
    </li>
    <li>
      <img src="https://p3.ssl.qhimg.com/t01d9aa5ae469c8862e.jpg">
    </li>
    <li>
      <img src="https://p3.ssl.qhimg.com/t01cb20d35fc4aa3c0d.jpg">
    </li>
    <li>
      <img src="https://p5.ssl.qhimg.com/t0110b30256941b9611.jpg">
    </li>
  </ul>
</body>
</html>
```

ä¸Šé¢çš„HTMLå’Œå‰é¢çš„å›¾ç‰‡é¢„è§ˆåŸºæœ¬ä¸Šä¸€æ ·ï¼Œåªæ˜¯æœ‰äº›ç»†èŠ‚çš„CSSæ ·å¼ä¿®æ”¹ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a01d2cee73f848158bdd2c3f9812b0bc~tplv-k3u1fbpfcp-zoom-1.image)

æ²¿ç”¨å›¾ç‰‡é¢„è§ˆçš„æ€è·¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°†å›¾ç‰‡é€‰æ‹©å™¨çš„â€œé€‰æ‹©â€è¡Œä¸ºæŠ½è±¡å‡ºæ¥ï¼Œå®ƒæ¯”å›¾ç‰‡é¢„è§ˆæ›´åŠ ç®€å•ï¼š

```js
function useBehavior(context) {
  const {type, getDetail} = context;
  return function(subject, target) {
    const event = new CustomEvent(type, {bubbles: true, detail: getDetail.call(context, subject, target)});
    target.dispatchEvent(event);
  }
}

const select = useBehavior({
  type: 'select',
  data: {
    picked: new Set(), // é€‰ä¸­çš„å›¾ç‰‡é›†åˆ
  },
  getDetail(subject, target) {
    const picked = this.data.picked;

    if(picked.has(target)) {
      target.className = '';
      picked.delete(target);
    } else {
      target.className = 'selected';
      picked.add(target);
    }

    return {
      changed: target,
      picked,
    };
  },
});
```

åœ¨`select`è¡Œä¸ºé‡Œï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ª`picked`é›†åˆï¼Œç”¨æ¥å­˜æ”¾æ‰€æœ‰é€‰ä¸­çš„å›¾ç‰‡å…ƒç´ ã€‚`getDetail`å‡½æ•°ä»…ä»…åšä¸€ä»¶äº‹æƒ…ï¼Œå¦‚æœ`target`åœ¨`picked`é›†åˆä¸­ï¼Œå°†å®ƒç§»å‡ºé›†åˆå¹¶æ’¤é”€`img`å…ƒç´ çš„æ ·å¼ï¼Œå¦åˆ™ï¼Œå°†å®ƒæ”¾å…¥é›†åˆå¹¶æ·»åŠ `img`å…ƒç´ çš„æ ·å¼ã€‚

_ğŸ’¡æ³¨æ„ï¼Œåœ¨`useBehavior`å®šä¹‰ä¸­ï¼Œæˆ‘ä»¬å°†`context`ä½œä¸º`getDetail`çš„`this`ä¸Šä¸‹æ–‡ä¼ å…¥ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨å®é™…å®ç°`getDetail`æ–¹æ³•çš„æ—¶å€™ï¼Œé€šè¿‡`this`ä¸Šä¸‹æ–‡æ‹¿åˆ°è°ƒç”¨`useBehavior`çš„å¯¹è±¡ä¸Šçš„æ•°æ®ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥çµæ´»åœ°ç»™`getDetail`æ“ä½œæä¾›éœ€è¦çš„åˆå§‹æ•°æ®äº†ã€‚_

ç„¶åï¼Œæˆ‘ä»¬ç»™`#list`å…ƒç´ æ·»åŠ `click`å’Œ`select`äº‹ä»¶å¤„ç†å‡½æ•°ï¼š

```js
const list = document.getElementById('list');
list.addEventListener('click', (evt) => {
  const target = evt.target;
  if(target.tagName === 'IMG') {
    select(list, target);
  }
});

list.addEventListener('select', ({detail}) => {
  // do nothing
  console.log(detail.changed, detail.picked);
});
```

ä¸Šé¢çš„ä»£ç ä¸­ï¼Œè™½ç„¶ç°åœ¨`select`äº‹ä»¶å¤„ç†å‡½æ•°ä¸å¤„ç†ä»»ä½•äº‹æƒ…ï¼Œä½†æ˜¯æˆ‘ä»¬ä¾ç„¶å¯ä»¥ç›‘å¬å®ƒï¼Œä»¥ä¾¿å°†æ¥å¯¹é€‰æ‹©çš„å¯¹è±¡è¿›è¡Œä¸‹ä¸€æ­¥åŠ¨ä½œã€‚å®ƒçš„æ•ˆæœå¦‚ä¸‹æ‰€ç¤ºï¼š
<!-- è¿™æ ·æˆ‘ä»¬å°±å®ç°äº†é€‰æ‹©å¤šå¼ å›¾ç‰‡çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥ç›‘å¬`select`æ–¹æ³•ï¼Œä»¥ä¾¿äºè¿›ä¸€æ­¥å¯¹é€‰æ‹©çš„å¯¹è±¡è¿›è¡Œä¸‹ä¸€æ­¥åŠ¨ä½œã€‚ -->
[åœ¨çº¿æ¼”ç¤º](https://junyux.github.io/FE-Advance/day07/index2.html)

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8c6277501c6c40389b75d9222d435acf~tplv-k3u1fbpfcp-zoom-1.image)


é€šè¿‡ç¬¬ä¸€ä¸ªæ•…äº‹å’Œç¬¬äºŒä¸ªæ•…äº‹ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠâ€œé¢„è§ˆâ€å’Œâ€œé€‰æ‹©â€è¿™ä¸¤ä¸ªè¡Œä¸ºç»„åˆèµ·æ¥ã€‚æ¯”å¦‚ï¼Œå½“é¼ æ ‡ç‚¹å‡»çš„åŒæ—¶ï¼Œæˆ‘ä»¬æŒ‰ä¸‹altå»ºï¼Œå°±è¡¨ç¤ºé€‰æ‹©å›¾ç‰‡ï¼›å¦åˆ™å°±æ˜¯é¢„è§ˆå›¾ç‰‡ï¼š
<!-- ç»è¿‡æˆ‘ä»¬è¿™ä¹ˆæŠ½è±¡äº†ä¹‹åï¼Œæˆ‘ä»¬å®é™…ä¸Šå¯ä»¥æŠŠå¤šç§è¡Œä¸ºç»„åˆåœ¨ä¸€èµ·ï¼Œæ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬æƒ³è¦åŒæ—¶æ”¯æŒå›¾ç‰‡é¢„è§ˆå’Œå›¾ç‰‡é€‰æ‹©ï¼Œå¯ä»¥è¿™ä¹ˆåšï¼š -->

[åœ¨çº¿æ¼”ç¤º](https://junyux.github.io/FE-Advance/day07/index3.html)

```js
/* ...çœç•¥å…¶ä»–ä»£ç ... */

const list = document.getElementById('list');
list.addEventListener('click', (evt) => {
  const target = evt.target;
  if(target.tagName === 'IMG') {
    if(evt.altKey) {
      select(list, target);
    } else {
      preview(list, target);
    }
  }
});

list.addEventListener('preview', ({detail}) => {
  const {showMask} = detail;
  showMask();
});
```
å¦‚ä¸Šä»£ç æ‰€ç¤ºï¼ŒæŠ½è±¡è¡Œä¸ºçš„æ¨¡å¼å…è®¸ä¸€ä¸ªç»„ä»¶å¯ä»¥çµæ´»çš„**ç»„åˆæˆ–å¸è½½**å¤šä¸ªè¡Œä¸ºï¼Œä¸”äº’ä¸å†²çªã€‚

<!-- è¿™ä¸ªä»£ç é‡Œï¼Œæˆ‘ä»¬ç»„åˆäº†ä¸¤ç§ä¸åŒçš„è¡Œä¸ºï¼š`preview`å’Œ`select`ï¼Œåœ¨clickäº‹ä»¶ä¸­ï¼Œæˆ‘ä»¬åˆ¤æ–­alté”®æ˜¯å¦è¢«æŒ‰ä¸‹ï¼Œå¦‚æœè¢«æŒ‰ä¸‹ï¼Œæ‰§è¡Œçš„æ˜¯selectï¼Œå¦åˆ™æ‰§è¡Œçš„æ˜¯previewï¼Œè¿™æ ·çš„ä¸¤ä¸ªè¡Œä¸ºäº’ä¸å†²çªï¼Œå¯ä»¥å¾ˆå¥½åœ°ç»“åˆåœ¨ä¸€èµ·ä½¿ç”¨ã€‚ -->

<!-- åœ¨ä¸€å’ŒäºŒä¸¤ä¸ªæ•…äº‹é‡Œï¼Œæˆ‘ä»¬å®é™…ä¸ŠæŠ½è±¡äº†ä¸€ä¸ªâ€behaviorâ€œçš„è®¾è®¡æ¨¡å¼ï¼Œé€šè¿‡å®ƒæˆ‘ä»¬å®šä¹‰UIçš„è¡Œä¸ºï¼Œå¹¶å°†è¡Œä¸ºäº§ç”Ÿçš„çŠ¶æ€å˜åŒ–ç”¨è‡ªå®šä¹‰äº‹ä»¶æ´¾å‘çš„æ–¹å¼é€šçŸ¥å‡ºæ¥ã€‚è¿™ä¹ˆåšçš„æ„ä¹‰åœ¨äºï¼Œæˆ‘ä»¬å°†æ¯ä¸€æ¬¡è¡Œä¸ºå¯¼è‡´çš„UIæ”¹å˜ç‹¬ç«‹å°è£…èµ·æ¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨åšç»„ä»¶çš„å¤æ‚è¡Œä¸ºçš„æ—¶å€™ï¼Œå°±å¯ä»¥æ¯”è¾ƒè‡ªç”±åœ°éšæ„ç»„åˆå®ƒä»¬ã€‚ -->

ä½†æ˜¯ï¼Œä¸Šé¢çš„ä¾‹å­åªæ˜¯éå¸¸ç²—ç•¥çš„æŠ½è±¡æ–¹å¼ï¼Œè€Œä¸”è¿˜æœ‰ä¸€äº›äº‰è®®ç‚¹ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥å°†é¢„è§ˆè¡Œä¸ºä¸­çš„`showMask`æ“ä½œç›´æ¥æ”¾åœ¨`getDetail`é‡Œé¢å®Œæˆï¼Œä¸ºä»€ä¹ˆè¦å°†å®ƒæš´éœ²ç»™äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œåœ¨å¤„ç†å‡½æ•°ä¸­æ‰‹å·¥è°ƒç”¨ï¼Ÿå¦å¤–ï¼Œ`select`è¡Œä¸ºä¸­ï¼Œæˆ‘ä»¬ä¸ºä»€ä¹ˆåˆå°†`className`çš„å˜åŒ–æ”¾åœ¨`getDetail`é‡Œé¢è€Œä¸æ˜¯å°†å®ƒäº¤ç»™äº‹ä»¶å¤„ç†å‡½æ•°ï¼Ÿ

è¿™é‡Œæ˜¯æœ‰å¯æƒè¡¡çš„åœ°æ–¹ï¼Œå®é™…ä¸ŠæŠŠæ“ä½œæ”¾åœ¨å“ªè¾¹ï¼Œéƒ½å„æœ‰åˆ©å¼Šã€‚ä¸è¿‡æˆ‘ä»¬ä¸€èˆ¬éµå¾ªä¸€ä¸ªå¤§çš„åŸåˆ™â€”â€”å¦‚æœæ“ä½œåªæ˜¯å¤„ç†æ•°æ®æˆ–æ”¹å˜çŠ¶æ€ï¼Œé‚£ä¹ˆå°†å®ƒæ”¾åœ¨`getDetail`ä¸­ï¼›ä½†æ˜¯å¦‚æœåŒæ—¶æ”¹å˜äº†DOMç»“æ„ï¼Œæ¯”å¦‚åˆ›å»ºæˆ–åˆ é™¤äº†å…ƒç´ ï¼Œé‚£ä¹ˆè¿™äº›æ“ä½œæˆ‘ä»¬å¯ä»¥äº¤ç»™äº‹ä»¶å¤„ç†å‡½æ•°å¤„ç†ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ`getDetail`å‡½æ•°åªå¤„ç†æ•°æ®æˆ–è€…æ”¹å˜å…ƒç´ çš„`className`ï¼ˆå³çŠ¶æ€ï¼‰ï¼Œä¸å¯¹DOMæ ‘çš„ç»“æ„åšä¿®æ”¹ã€‚å› ä¸ºè¿™æ ·æ‰èƒ½ä¿è¯åœ¨ç»„åˆå¤šä¸ªè¡Œä¸ºä¸‹ï¼ŒDOMç»“æ„çš„ç¨³å®šï¼Œå¦åˆ™ä¸€ä¸ªè¡Œä¸ºæ“ä½œçš„DOMå…ƒç´ è¢«å¦ä¸€ä¸ªè¡Œä¸ºåˆ é™¤å°±ä¼šå¯¼è‡´å†²çªã€‚

<!-- å› ä¸ºåªæœ‰ä¿è¯è¿™ä¸€åŸåˆ™ï¼Œæ‰èƒ½ä¿è¯DOMç»“æ„çš„ç¨³å®šï¼Œè€Œè¿™æ˜¯ç»„åˆå„ä¸ªè¡Œä¸ºçš„ä¸€ä¸ªå‰æï¼Œå› ä¸ºåªæœ‰è¿™æ ·æ‰ä¸ä¼šç”±äºä¸€ä¸ªè¡Œä¸ºæ“ä½œçš„DOMå…ƒç´ è¢«å¦ä¸€ä¸ªè¡Œä¸ºåˆ é™¤è€Œå¯¼è‡´å†²çªã€‚ -->

æŠ½è±¡è¡Œä¸ºï¼ˆbehaviorï¼‰æ¨¡å¼è¿˜æœ‰å¾ˆå¤šç”¨é€”ï¼Œå¯ä»¥åˆ›é€ éå¸¸å¤æ‚çš„è¡Œä¸ºï¼Œæˆ‘ä»¬å°†ä¼šåœ¨è®¾è®¡æ¨¡å¼çš„è¯¾ç¨‹ä¸­è¯¦ç»†ä»‹ç»ã€‚ä¸‹ä¸€ä¸ªæ•…äº‹ï¼Œæˆ‘ä»¬æ¥çœ‹å¦ä¸€ä¸ªå‰ç«¯å¸¸ç”¨çš„è®¾è®¡æ¨¡å¼ â€”â€” ä¸­é—´äººæ¨¡å¼ã€‚

## ç¬¬ä¸‰ä¸ªæ•…äº‹ï¼šæ»šåŠ¨çš„æ–‡å­—

æˆ‘ä»¬æ¥ä¸‹æ¥çš„æ–°ä»»åŠ¡æ˜¯å®ç°ä¸€ä¸ªåŒæ­¥æ»šåŠ¨çš„ç¼–è¾‘ä¸é¢„è§ˆåŒºï¼Œè¿™æ˜¯ä¸€äº›åœ¨çº¿ç¼–è¾‘ç±»Webåº”ç”¨å¸¸è§çš„ä¸€ç§äº¤äº’å½¢å¼ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7f707a4a1f2e48c4ba911753d53a5dbb~tplv-k3u1fbpfcp-zoom-1.image)

_åŒæ­¥æ»šåŠ¨çš„ç¼–è¾‘ä¸é¢„è§ˆåŒº_

è¿™æ˜¯é¡µé¢çš„HTMLç»“æ„ï¼š

```html
<body>
  <textarea id="editor" oninput="this.editor.update()"
            rows="6" cols="60">
åœ¨ 2001 åˆ° 2003 å¹´é—´ï¼ŒJudith Miller åœ¨çº½çº¦æ—¶æŠ¥ä¸Šå‘è¡¨äº†ä¸€æ‰¹æ–‡ç« ï¼Œå®£ç§°ä¼Šæ‹‰å…‹æœ‰èƒ½åŠ›å’Œé‡å¿ƒç”Ÿäº§å¤§è§„æ¨¡æ€ä¼¤æ€§æ­¦å™¨ã€‚è¿™æ˜¯å‡æ–°é—»ã€‚

å›é¡¾å½“å¹´ï¼Œæˆ‘ä»¬æ— æ³•ç¡®å®š Miller å†™çš„è¿™äº›æ•…äº‹åœ¨ç¾å›½ 2013 å¹´åšå‡ºå‘åŠ¨ä¼Šæ‹‰å…‹æˆ˜äº‰çš„å†³å®šä¸­æ‰®æ¼”äº†æ€æ ·çš„è§’è‰²ï¼›ä¸ Miller ç›¸åŒæ¥æºçš„æ¶ˆæ¯ä¸å°å¸ƒä»€æ”¿åºœçš„å¯¹å¤–æ”¿ç­–å›¢é˜Ÿæœ‰å¾ˆå¤§å…³è”ã€‚ä½†æ˜¯ï¼Œçº½çº¦æ—¶æŠ¥ä»ç„¶èµ·åˆ°äº†ä¸ºè¿™ä¸€æ”¿ç­–èƒŒä¹¦çš„ä½œç”¨ï¼Œå°¤å…¶æ˜¯å¯¹æ°‘ä¸»å…šäººï¼Œæœ¬æ¥ä»–ä»¬åº”è¯¥ä¼šæ›´åšå®šåœ°åå¯¹å°å¸ƒä»€çš„æ”¿ç­–ã€‚æ¯•ç«Ÿï¼Œçº½çº¦æ—¶æŠ¥å¯ä¸æ˜¯ä¸€äº›æ— äººé—®æ´¥çš„åœ°æ–¹å°æŠ¥ï¼Œå®ƒæ˜¯æ•´ä¸ªç¾å›½å½±å“åŠ›æœ€å¤§çš„æŠ¥åˆŠï¼Œå®ƒä¸€èˆ¬è¢«è®¤ä¸ºå…·æœ‰å·¦å€¾å€¾å‘ã€‚Miller çš„æ•…äº‹æŸç§ç¨‹åº¦ä¸Šå»åˆæŠ¥çº¸çš„æ”¿æ²»å€¾å‘ã€‚

æˆ‘ä»¬å¯ä»¥æŠŠ Miller çš„é”™è¯¯å’Œæœ€è¿‘å…³äº Facebook çš„å‡æ–°é—»é—®é¢˜è”ç³»èµ·æ¥çœ‹ï¼›Facebook ç”¨è‡ªå·±çš„æ•…äº‹å‘Šè¯«æˆ‘ä»¬â€œå‡æ–°é—»æ˜¯åçš„â€ã€‚ç„¶è€Œï¼Œæˆ‘æŒæœ‰ä¸åŒçš„è§‚ç‚¹ï¼š**æ–°é—»å‡ä¸å‡æ²¡é‚£ä¹ˆé‡è¦ï¼Œç”±è°æ¥å†³å®šä»€ä¹ˆæ˜¯æ–°é—»æ‰æ˜¯ç¬¬ä¸€é‡è¦çš„**ã€‚

<!--more-->

#### Facebook çš„åª’ä½“å•†ä¸šåŒ–

åœ¨[èšé›†ç†è®º](https://stratechery.com/2015/aggregation-theory/)ä¸­ï¼Œæˆ‘æè¿°äº†åŸºäºåˆ†é…çš„ç»æµæƒåˆ©çš„æ¶ˆäº¡å¯¼è‡´å¼ºåŠ¿ä¸­ä»‹çš„å´›èµ·ï¼Œå®ƒä»¬æŒæ§å®¢æˆ·ä½“éªŒå¹¶å°†å®ƒä»¬çš„ä¾›åº”å•†å•†å“åŒ–ã€‚[åœ¨ Facebook çš„ä¾‹å­é‡Œ](https://stratechery.com/2016/the-fang-playbook/)ï¼Œç¤¾äº¤ç½‘ç»œä¹‹æ‰€ä»¥å…´èµ·ï¼Œæ˜¯å› ä¸ºä¹‹å‰å­˜åœ¨çš„çº¿ä¸‹ç¤¾ä¼šç½‘ç»œåœ¨å¾€çº¿ä¸Šç½‘ç»œè½¬å˜ã€‚è€ƒè™‘åˆ°äººç±»æœ¬è´¨æ˜¯ç¤¾ä¼šåŒ–çš„ï¼Œç”¨æˆ·å¼€å§‹å°†æ—¶é—´èŠ±åœ¨ Facebook ä¸Šé˜…è¯»ã€å‘è¡¨è§‚ç‚¹å’Œè·å–æ–°é—»ã€‚

...ï¼ˆæ­¤å¤„çœç•¥ï¼‰
                     
  </textarea>
  <div id="preview"> </div>
  <div id="hintbar"> 0% </div>
</body>
```

CSSæ ·å¼ï¼š

```css
body{
  display: flex;
}

#editor {
  width: 45%;
  height: 350px;
  margin-right: 10px;
}

#preview {
  width: 45%;
  height: 350px;
  overflow: scroll;
}

#hintbar {
  position: absolute;
  right: 10px;
}
```

è¦å®ç°è¿™ä¸ªæ•ˆæœï¼Œè¦æ§åˆ¶3ä¸ªåŒºåŸŸçš„çŠ¶æ€ï¼Œå·¦ä¾§çš„ç¼–è¾‘åŒºï¼Œè¿™æ˜¯ä¸€ä¸ª`textare`å…ƒç´ å’Œå…¶ä¸­çš„æ–‡æœ¬ï¼Œä¸­é—´çš„é¢„è§ˆåŒºï¼Œè¿™æ˜¯ä¸€ä¸ª`id`ä¸º`preview`çš„`div`å…ƒç´ ï¼Œå³ä¾§æ˜¾ç¤ºè¿›åº¦ç™¾åˆ†æ¯”ä¿¡æ¯ï¼Œæ˜¯ä¸€ä¸ª`id`ä¸º`hintbar`çš„`div`å…ƒç´ ã€‚

æœ€ç®€å•çš„æ€è·¯æ˜¯æˆ‘ä»¬åŒæ­¥è¿™ä¸‰ä¸ªåŒºåŸŸçš„çŠ¶æ€ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„å®ç°ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬ä½¿ç”¨markdownçš„JSåº“æä¾›æ¥å£ï¼Œåˆ›å»ºä¸€ä¸ª`Editor`çš„å¯¹è±¡ï¼š

```js
function Editor(input, preview) {
  this.update = function () {
    preview.innerHTML = markdown.toHTML(input.value);
  };
  input.editor = this;
  this.update();
}
new Editor(editor, preview);
```
ä¸Šé¢çš„ä»£ç æŠŠ`editor`ä¸­çš„å†…å®¹ç»è¿‡markdownè§£æåèµ‹ç»™`preview`å…ƒç´ ã€‚

è€Œmarkdownåº“å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼åŠ è½½åˆ°æˆ‘ä»¬çš„é¡µé¢ä¸­ï¼š

```html
<script src="https://s3.ssl.qhres.com/!67fc024a/markdown.min.js"></script>
```

ç„¶åï¼Œæˆ‘ä»¬æ¥å®ç°ä¸‰éƒ¨åˆ†åŒæ­¥çš„åŠŸèƒ½ï¼š

```js
//ä¸‰éƒ¨åˆ† UI è€¦åˆåœ¨ä¸€èµ·çš„ update æ–¹æ³•
function update(src, dest, hint) {
  var scrollRange = src.scrollHeight - src.clientHeight,
      p = src.scrollTop / scrollRange;  
  
  dest.scrollTop = p * (dest.scrollHeight - dest.clientHeight);
  hint.innerHTML = Math.round(100 * p) + '%';
}

update(editor, preview, hintbar);
```
å¦‚ä¸Šä»£ç æ‰€ç¤ºï¼Œ`update`æ–¹æ³•è¯»å–æ»šåŠ¨å…ƒç´ ï¼ˆ`src`ï¼‰çš„æ»šåŠ¨ä½ç½®ï¼Œæ¢ç®—æˆç™¾åˆ†æ¯”ï¼Œç„¶åå°†è¢«åŒæ­¥çš„ç›®æ ‡å…ƒç´ ï¼ˆ`dest`ï¼‰çš„`scrollTop`å±æ€§è®¾ç½®ä¸ºå’Œè¿™ä¸ªç™¾åˆ†æ¯”å€¼å¯¹åº”çš„æ»šåŠ¨ä½ç½®ã€‚æœ€åï¼Œå°†è¿™ä¸ªç™¾åˆ†æ¯”å€¼èµ‹ç»™`hint`å…ƒç´ ã€‚

æœ€åï¼Œæˆ‘ä»¬åˆ†åˆ«ç»™`editor`å’Œ`preview`å…ƒç´ æ·»åŠ `scroll`äº‹ä»¶ï¼š

```js
editor.addEventListener('scroll', function(evt) {
  update(editor, preview, hintbar);
});

preview.addEventListener('scroll', function(evt) {  
  update(preview, editor, hintbar);
});
```

è¿™æ ·å°±å¯ä»¥å®ç°æ»šåŠ¨åŒæ­¥äº†ã€‚ä½†æ˜¯ï¼Œä¸Šé¢çš„ä»£ç å…¶å®å­˜åœ¨é”™è¯¯ã€‚è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ç°åœ¨çš„æ•ˆæœï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dcd152d5e6124259bb093f6a97249201~tplv-k3u1fbpfcp-zoom-1.image)

ä½ ä¼šçœ‹åˆ°ï¼Œä¸€å¼€å§‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ»šåŠ¨å·¦ä¾§ï¼Œå³ä¾§è·Ÿç€æ»šåŠ¨æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯å½“æˆ‘ä»¬åœæ­¢æ»šåŠ¨çš„æ—¶å€™ï¼Œé¡µé¢ç«Ÿç„¶è‡ªå·±ä¼šæ…¢æ…¢åœ°å¾€ä¸Šæ»šåŠ¨å›å»ã€‚

ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™æ ·çš„é”™è¯¯å‘¢ï¼Ÿå…¶å®é—®é¢˜å‡ºç°åœ¨`update`æ–¹æ³•ä¸Šï¼š

```js
function update(src, dest, hint) {
  var scrollRange = src.scrollHeight - src.clientHeight,
      p = src.scrollTop / scrollRange;  
  
  dest.scrollTop = p * (dest.scrollHeight - dest.clientHeight);
  hint.innerHTML = Math.round(100 * p) + '%';
}
```

è¿™ä¸ªæ–¹æ³•æ›´æ–°äº†`dest`çš„`scrollTop`ã€‚è°ƒç”¨`update(editor, preview, hintbar)`ï¼Œå°±æ˜¯ç”¨`editor`çš„æ»šåŠ¨ä¿¡æ¯å»æ›´æ–°`preview`çš„`scrollTop`ã€‚ä½†æ˜¯ï¼Œåœ¨æµè§ˆå™¨ä¸­ï¼Œå¦‚æœå…ƒç´ çš„`scrollTop`æ”¹å˜ï¼Œå°±ä¼šè‡ªåŠ¨è§¦å‘`scroll`äº‹ä»¶ã€‚å› æ­¤ï¼Œå½“æˆ‘ä»¬ç›‘å¬`editor`çš„`scroll`äº‹ä»¶ï¼š

```js
editor.addEventListener('scroll', function(evt) {
  update(editor, preview, hintbar);
});
```

åœ¨è¿™ä¸ª`scroll`äº‹ä»¶é‡Œæˆ‘ä»¬è°ƒç”¨`update(editor, preview, hintbar)`ï¼Œæ”¹å˜äº†`perview`çš„`scrollTop`ï¼Œè¿™æ—¶å°±ä¼šè§¦å‘`preview`çš„`scroll`äº‹ä»¶ï¼Œä½†æˆ‘ä»¬åˆåŒæ—¶ç›‘å¬äº†`preview`çš„`scroll`äº‹ä»¶ï¼š

```js
preview.addEventListener('scroll', function(evt) {
  update(preview, editor, hintbar);
});
```

æ‰€ä»¥æˆ‘ä»¬åˆæ‰§è¡Œäº†ä¸€æ¬¡`update(preview, editor, hintbar)`ï¼Œè€Œåœ¨è¿™é‡Œé¢ï¼Œæˆ‘ä»¬åˆåè¿‡æ¥æ›´æ–°äº†`editor`çš„`scrollTop`ï¼Œäºæ˜¯åˆè§¦å‘äº†`editor`çš„`scroll`äº‹ä»¶ï¼Œè¿™æ ·æ¥å›åå¤è§¦å‘ï¼Œæ ¹æœ¬åœä¸ä¸‹æ¥â€¦â€¦

æ‰€ä»¥ï¼Œè¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯ï¼Œå½“`preview`çš„`scroll`äº‹ä»¶è¢«è§¦å‘æ—¶ï¼Œä¸åº”è¯¥é©¬ä¸Šè§¦å‘`editor`çš„`scroll`äº‹ä»¶ã€‚è¿™ä¸ªé—®é¢˜æˆ‘ä»¬å¯ä»¥ä¸­ç”¨å‰é¢å­¦è¿‡çš„`debounce`å‡½æ•°æ¥è§£å†³ï¼š

```js
function debounce(fn, ms = 100) {
  let debounceTimer = null;
  return function(...args) {
    if(debounceTimer) clearTimeout(debounceTimer);

    debounceTimer = setTimeout(() => {
      fn.apply(this, args);
    }, ms);
  }
}

let scrollingTarget = null;
editor.addEventListener('scroll', function(evt){
  if(!scrollingTarget) scrollingTarget = editor;
  if(scrollingTarget === editor) update(editor, preview, hintbar);
});

editor.addEventListener('scroll', debounce(function(evt){
  scrollingTarget = null;
}));

preview.addEventListener('scroll', function(evt){  
  if(!scrollingTarget) scrollingTarget = preview;
  if(scrollingTarget === preview) update(preview, editor, hintbar);
});
```

æˆ‘ä»¬å®šä¹‰ä¸€ä¸ª`scrollingTarge`tå¯¹è±¡ï¼Œå½“å®ƒä¸º`null`æ—¶ï¼Œ`editor`æˆ–`preview`å“ªä¸€è¾¹çš„scrollå…ˆè§¦å‘ï¼Œæˆ‘ä»¬å°±æŠŠ`scrollingTarget`è®¾ä¸ºå¯¹åº”çš„å¯¹è±¡ã€‚æˆ‘ä»¬è®¾å®šå½“scrolläº‹ä»¶è§¦å‘æ—¶ï¼Œ`scrollingTarget`ä¸å¯¹åº”çš„å¯¹è±¡ç›¸åŒæ—¶æ‰ä¼šæ‰§è¡Œ`update`ã€‚è¿™æ ·ï¼Œå¦‚æœæˆ‘ä»¬å…ˆæ»šåŠ¨`editor`ï¼Œé‚£ä¹ˆ`scrollingTarget`çš„å€¼è¢«è®¾ä¸º`editor`,è¿™æ ·å°±åªæœ‰`editor`çš„æ»šåŠ¨äº‹ä»¶ä¸­ï¼Œ`update`æ‰ä¼šè¢«è§¦å‘ã€‚

ç›´åˆ°`editor`æ»šåŠ¨ç»“æŸï¼Œæˆ‘ä»¬å†å°†`scrollingTarget`é‡æ–°è®¾ä¸ºnullï¼š

```js
editor.addEventListener('scroll', debounce(function(evt){
  scrollingTarget = null;
}));

/* æˆ–è€…
preview.addEventListener('scroll', debounce(function(evt){
  scrollingTarget = null;
}));
*/
```

æ³¨æ„ï¼Œå› ä¸ºä¸è®ºå“ªä¸€è¾¹è°ƒç”¨`update`ï¼Œéƒ½ä¼šè§¦å‘å¦ä¸€è¾¹çš„scrolläº‹ä»¶ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬åªè¦`editor`æˆ–`preivew`ä»»æ„ä¸€è¾¹æ³¨å†Œäº†è¿™ä¸ª`debounce`å˜æ¢åçš„å‡½æ•°å³å¯ï¼Œä¸éœ€è¦ä¸¤è¾¹éƒ½æ³¨å†Œã€‚è¿™æ ·æˆ‘ä»¬å°±æ­£å¸¸å®ç°äº†æ»šåŠ¨æ–‡å­—çš„åŠŸèƒ½äº†ã€‚[åœ¨çº¿æ¼”ç¤º](https://junyux.github.io/FE-Advance/day07/index4-v1.html)

ä½†æ˜¯ï¼Œä¸Šè¿°çš„å®ç°æ–¹å¼æœ‰æ˜æ˜¾çš„ç¼ºç‚¹ï¼šå°†ä¸‰ä¸ªUIå…ƒç´ çš„çŠ¶æ€åŒæ­¥è€¦åˆåœ¨ä¸€ä¸ª`update`å‡½æ•°é‡Œå¤„ç†ï¼Œå¯¼è‡´è¿™ä¸ªæ–¹æ³•ä¸é€šç”¨ã€‚å‡è®¾æˆ‘ä»¬è¦å¢åŠ ä¸€ä¸ªåŒæ­¥çŠ¶æ€çš„å¯¹è±¡æˆ–è€…å‡å°‘ä¸€ä¸ªåŒæ­¥çŠ¶æ€çš„å¯¹è±¡ï¼Œæˆ‘ä»¬éƒ½éœ€è¦ä¿®æ”¹`update`çš„ä»£ç ï¼Œè€Œä¸”å°†æ¥è¦ç»„åˆä¸åŒçš„æ“ä½œæ”¹å˜çŠ¶æ€ä¹Ÿä¼šéå¸¸éº»çƒ¦ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œé™ä½è¿™ç§åŒæ­¥çŠ¶æ€çš„è€¦åˆåº¦ï¼Œä½¿å¾—çŠ¶æ€åŒæ­¥çš„åŠŸèƒ½æ˜“äºç»´æŠ¤ã€‚

<!-- æ‰€ä»¥ï¼Œä¸€ä¸ªæ›´åˆç†çš„åšæ³•æ˜¯å°†å®ƒä»¬çš„çŠ¶æ€ä¿®æ”¹åˆ†å¼€æ¥ï¼Œè¿™å°±éœ€è¦å¼•å…¥ä¸€ä¸ªè®¾è®¡æ¨¡å¼ï¼š -->

**ä¸­é—´äººï¼ˆMediatorï¼‰**

ä¸€ä¸ªæœ€ç®€å•çš„`Mediator`æ¨¡å¼çš„ç±»å®šä¹‰å¦‚ä¸‹ï¼š

```js
class PubSub {
  constructor() {
    this.subscribers = {};
  }

  /*
    @type æ¶ˆæ¯ç±»å‹ï¼Œå¦‚scroll
    @receiver è®¢é˜…è€…
    @fn å“åº”æ¶ˆæ¯çš„å¤„ç†å‡½æ•°
  */
  sub(type, receiver, fn) {
    this.subscribers[type] = this.subscribers[type] || [];
    this.subscribers[type].push(fn.bind(receiver));
  }

  /*
    @type æ¶ˆæ¯ç±»å‹
    @sender æ´¾å‘æ¶ˆæ¯è€…
    @data æ•°æ®ï¼Œæ¯”å¦‚çŠ¶æ€æ•°æ®
  */
  pub(type, sender, data) {
    const subscribers = this.subscribers[type];
    subscribers.forEach((subscriber) => {
      subscriber({type, sender, data});
    });
  }
}
```

`PubSub`ç±»å®šä¹‰äº†ä¸€ä¸ªä¸­é—´äººçš„è¡Œä¸ºã€‚`sub`æ–¹æ³•æ”¶é›†è®¢é˜…è€…çš„å…³äº`type`ç±»å‹çš„å“åº”è¡Œä¸ºã€‚`pub`æ–¹æ³•å°†`type`ç±»å‹çš„æ¶ˆæ¯æ´¾å‘ç»™æ‰€æœ‰æ³¨å†Œäº†è¯¥ç±»å‹æ¶ˆæ¯çš„è®¢é˜…è€…ã€‚

ç„¶åï¼Œæˆ‘ä»¬è®©`preview`ã€`editor`ã€`hintbar`å…ƒç´ åˆ†åˆ«ç›‘å¬`scroll`ç±»å‹çš„æ¶ˆæ¯ã€‚

```js
function scrollTo({data:p}){
  this.scrollTop = p * (this.scrollHeight - this.clientHeight);
}

var mediator = new PubSub();
mediator.sub('scroll', preview, scrollTo);
mediator.sub('scroll', editor, scrollTo);
mediator.sub('scroll', hintbar, function({data:p}){
  this.innerHTML = Math.round(p * 100) + '%';
});
```

æ¥ç€ï¼Œæˆ‘ä»¬åœ¨`editor`å’Œ`preview`å…ƒç´ æ»šåŠ¨çš„æ—¶å€™ï¼Œè®©ä¸­é—´äººæ´¾å‘æ¶ˆæ¯ï¼š

```js
function debounce(fn, ms = 100) {
  let debounceTimer = null;
  return function(...args) {
    if(debounceTimer) clearTimeout(debounceTimer);

    debounceTimer = setTimeout(() => {
      fn.apply(this, args);
    }, ms);
  }
}

let scrollingTarget = null;
editor.addEventListener('scroll', debounce(function(evt){
  scrollingTarget = null;
}));

function updateScroll(evt) {
  var target = evt.target;
  if(!scrollingTarget) scrollingTarget = target;
  if(scrollingTarget === target) {
    var scrollRange = target.scrollHeight - target.clientHeight,
      p = target.scrollTop / scrollRange;

    // ä¸­é—´äººæ´¾å‘scrollæ¶ˆæ¯
    mediator.pub('scroll', target, p);
  }
}
editor.addEventListener('scroll', updateScroll);
preview.addEventListener('scroll', updateScroll);
```

æ³¨æ„è¿™é‡Œä¸€æ ·è¦ä½¿ç”¨debounceã€‚

è¿™æ ·æˆ‘ä»¬å°±å®ç°äº†åŒæ ·çš„åŒæ­¥æ»šåŠ¨ï¼Œå®Œæ•´çš„JavaScriptä»£ç å¦‚ä¸‹ï¼š

[åœ¨çº¿æ¼”ç¤º](https://junyux.github.io/FE-Advance/day07/index4-v2.html)

```js
function Editor(input, preview) {
  this.update = function () {
    preview.innerHTML = markdown.toHTML(input.value);
  };
  input.editor = this;
  this.update();
}
new Editor(editor, preview);

class PubSub {
  constructor() {
    this.subscribers = {};
  }
  pub(type, sender, data){
    var subscribers = this.subscribers[type];
    subscribers.forEach(function(subscriber){
      subscriber({type, sender, data});
    });
  }
  sub(type, receiver, fn){
    this.subscribers[type] = this.subscribers[type] || [];
    this.subscribers[type].push(fn.bind(receiver));
  }
}

function scrollTo({data:p}){
  this.scrollTop = p * (this.scrollHeight - this.clientHeight);
}

var mediator = new PubSub();
mediator.sub('scroll', preview, scrollTo);
mediator.sub('scroll', editor, scrollTo);
mediator.sub('scroll', hintbar, function({data:p}){
  this.innerHTML = Math.round(p * 100) + '%';
});

function debounce(fn, ms = 100) {
  let debounceTimer = null;
  return function(...args) {
    if(debounceTimer) clearTimeout(debounceTimer);

    debounceTimer = setTimeout(() => {
      fn.apply(this, args);
    }, ms);
  }
}

let scrollingTarget = null;
editor.addEventListener('scroll', debounce(function(evt){
  scrollingTarget = null;
}));

function updateScroll(evt) {
  var target = evt.target;
  if(!scrollingTarget) scrollingTarget = target;
  if(scrollingTarget === target) {
    var scrollRange = target.scrollHeight - target.clientHeight,
      p = target.scrollTop / scrollRange;
    mediator.pub('scroll', target, p);
  }
}
editor.addEventListener('scroll', updateScroll);
preview.addEventListener('scroll', updateScroll);
```

è¿™ä¸€ç‰ˆä»£ç ä¸å‰é¢çš„ä»£ç ç›¸æ¯”çœ‹ä¸Šå»æ›´é•¿äº†ï¼Œä½†æ˜¯å®ƒä¸å†å°†æ‰€æœ‰çš„çŠ¶æ€åŒæ­¥è€¦åˆåœ¨ä¸€ä¸ª`update`å‡½æ•°é‡Œï¼Œè€Œæ˜¯åˆ†æˆäº†å‘å¸ƒå’Œè®¢é˜…ä¸¤ä¸ªéƒ¨åˆ†ï¼Œè€Œä¸”`preview`ã€`editor`ã€`hintbar`æ˜¯åˆ†åˆ«è®¢é˜…scrollæ¶ˆæ¯çš„ï¼Œè¿™æ ·å°±ä¿è¯äº†UIçŠ¶æ€çš„ç‹¬ç«‹æ€§ã€‚å‡è®¾å°†æ¥æˆ‘ä»¬è¦å–æ¶ˆ`hintbar`çš„çŠ¶æ€åŒæ­¥ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ³¨é‡Šæ‰è®¢é˜…æ¶ˆæ¯çš„ä»£ç ï¼š

```js
// mediator.sub('scroll', hintbar, function({data:p}){
//   this.innerHTML = Math.round(p * 100) + '%';
// });
```

è¿™æ ·å°±ä¸éœ€è¦ä¿®æ”¹ä»»ä½•å‡½æ•°çš„å†…éƒ¨å®ç°ï¼Œä»è€Œæé«˜äº†ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§ã€‚

å½“æˆ‘ä»¬éœ€è¦åŒæ­¥å¤šä¸ªUIçŠ¶æ€æ—¶ï¼Œå¯ä»¥è€ƒè™‘é‡‡ç”¨ä¸­é—´äººæ¨¡å¼ï¼Œç”¨ä¸­é—´äººç»Ÿä¸€ç®¡ç†UIç»„ä»¶çš„æ¶ˆæ¯ï¼Œåœ¨è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œä¸­é—´äººæ˜¯ä¸€ä¸ªéå¸¸æœ‰æ•ˆçš„è®¾è®¡æ¨¡å¼ã€‚

ä»Šå¤©çš„æ•…äº‹ä¸»è¦è®²è§£äº†å‰ç«¯å¼€å‘ä¸­ä¸¤ä¸ªéå¸¸å¸¸ç”¨çš„è®¾è®¡æ¨¡å¼â€”â€”è¡Œä¸ºæ¨¡å¼å’Œä¸­é—´äººæ¨¡å¼ã€‚è™½ç„¶å‰ç«¯å¼€å‘è¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„è®¾è®¡æ¨¡å¼ï¼Œä½†æ˜¯è¿™ä¸ªè¶…å‡ºäº†è¿™é—¨è¯¾çš„èŒƒç•´ã€‚æˆ‘ä»¬ä¼šåœ¨å°†æ¥çš„è®¾è®¡æ¨¡å¼çš„ä¸“é—¨è¯¾ç¨‹ä¸­è¯¦ç»†è®²è§£ï¼Œæ•¬è¯·æœŸå¾…ã€‚