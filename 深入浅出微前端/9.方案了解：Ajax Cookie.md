ä¸Šä¸€èŠ‚è¯¾æˆ‘ä»¬è®²è§£äº† iframe ä¸­çš„ Cookie æºå¸¦æƒ…å†µï¼Œæœ¬è¯¾ç¨‹ä»¥ Web Componets ä¸ºä¾‹è®²è§£ Ajax è¯·æ±‚ä¸­çš„ Cookie å¤„ç†ã€‚åœ¨ Web Componets æ–¹æ¡ˆä¸­ï¼Œè™½ç„¶ä¸»å­åº”ç”¨å¤„äºåŒä¸€ä¸ª Host åœ°å€ï¼Œä½†æ˜¯å­åº”ç”¨çš„æœåŠ¡ç«¯æ­¤æ—¶å¯èƒ½æœ‰è‡ªå·±çš„æœåŠ¡ç«¯ï¼Œå› æ­¤å¯ä»¥é‡ç‚¹æŸ¥çœ‹ä¸€ä¸‹ Ajax è¯·æ±‚åœ¨è·¨åŸŸæ—¶çš„ Cookie æºå¸¦æƒ…å†µï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7753793a37db47698db730ee2e6f037a~tplv-k3u1fbpfcp-zoom-1.image)

> æ¸©é¦¨æç¤ºï¼šä¸Šè¿°æƒ…å†µæ˜¯å¦æœ‰æ–¹æ³•å¯ä»¥ä½¿å¾®åº”ç”¨ A å’Œ B ä¸äº§ç”Ÿè·¨åŸŸè¯·æ±‚ï¼Ÿ

å›é¡¾ä¸€ä¸‹ Web Componets çš„å¾®å‰ç«¯ç¤ºä¾‹ï¼Œç›®å½•ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š

``` bash
â”œâ”€â”€ public                  # æ‰˜ç®¡çš„é™æ€èµ„æºç›®å½•
â”‚   â”œâ”€â”€ main/               # ä¸»åº”ç”¨èµ„æºç›®å½•                        
â”‚   â”‚   â””â”€â”€ index.html                                        
â”‚   â””â”€â”€ micro/              # å¾®åº”ç”¨èµ„æºç›®å½•
â”‚        â”œâ”€â”€ micro1.css   
â”‚        â”œâ”€â”€ micro1.js    
â”‚        â”œâ”€â”€ micro2.css         
â”‚        â””â”€â”€ micro2.js      
â”œâ”€â”€ config.js               # å…¬å…±é…ç½®
â”œâ”€â”€ main-server.js          # ä¸»åº”ç”¨æœåŠ¡
â””â”€â”€ micro-server.js         # å¾®åº”ç”¨æœåŠ¡
```

> æ¸©é¦¨æç¤ºï¼šç¤ºä¾‹æºç å¯ä»¥ä» micro-framework çš„ [demo/web-components-cookie](https://github.com/ziyi2/micro-framework/tree/demo/web-components-cookie) åˆ†æ”¯è·å–ã€‚

ä¸ºäº†æ¨¡æ‹Ÿè·¨åŸŸçš„ Ajax è¯·æ±‚æƒ…å†µï¼Œå¯ä»¥ä½¿ç”¨ iHosts è¿›è¡ŒåŸŸåæ˜ å°„ï¼Œæˆ‘ä»¬å¸Œæœ›å®ç°å¦‚ä¸‹åŠŸèƒ½ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f99719953d2e4569bd3a4725e05356d0~tplv-k3u1fbpfcp-zoom-1.image)

-   åœ¨ä¸»åº”ç”¨ä¸­ä½¿ç”¨ iHosts è¿›è¡ŒåŸŸåæ˜ å°„ï¼Œå°† `ziyi.com` æ˜ å°„åˆ°æœ¬åœ° IP åœ°å€
-   å­åº”ç”¨ä»ç„¶ä¿ç•™åŸæ¥çš„ IP åœ°å€è®¿é—®ï¼Œä»è€Œå’Œä¸»åº”ç”¨å½¢æˆè·¨åŸŸå’Œè·¨ç«™

iHosts çš„é…ç½®ä¿æŒä¸å˜ï¼Œ`ziyi.com` å¯ä»¥æ˜ å°„åˆ°æœ¬åœ°çš„ IP åœ°å€ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/80795f7d6f134cdb88225ed7786b222f~tplv-k3u1fbpfcp-zoom-1.image)

åœ¨ä¹‹å‰æ–¹æ¡ˆçš„åŸºç¡€ä¸Šï¼Œä½¿å¾®åº”ç”¨æ–°å¢è·¨ç«™çš„ Ajax è¯·æ±‚ï¼š

``` javascript
// micro1.js
// micro2.js åŒç†
class MicroApp1Element extends HTMLElement {
  constructor() {
    super();
  }
  
  connectedCallback() {
    console.log(`[micro-app-1]ï¼šæ‰§è¡Œ connectedCallback ç”Ÿå‘½å‘¨æœŸå›è°ƒå‡½æ•°`);
    this.mount();
  }

  disconnectedCallback() {
    console.log(`[micro-app-1]ï¼šæ‰§è¡Œ disconnectedCallback ç”Ÿå‘½å‘¨æœŸå›è°ƒå‡½æ•°`);
    this.unmount();
  }

  mount() {
    const $micro = document.createElement("h1");
    $micro.textContent = "å¾®åº”ç”¨1";
    this.appendChild($micro);

    // æ–°å¢ Ajax è¯·æ±‚ï¼Œç”¨äºè¯·æ±‚å­åº”ç”¨æœåŠ¡
    // éœ€è¦æ³¨æ„ micro1.js åŠ¨æ€åŠ è½½åœ¨ä¸»åº”ç”¨ ziyi.com:4000 ä¸‹ï¼Œå› æ­¤æ˜¯è·¨ç«™è¯·æ±‚
    
    // å¦‚æœå…ˆå‘èµ· micro1.js çš„ Ajax è¯·æ±‚ï¼Œå¸Œæœ›å¯ä»¥å“åº”å­åº”ç”¨æœåŠ¡ç«¯çš„ Cookie
    // å†æ¬¡å‘èµ· micro2.js çš„åŒåœ°å€çš„ Ajax è¯·æ±‚ï¼Œæ­¤æ—¶å¸Œæœ›è¯·æ±‚å¤´ä¸­å¯ä»¥æºå¸¦ Cookie
    // è¿™ç§æƒ…å†µå¯ç”¨äºç™»å½•æ€çš„å…ç™» Cookie è®¾è®¡
    window
      .fetch("http://30.120.112.54:3000/cors", {
        method: "post",
        // å…è®¸åœ¨è¯·æ±‚æ—¶æºå¸¦ Cookie
        // https://developer.mozilla.org/zh-CN/docs/Web/API/Request/credentials
        credentials: "include"
      })
      .then((res) => res.json())
      .then(() => {})
      .catch((err) => {
        console.error(err);
      });
  }

  unmount() {}
}

window.customElements.define("micro-app-1", MicroApp1Element);
```

ä¸ºäº†ä½¿å¾—å¾®åº”ç”¨å¯ä»¥æ”¯æŒè·¨ç«™è¯·æ±‚ï¼Œéœ€è¦åœ¨æœåŠ¡ç«¯è¿›è¡Œé¢å¤–çš„è·¨åŸŸé…ç½®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

``` javascript
// main-server.js
import express from "express";
import path from "path";
import morgan from "morgan";
import config from "./config.js";
import cookieParser from "cookie-parser";
const app = express();
const { port, host } = config;

// æ‰“å°è¯·æ±‚æ—¥å¿—
app.use(morgan("dev"));

// cookie ä¸­é—´ä»¶
app.use(cookieParser());

app.use(express.static(path.join("public", "main")));

app.post("/microapps", function (req, res) {

  console.log("main cookies: ", req.cookies);

  // è®¾ç½®ä¸€ä¸ªå“åº”çš„ Cookie æ•°æ®
  res.cookie("main-app", true);

  res.json([
    {
      name: "micro1",
      id: "micro1",
      customElement: "micro-app-1",
      script: `http://${host}:${port.micro}/micro1.js`,
      style: `http://${host}:${port.micro}/micro1.css`,
      prefetch: true,
    },
    {
      name: "micro2",
      id: "micro2",
      customElement: "micro-app-2",
      script: `http://${host}:${port.micro}/micro2.js`,
      style: `http://${host}:${port.micro}/micro2.css`,
      prefetch: true,
    },
  ]);
});

app.listen(port.main, host);
console.log(`server start at http://${host}:${port.main}/`);


// micro-server.js
import express from "express";
import morgan from "morgan";
import path from "path";
import cookieParser from "cookie-parser";
import config from "./config.js";
const app = express();
const { port, host } = config;

app.use(morgan("dev"));

// cookie ä¸­é—´ä»¶
app.use(cookieParser());

// è®¾ç½®æ”¯æŒè·¨åŸŸè¯·æ±‚å¤´
// ç¤ºä¾‹è®¾ç½®äº†æ‰€æœ‰è¯·æ±‚çš„è·¨åŸŸé…ç½®ï¼Œä¹Ÿå¯ä»¥å¯¹å•ä¸ªè¯·æ±‚è¿›è¡Œè·¨åŸŸè®¾ç½®
app.use((req, res, next) => {
  // è·¨åŸŸè¯·æ±‚ä¸­æ¶‰åŠåˆ° Cookie ä¿¡æ¯ä¼ é€’æ—¶å€¼ä¸èƒ½ä¸º *ï¼Œå¿…é¡»æ˜¯å…·ä½“çš„ä¸»åº”ç”¨åœ°å€
  // è¿™é‡Œçš„ ziyi.com ä½¿ç”¨ iHosts æ˜ å°„åˆ°æœ¬åœ° IP åœ°å€
  res.header("Access-Control-Allow-Origin", `http://ziyi.com:${port.main}`);
  res.header("Access-Control-Allow-Methods", "GET, POST, OPTIONS");
  res.header("Allow", "GET, POST, OPTIONS");
  // å…è®¸è·¨åŸŸè¯·æ±‚æ—¶æºå¸¦ Cookie
  // https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Allow-Credentials
  res.header("Access-Control-Allow-Credentials", true);
  next();
});

app.use(
  express.static(path.join("public", "micro"), {
    etag: true,
    lastModified: true,
  })
);

app.post("/cors", function (req, res) {

  // æ‰“å°å­åº”ç”¨çš„ Cookie æºå¸¦æƒ…å†µ
  console.log("micro cookies: ", req.cookies);

  // è®¾ç½®ä¸€ä¸ªå“åº”çš„ Cookie æ•°æ®
  res.cookie("micro-app", true);
  res.json({
    hello: "true",
  });
});

app.listen(port.micro, host);
console.log(`server start at http://${host}:${port.micro}/`);
```

å¯åŠ¨ä¸»åº”ç”¨å’Œå­åº”ç”¨çš„æœåŠ¡è¿›è¡Œ Ajax è¯·æ±‚ç”¨äºè§‚å¯Ÿæ˜¯å¦æºå¸¦ Cookie ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/217bdaef7a634ba091af676fb13fad1f~tplv-k3u1fbpfcp-zoom-1.image)

åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¾—åˆ°å¦‚ä¸‹ç»“æœï¼š

-   ä¸»åº”ç”¨æœåŠ¡ç«¯æˆåŠŸè®¾ç½® Cookieï¼Œå†æ¬¡åˆ·æ–°é¡µé¢æ—¶å‰ç«¯çš„è¯·æ±‚ä¼šè‡ªåŠ¨æºå¸¦ä¸Š Cookie ä¿¡æ¯ï¼ˆè§‚å¯ŸæœåŠ¡ç«¯çš„ Cookie æ‰“å°ä¿¡æ¯ï¼‰
-   å­åº”ç”¨è¿›è¡Œè·¨åŸŸè¯·æ±‚æ—¶æ— æ³•æˆåŠŸè®¾ç½® Cookie

åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›ä¸¤ä¸ªå¾®åº”ç”¨çš„ç¬¬ä¸€æ¬¡ Ajax è¯·æ±‚å¯ä»¥å“åº”æœåŠ¡ç«¯çš„ Cookie ä¿¡æ¯ï¼Œè€Œç¬¬äºŒæ¬¡çš„ Ajax è¯·æ±‚å¯ä»¥æºå¸¦ç¬¬ä¸€æ¬¡ Ajax è¯·æ±‚å“åº”çš„ Cookie ä¿¡æ¯ï¼Œä½†æ˜¯é€šè¿‡æµ‹è¯•å‘ç°ç¬¬äºŒæ¬¡ Ajax è¯·æ±‚å¹¶æ²¡æœ‰æºå¸¦ Cookie ä¿¡æ¯ï¼Œè®¾ç½® Cookie çš„è­¦å‘Šä¿¡æ¯åŸºæœ¬ä¸Šå’Œ iframe ä¸­çš„è·¨ç«™ç›¸åŒï¼šThis Set-Cookie didn't specify a "SameSite" attribute and was default to "SameSite=Lax"ï¼Œ and was blocked because it came from a cross-site response which was not the response to a top-level navigation. The Set-Cookie had to have been set with "SameSite=None" to enable cross-site usage. This Set-Cookie was blocked because it had the "Secure" attribute but was not received over a secure connection. This Set-Cookie was blocked because it was not sent over a secure-connection and would have overwritten a cookie with Secure attribute.

  


è¿™é‡Œå’Œ iframe æ–¹æ¡ˆä¸­çš„è·¨ç«™æƒ…å†µç±»ä¼¼ï¼Œéœ€è¦è®¾ç½® Cookie çš„ SameSite å’Œ Secure å±æ€§å¹¶ä¿®æ”¹æˆ HTTPS åè®®ã€‚ä¸ºäº†æ”¯æŒ HTTPS åè®®ï¼Œé™¤äº†ä½¿ç”¨ iframe ç¤ºä¾‹ä¸­çš„ Ngrokï¼Œæœ€åŸºæœ¬çš„æ–¹å¼æ˜¯æä¾› Nginx åå‘ä»£ç†ï¼Œåœ¨è¿™é‡Œå¯ä»¥è®¾ç½®ä¸€ä¸ªåå‘ä»£ç†çš„æ–¹æ¡ˆï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/85938ffc80ce4105abbc6767730b33df~tplv-k3u1fbpfcp-zoom-1.image)

-   åœ¨ä¸»åº”ç”¨ä¸­ä½¿ç”¨ iHosts è¿›è¡ŒåŸŸåæ˜ å°„ï¼Œå°† `ziyi.com` æ˜ å°„åˆ°æœ¬åœ° IP åœ°å€ï¼Œæ˜ å°„å®Œæˆåè¿›è¡Œ Nginx åå‘ä»£ç†ï¼Œä½¿å…¶æ”¯æŒ HTTPS åè®®
-   å­åº”ç”¨å’Œä¸»åº”ç”¨è·¨ç«™ï¼Œä¸ºäº†æ”¯æŒ HTTPS åè®®ï¼Œä¹Ÿéœ€è¦è¿›è¡Œ Nginx åå‘ä»£ç†

ä¸ºäº†ä½¿ç”¨ Nginx è¿›è¡Œåå‘ä»£ç†ï¼Œé¦–å…ˆéœ€è¦ä½¿ç”¨ Homebrew è¿›è¡Œå®‰è£…ï¼š

``` bash
# æ‰§è¡Œ
brew install nginx

# å®‰è£…ä¿¡æ¯çœç•¥
# ...
# æ‰“å°
Docroot is: /opt/homebrew/var/www

# æ‰“å°ä¿¡æ¯å‘ŠçŸ¥ nginx çš„é…ç½®æ–‡ä»¶åœ°å€ï¼Œæ³¨æ„ä¿®æ”¹è¯¥é…ç½®åéœ€è¦é‡å¯ nginx æœåŠ¡
The default port has been set in /opt/homebrew/etc/nginx/nginx.conf to 8080 so that
nginx can run without sudo.

nginx will load all files in /opt/homebrew/etc/nginx/servers/.

To restart nginx after an upgrade:
  # æ‰“å°ä¿¡æ¯å‘ŠçŸ¥åœ¨åå°é‡å¯ Nginx æœåŠ¡çš„æ‰§è¡Œå‘½ä»¤
  brew services restart nginx
Or, if you don't want/need a background service you can just run:
  /opt/homebrew/opt/nginx/bin/nginx -g daemon off;
==> Summary
ğŸº  /opt/homebrew/Cellar/nginx/1.23.4: 26 files, 2.2MB
==> Running `brew cleanup nginx`...
Disable this behaviour by setting HOMEBREW_NO_INSTALL_CLEANUP.
Hide these hints with HOMEBREW_NO_ENV_HINTS (see `man brew`).
==> Caveats
==> nginx
Docroot is: /opt/homebrew/var/www

The default port has been set in /opt/homebrew/etc/nginx/nginx.conf to 8080 so that
nginx can run without sudo.

nginx will load all files in /opt/homebrew/etc/nginx/servers/.

To restart nginx after an upgrade:
  brew services restart nginx
Or, if you don't want/need a background service you can just run:
  /opt/homebrew/opt/nginx/bin/nginx -g daemon off;
```

  


å®‰è£…åå¯ä»¥ç®€å•è¿›è¡Œ Nginx åå‘ä»£ç†çš„æµ‹è¯•ï¼Œè¿™é‡Œå°è¯•ä½¿ç”¨ 4001 ç«¯å£ä»£ç†ä¸»åº”ç”¨çš„ 4000 ç«¯å£ï¼Œéœ€è¦ä¿®æ”¹ Nginx çš„é…ç½®å¹¶é‡æ–°å¯åŠ¨ Nginx æœåŠ¡ã€‚ä»æ‰“å°ä¿¡æ¯çŸ¥é“é…ç½®æ–‡ä»¶åœ¨ `/opt/homebrew/etc/nginx/nginx.conf` ä¸­ï¼Œæ‰“å¼€é…ç½®æ–‡ä»¶è¿›è¡Œç®€å•çš„ä»£ç†é…ç½®ï¼š

``` bash
#user  nobody;
worker_processes  1;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';

    #access_log  logs/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    #gzip  on;

    server {
        # è®¾ç½®ä¸»åº”ç”¨çš„ä»£ç†ç«¯å£ä¸º 4001
        listen       4001;
        server_name  localhost;

        #charset koi8-r;

        #access_log  logs/host.access.log  main;

        location / {
            # root   html;
            # index  index.html index.htm;
            # ä»£ç†åˆ°ä¸»åº”ç”¨çš„ Node åœ°å€
            proxy_pass 'http://30.120.112.54:4000'
        }

        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

        # proxy the PHP scripts to Apache listening on 127.0.0.1:80
        #
        #location ~ .php$ {
        #    proxy_pass   http://127.0.0.1;
        #}

        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
        #
        #location ~ .php$ {
        #    root           html;
        #    fastcgi_pass   127.0.0.1:9000;
        #    fastcgi_index  index.php;
        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
        #    include        fastcgi_params;
        #}

        # deny access to .htaccess files, if Apache's document root
        # concurs with nginx's one
        #
        #location ~ /.ht {
        #    deny  all;
        #}
    }

    # another virtual host using mix of IP-, name-, and port-based configuration
    #
    #server {
    #    listen       8000;
    #    listen       somename:8080;
    #    server_name  somename  alias  another.alias;

    #    location / {
    #        root   html;
    #        index  index.html index.htm;
    #    }
    #}

    # HTTPS server
    #
    #server {
    #    listen       443 ssl;
    #    server_name  localhost;

    #    ssl_certificate      cert.pem;
    #    ssl_certificate_key  cert.key;

    #    ssl_session_cache    shared:SSL:1m;
    #    ssl_session_timeout  5m;

    #    ssl_ciphers  HIGH:!aNULL:!MD5;
    #    ssl_prefer_server_ciphers  on;

    #    location / {
    #        root   html;
    #        index  index.html index.htm;
    #    }
    #}
    include servers/*;
}
```

  


éœ€è¦æ³¨æ„åœ¨é‡æ–°å¯åŠ¨ Nginx æœåŠ¡ä¹‹å‰ï¼Œå¯ä»¥å…ˆè¿›è¡Œé…ç½®æ£€æŸ¥ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

``` bash
# æ‰§è¡Œæ£€æŸ¥
sudo nginx -t
# æ‰“å°ä¿¡æ¯
nginx: [emerg] unexpected "}" in /opt/homebrew/etc/nginx/nginx.conf:56
nginx: configuration file /opt/homebrew/etc/nginx/nginx.conf test failed
```

ä¸€èˆ¬é‡åˆ°ä¸Šè¿°æƒ…å†µä¸»è¦æ˜¯ `}` çš„ä¸Šä¸€è¡Œå‡ºç°é—®é¢˜ ï¼Œä»”ç»†è§‚å¯Ÿå‘ç°ä¸Šä¸€è¡Œæ²¡æœ‰ä»¥ `;` ç»“å°¾ï¼š

``` bash
location / {
    # root   html;
    # index  index.html index.htm;
    # ä»£ç†åˆ°ä¸»åº”ç”¨çš„åœ°å€ï¼Œç»“å°¾å¤„å¢åŠ åˆ†å· ï¼›
    proxy_pass 'http://30.120.112.54:4000';
}
```

é‡æ–°è¿›è¡Œ Nginx é…ç½®çš„æ£€æµ‹ï¼š

``` bash
# æ‰§è¡Œ
sudo nginx -t
# æ‰“å°
nginx: the configuration file /opt/homebrew/etc/nginx/nginx.conf syntax is ok
nginx: configuration file /opt/homebrew/etc/nginx/nginx.conf test is successful
```

æ­¤æ—¶å¯ä»¥ä½¿ç”¨ brew æä¾›çš„å‘½ä»¤åœ¨åå°é‡æ–°å¯åŠ¨ Nginx æœåŠ¡ï¼š

``` bash
# ä½¿ç”¨ brew æ¨èçš„ nginx é‡å¯å‘½ä»¤
# å»ºè®®ä½¿ç”¨ Nginx è‡ªå¸¦çš„å‘½ä»¤ï¼Œå¦‚æœé‡åˆ°ä»£ç†å¤±è´¥ï¼Œå»ºè®®æ€æ‰ Nginx è¿›ç¨‹é‡æ–°å°è¯•
brew services restart nginx

# æ‰“å°
Stopping `nginx`... (might take a while)
==> Successfully stopped `nginx` (label: homebrew.mxcl.nginx)
==> Successfully started `nginx` (label: homebrew.mxcl.nginx)
```

å¯åŠ¨æˆåŠŸåå¯ä»¥é€šè¿‡ 4001 ç«¯å£è¿›è¡Œè®¿é—®ï¼Œå‘ç°ä»£ç†æˆåŠŸï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/83b209c52f844aa5a2958d87517ae7a6~tplv-k3u1fbpfcp-zoom-1.image)

æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å°† HTTP åè®®æ”¹æˆ HTTPS åè®®è¿›è¡Œè®¿é—®ï¼Œä¸ºäº†åœ¨å¼€å‘æ€æ”¯æŒ HTTPS åè®®ï¼Œå¯ä»¥ä½¿ç”¨ [mkcert](https://github.com/FiloSottile/mkcert) ç”Ÿæˆæœ¬åœ° CA è¯ä¹¦ï¼š

``` bash
# å®‰è£… mkcert
brew install mkcert

# æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œç”Ÿæˆæœ¬åœ° CA è¯ä¹¦
# è¿›å…¥é¡¹ç›®ç›®å½•
# mkcert example.com "*.example.com" example.test localhost 127.0.0.1 ::1
mkcert ziyi.com 30.120.112.54 localhost 127.0.0.1 ::1

# æ‰“å°ä¿¡æ¯
# ziyi.com ä¼šåœ¨ iHosts ä¸­è¿›è¡Œ IP æ˜ å°„
Created a new certificate valid for the following names ğŸ“œ
 - "ziyi.com"
 - "30.120.112.54"
 - "localhost"
 - "127.0.0.1"
 - "::1"

The certificate is at "./ziyi.com+4.pem" and the key at "./ziyi.com+4-key.pem" âœ…

It will expire on 19 July 2025 ğŸ—“
```

> æ¸©é¦¨æç¤ºï¼šå¯ä»¥é¢å¤–äº†è§£ä¸€ä¸‹æœ¬åœ° CA è¯ä¹¦å’Œè‡ªç­¾åè¯ä¹¦çš„åŒºåˆ«ï¼Ÿ

ç”Ÿæˆæœ¬åœ°çš„ CA è¯ä¹¦åå°† Niginx çš„é…ç½®è¿›è¡Œ HTTPS æ›´æ”¹ï¼ˆNginx é…ç½®æ–‡ä»¶æä¾›äº†ç¤ºä¾‹ï¼Œæ‰“å¼€æ³¨é‡Šè¿›è¡Œé…ç½®å³å¯ï¼‰ï¼š

``` bash
#user  nobody;
worker_processes  1;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';

    #access_log  logs/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    #gzip  on;

    # server {
    #     # è®¾ç½®ä¸»åº”ç”¨çš„ä»£ç†ç«¯å£ä¸º 4001
    #     listen       4001;
    #     server_name  localhost;

    #     #charset koi8-r;

    #     #access_log  logs/host.access.log  main;

    #     location / {
    #         # root   html;
    #         # index  index.html index.htm;
    #         # ä»£ç†åˆ°ä¸»åº”ç”¨çš„åœ°å€
    #         proxy_pass 'http://30.120.112.54:4000';
    #     }

    #     #error_page  404              /404.html;

    #     # redirect server error pages to the static page /50x.html
    #     #
    #     error_page   500 502 503 504  /50x.html;
    #     location = /50x.html {
    #         root   html;
    #     }

    #     # proxy the PHP scripts to Apache listening on 127.0.0.1:80
    #     #
    #     #location ~ .php$ {
    #     #    proxy_pass   http://127.0.0.1;
    #     #}

    #     # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
    #     #
    #     #location ~ .php$ {
    #     #    root           html;
    #     #    fastcgi_pass   127.0.0.1:9000;
    #     #    fastcgi_index  index.php;
    #     #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
    #     #    include        fastcgi_params;
    #     #}

    #     # deny access to .htaccess files, if Apache's document root
    #     # concurs with nginx's one
    #     #
    #     #location ~ /.ht {
    #     #    deny  all;
    #     #}
    # }

    # another virtual host using mix of IP-, name-, and port-based configuration
    #
    #server {
    #    listen       8000;
    #    listen       somename:8080;
    #    server_name  somename  alias  another.alias;

    #    location / {
    #        root   html;
    #        index  index.html index.htm;
    #    }
    #}

    # HTTPS server
    # ä½¿ç”¨ HTTPS åè®®ï¼Œä»£ç†åˆ°ä¸»åº”ç”¨
    server {
       listen       4001 ssl;
       server_name  localhost;

       ssl_certificate      /Users/zhuxiankang/Desktop/Github/micro-framework/ziyi.com+4.pem;
       ssl_certificate_key  /Users/zhuxiankang/Desktop/Github/micro-framework/ziyi.com+4-key.pem;
       
       ssl_session_cache    shared:SSL:1m;
       ssl_session_timeout  5m;

       ssl_ciphers  HIGH:!aNULL:!MD5;
       ssl_prefer_server_ciphers  on;

       location / {
        #    root   html;
        #    index  index.html index.htm;
        proxy_pass 'http://30.120.112.54:4000';
       }
    }

    # HTTPS server
    # ä½¿ç”¨ HTTPS åè®®ï¼Œä»£ç†åˆ°å¾®åº”ç”¨
    server {
       listen       3001 ssl;
       server_name  localhost;
       
       ssl_certificate      /Users/zhuxiankang/Desktop/Github/micro-framework/ziyi.com+4.pem;
       ssl_certificate_key  /Users/zhuxiankang/Desktop/Github/micro-framework/ziyi.com+4-key.pem;

       ssl_session_cache    shared:SSL:1m;
       ssl_session_timeout  5m;

       ssl_ciphers  HIGH:!aNULL:!MD5;
       ssl_prefer_server_ciphers  on;

       location / {
        #    root   html;
        #    index  index.html index.htm;
        proxy_pass 'http://30.120.112.54:3000';
       }
    }
    include servers/*;
}
```

æ›´æ”¹æœåŠ¡ç«¯ä»£ç å’Œå‰ç«¯ä»£ç ï¼ˆå‰ç«¯ä»£ç ä¸å†å±•ç¤ºï¼Œåªéœ€è¦æ›´æ”¹è¯·æ±‚çš„åœ°å€å³å¯ï¼‰ï¼š

``` javascript
// main-server.js
import express from "express";
import path from "path";
import morgan from "morgan";
import config from "./config.js";
import cookieParser from "cookie-parser";
const app = express();
const { port, host } = config;

app.use(morgan("dev"));

// cookie ä¸­é—´ä»¶
app.use(cookieParser());

app.use(express.static(path.join("public", "main")));

app.post("/microapps", function (req, res) {
    
  // å†æ¬¡åˆ·æ–°é¡µé¢æ—¶è§‚å¯Ÿ Cookie çš„æºå¸¦æƒ…å†µ
  console.log("main cookies: ", req.cookies);

  // è®¾ç½®ä¸€ä¸ªå“åº”çš„ Cookie æ•°æ®
  res.cookie("main-app", true);

  res.json([
    {
      name: "micro1",
      id: "micro1",
      customElement: "micro-app-1",
      // æ›´æ”¹å¾®åº”ç”¨èµ„æºçš„åŠ è½½åœ°å€ï¼Œä½¿ç”¨ Nginx çš„ä»£ç†åœ°å€
      script: `https://${host}:3001/micro1.js`,
      style: `https://${host}:3001/micro1.css`,
      prefetch: true,
    },
    {
      name: "micro2",
      id: "micro2",
      customElement: "micro-app-2",
      script: `https://${host}:3001/micro2.js`,
      style: `https://${host}:3001/micro2.css`,
      prefetch: true,
    },
  ]);
});

// å¯åŠ¨ Node æœåŠ¡
app.listen(port.main, host);
console.log(`server start at http://${host}:${port.main}/`);


// micro-server.js
import express from "express";
import morgan from "morgan";
import path from "path";
import cookieParser from "cookie-parser";
import config from "./config.js";
const app = express();
const { port, host } = config;

app.use(morgan("dev"));

// cookie ä¸­é—´ä»¶
app.use(cookieParser());

app.use((req, res, next) => {
  // è·¨åŸŸè¯·æ±‚ä¸­æ¶‰åŠåˆ° Cookie ä¿¡æ¯ä¼ é€’ï¼Œå€¼ä¸èƒ½ä¸º *ï¼Œå¿…é¡»æ˜¯å…·ä½“çš„åœ°å€ä¿¡æ¯
  // è·¨åŸŸç™½åå•é…ç½®ä¸ºä¸»åº”ç”¨çš„ Nginx ä»£ç†åœ°å€
  res.header("Access-Control-Allow-Origin", `https://ziyi.com:4001`);
  res.header("Access-Control-Allow-Methods", "GET, POST, OPTIONS");
  res.header("Allow", "GET, POST, OPTIONS");
  // å…è®¸å®¢æˆ·ç«¯å‘é€è·¨åŸŸè¯·æ±‚æ—¶æºå¸¦ Cookie
  res.header("Access-Control-Allow-Credentials", true);
  next();
});

app.use(
  express.static(path.join("public", "micro"), {
    etag: true,
    lastModified: true,
  })
);

app.post("/cors", function (req, res) {
    
  // ç”¨äºè§‚å¯ŸäºŒæ¬¡è¯·æ±‚æ—¶çš„ Cookie çš„æºå¸¦æƒ…å†µ
  console.log('micro cookies: ', req.cookies);

  // å¢åŠ  SameSite å’Œ Secure å±æ€§ï¼Œä»è€Œä½¿æµè§ˆå™¨æ”¯æŒ iframe å­åº”ç”¨çš„è·¨ç«™æºå¸¦ Cookie
  // æ³¨æ„ Secure éœ€è¦ HTTPS åè®®çš„æ”¯æŒ
  const cookieOptions = { sameSite: "none", secure: true };
  // è®¾ç½®ä¸€ä¸ªå“åº”çš„ Cookie æ•°æ®
  res.cookie("micro-app", true, cookieOptions);
  res.json({
    hello: "true",
  });
});

app.listen(port.micro, host);
console.log(`server start at http://${host}:${port.micro}/`);
```

å¯åŠ¨ä¸»åº”ç”¨å’Œå­åº”ç”¨çš„æœåŠ¡åå¯ä»¥é‡ç‚¹è§‚å¯Ÿ Cookie çš„æºå¸¦æƒ…å†µï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c3954378880143f0bc36a53bde3a253b~tplv-k3u1fbpfcp-zoom-1.image)

åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¾—åˆ°å¦‚ä¸‹ç»“æœï¼š

-   ä¸»åº”ç”¨æœåŠ¡ç«¯æˆåŠŸè®¾ç½® Cookieï¼Œå†æ¬¡åˆ·æ–°é¡µé¢æ—¶å‰ç«¯çš„è¯·æ±‚ä¼šè‡ªåŠ¨æºå¸¦ä¸Š Cookie ä¿¡æ¯ï¼ˆè§‚å¯ŸæœåŠ¡ç«¯çš„ Cookie æ‰“å°ä¿¡æ¯ï¼‰
-   Chrome æµè§ˆå™¨é‡‡ç”¨è·¨åŸŸ Ajax è¯·æ±‚è¿›è¡Œè®¾è®¡æ—¶ï¼Œé»˜è®¤æ— æ³•æºå¸¦ Cookieï¼Œéœ€è¦ä½¿ç”¨ HTTPS åè®®å’ŒæœåŠ¡ç«¯ Cookie å±æ€§ï¼ˆSameSite å’Œ Secureï¼‰è®¾ç½®æ‰è¡Œ

## å°ç»“

  


åœ¨ Web Components çš„ Ajax è¯·æ±‚ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å‘ç°è·¨ç«™çš„æƒ…å†µä¸‹å’Œ iframe æ–¹æ¡ˆæƒ…å†µç›¸ä¼¼ï¼Œéœ€è¦æœåŠ¡ç«¯è¿›è¡Œ Cookie é…ç½®å’Œè·¨åŸŸæ”¯æŒï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œåœ¨å‰ç«¯çš„ Ajax è¯·æ±‚ä¸­è¿˜è¦é…ç½®å…è®¸æºå¸¦ Cookie çš„å±æ€§ `credentials`ã€‚