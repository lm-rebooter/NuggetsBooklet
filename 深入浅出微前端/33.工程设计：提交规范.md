åœ¨å‰ä¸¤èŠ‚è¯¾ä¸­æˆ‘ä»¬è®²è§£äº†é€šè¿‡é…ç½® ESLint å’Œ Prettier å¯¹æºä»£ç è¿›è¡Œé™æ€æ£€æŸ¥ï¼Œä½†æ˜¯å¼€å‘è€…å¯ä»¥ä¸éµå¾ªè¿™ä¸€å¥—ä»£ç æ£€æŸ¥è§„èŒƒè¿›è¡Œè®¾è®¡ï¼Œå› ä¸ºæ²¡æœ‰ä»»ä½•æµç¨‹å¯ä»¥é˜»æ­¢å¼€å‘è€…æäº¤æ²¡æœ‰è¿›è¡Œæ£€æŸ¥çš„æºä»£ç ã€‚æœ¬æ–‡æ—¨åœ¨è®¾è®¡ä¸€ä¸ªæäº¤ä»£ç çš„æ‹¦æˆªå™¨ï¼Œå¯ä»¥é˜²æ­¢å¼€å‘è€…æäº¤æœªç»æ£€æŸ¥çš„ä»£ç ã€‚

## Git é’©å­

åœ¨å¤šäººåä½œçš„è¿‡ç¨‹ä¸­å¸Œæœ›å¼€å‘è€…æäº¤çš„ä»£ç éƒ½èƒ½ç»è¿‡ ESLint æ£€æŸ¥ï¼Œä»è€Œé˜²æ­¢ä¸è§„èŒƒçš„ä»£ç è¢«æ¨åˆ°è¿œç¨‹ä»“åº“ã€‚å…·ä½“å¦‚ä¸‹æ‰€ç¤ºï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/700947602fc84c72973e88e6301491af~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1182&h=352&e=jpg&b=fefefe)

ä¸ºäº†å®ç°ä¸Šè¿°åŠŸèƒ½éœ€è¦ä½¿ç”¨ [Git é’©å­](https://git-scm.com/book/zh/v2/%E8%87%AA%E5%AE%9A%E4%B9%89-Git-Git-%E9%92%A9%E5%AD%90)ï¼Œå®ƒåœ¨æ‰§è¡Œ `git` å‘½ä»¤æ—¶ä¼šè§¦å‘ç›¸åº”çš„å¯æ‰§è¡Œè„šæœ¬ã€‚ä¾‹å¦‚ Git ä¸º`git commit`æä¾›äº† `pre-commit` é’©å­ï¼Œè¯¥é’©å­ä¼šåœ¨å¼€å‘è€…ä½¿ç”¨ `git commit -m "xxxx"` è¿›è¡Œæäº¤æ—¶è¿è¡Œï¼Œå¯ç”¨äºæå‰æ£€æŸ¥ä»£ç å’Œè¿›è¡Œæµ‹è¯•ï¼Œå¦‚æœé’©å­å¯¹åº”çš„å¯æ‰§è¡Œè„šæœ¬ä»¥éé›¶å€¼é€€å‡ºï¼Œé‚£ä¹ˆ Git ä¼šæ”¾å¼ƒæ­¤æ¬¡æäº¤ã€‚æ‰€æœ‰çš„ Git é’©å­éƒ½è¢«å­˜å‚¨åœ¨ `.git/hooks` ç›®å½•ä¸‹ï¼š

``` bash
# è¿›å…¥ä»“åº“ä»£ç æ‰§è¡Œ
cd .git/hooks 
# æ‰§è¡Œ
ls
# æ‰“å°
applypatch-msg.sample           pre-commit.sample               prepare-commit-msg.sample
commit-msg.sample               pre-merge-commit.sample         push-to-checkout.sample
fsmonitor-watchman.sample       pre-push.sample                 update.sample
post-update.sample              pre-rebase.sample
pre-applypatch.sample           pre-receive.sample
```

ä¸Šè¿°éƒ½æ˜¯ Git æä¾›çš„ Shell è„šæœ¬ç¤ºä¾‹ï¼ŒæŸ¥çœ‹ `pre-commit.sample`ï¼š

``` bash
#!/bin/sh
#
# An example hook script to verify what is about to be committed.
# Called by "git commit" with no arguments.  The hook should
# exit with non-zero status after issuing an appropriate message if
# it wants to stop the commit.
# å¦‚æœè¦å¯åŠ¨é’©å­ï¼Œé‡æ–°å‘½åä¸º pre-commitï¼Œå³å»é™¤ .sample åç¼€
# To enable this hook, rename this file to "pre-commit".

if git rev-parse --verify HEAD >/dev/null 2>&1
then
        against=HEAD
else
        # Initial commit: diff against an empty tree object
        against=$(git hash-object -t tree /dev/null)
fi

# If you want to allow non-ASCII filenames set this variable to true.
allownonascii=$(git config --type=bool hooks.allownonascii)

# Redirect output to stderr.
exec 1>&2

# Cross platform projects tend to avoid non-ASCII filenames; prevent
# them from being added to the repository. We exploit the fact that the
# printable range starts at the space character and ends with tilde.
if [ "$allownonascii" != "true" ] &&
        # Note that the use of brackets around a tr range is ok here, (it's
        # even required, for portability to Solaris 10's /usr/bin/tr), since
        # the square bracket bytes happen to fall in the designated range.
        test $(git diff --cached --name-only --diff-filter=A -z $against |
          LC_ALL=C tr -d '[ -~]\0' | wc -c) != 0
then
        cat <<\EOF
Error: Attempt to add a non-ASCII file name.

This can cause problems if you want to work with people on other platforms.

To be portable it is advisable to rename the file.

If you know what you are doing you can disable this check using:

  git config hooks.allownonascii true
EOF
        exit 1
fi

# If there are whitespace errors, print the offending file names and fail.
exec git diff-index --check --cached $against --
```

å…ˆä¸ç”¨å®Œå…¨ç†è§£ä¸Šè¿° Shell è„šæœ¬çš„ä½œç”¨ï¼Œæ ¹æ® Git é’©å­çš„è¯´æ˜ï¼Œåªè¦æ˜¯éé›¶å€¼é€€å‡ºï¼Œé‚£ä¹ˆå°†æ”¾å¼ƒæ­¤æ¬¡æäº¤ï¼Œå› æ­¤å¯ä»¥ç®€å•ä¿®æ”¹ä¸Šè¿°æ–‡ä»¶å¹¶é‡æ–°å‘½åæˆ `pre-commit` è¿›è¡Œæµ‹è¯•ï¼š

``` bash
# #!/bin/sh å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†è¿›è¡Œè§£é‡Š
# ç¬¬ä¸€éƒ¨åˆ†ï¼š#!
# Shebangï¼šhttps://zh.m.wikipedia.org/zh-hans/Shebang
# ç¬¬äºŒéƒ¨åˆ†ï¼š/bin/sh
# ä¸€ä¸ªç»å¯¹è·¯å¾„ï¼Œç”¨äºæŒ‡æ˜å½“å‰è„šæœ¬æ‰€åœ¨è§£é‡Šå™¨çš„ç»å¯¹è·¯å¾„

#!/bin/sh

#
# An example hook script to verify what is about to be committed.
# Called by "git commit" with no arguments.  The hook should
# exit with non-zero status after issuing an appropriate message if
# it wants to stop the commit.
# å¦‚æœè¦å¯åŠ¨é’©å­ï¼Œéœ€è¦é‡æ–°å‘½åä¸º pre-commitï¼Œå³å»é™¤ .sample åç¼€
# To enable this hook, rename this file to "pre-commit".


# echo: æ‰“å¼€ https://linux.die.net/man/1/bash é“¾æ¥æœç´¢ echo æŸ¥çœ‹è§£é‡Š
# åœ¨ç»ˆç«¯è¾“å‡ºå­—ç¬¦ä¸²ï¼Œå¹¶åœ¨æœ€åé»˜è®¤åŠ ä¸Šæ¢è¡Œç¬¦ï¼Œç±»ä¼¼äº Node ä¸­çš„ console.log
echo "æ”¾å¼ƒ commit æäº¤"

# exit: https://linux.die.net/man/1/bash ä¸­æœç´¢ exit æŸ¥çœ‹è§£é‡Š
# ç”¨äºé€€å‡ºå½“å‰ shell è¿›ç¨‹ï¼Œå¹¶è¿”å›ä¸€ä¸ªé€€å‡ºçŠ¶æ€ç ï¼Œç±»ä¼¼äº Node ä¸­çš„ process.exit(1)
exit 1
```

æ­¤æ—¶åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰§è¡Œ `git commit`å°†ä¸ä¼šäº§ç”Ÿæäº¤è¯´æ˜ï¼Œä»£ç ä»ç„¶ä¼šåœ¨æš‚å­˜åŒºï¼š

``` bash
# æ‰§è¡Œ
git add .
# æ‰§è¡Œ
git commit -m "feat: 111"
# æ‰“å°ï¼ˆè¯´æ˜é’©å­å·²ç»ç”Ÿæ•ˆï¼Œæ”¾å¼ƒäº†æœ¬æ¬¡æäº¤ï¼‰
æ”¾å¼ƒ commit æäº¤

# æ‰§è¡Œ
git status
# æ‰“å°ï¼ˆè¯´æ˜æäº¤å¤±è´¥ï¼Œéœ€è¦è¢«æäº¤çš„ä»£ç ä»ç„¶åœ¨æš‚å­˜åŒºï¼‰
On branch feat/typescript-prettier
Changes to be committed:
  (use "git restore --staged <file>..." to unstage)
        modified:   .prettierrc.js
```

å½“ç„¶ï¼Œå¦‚æœçœŸæƒ³ç»•è¿‡é’©å­æ‰§è¡Œï¼Œå¯ä»¥é€šè¿‡å¢åŠ  `--no-verify` æˆ–ç®€å†™çš„ `-n` å‚æ•°ï¼š

``` bash
# æ‰§è¡Œï¼ˆç»•è¿‡é’©å­æ‰§è¡Œï¼‰
git commit -n -m "feat: 111"
# æ‰“å°ï¼ˆè¯´æ˜ä»£ç æäº¤æˆåŠŸï¼‰
[feat/typescript-prettier 22e3292] feat: 111
 1 file changed, 2 insertions(+), 2 deletions(-)
# æ‰§è¡Œ
git status
# æ‰“å°ï¼ˆæš‚å­˜åŒºæ²¡æœ‰å˜æ›´ï¼‰
On branch feat/typescript-prettier
nothing to commit, working tree clean
```

### Shebang

åœ¨ Git é’©å­çš„ç¤ºä¾‹å¼€å¤´å¯ä»¥å‘ç° `#!/bin/sh`ï¼Œè¯¥æè¿°ç”¨äºå£°æ˜å½“å‰æ‰§è¡Œè„šæœ¬çš„ç±»å‹ï¼Œå®ƒè¢«ç§°ä¸º [Shebang](https://zh.m.wikipedia.org/zh-hans/Shebang) ã€‚ä¾‹å¦‚åœ¨ä½¿ç”¨ Vue æ¡†æ¶æ—¶éœ€è¦ä½¿ç”¨[ Vue CLI](https://cli.vuejs.org/zh/) æ¥åˆ›å»ºé¡¹ç›®ï¼Œå¼€å‘è€…éœ€è¦å®‰è£… `@vue/cli` åŒ…å¹¶ä½¿ç”¨ CLI å‘½ä»¤ `vue create hello-world`ï¼Œå¯ä»¥æŸ¥çœ‹ `@vue/cli` ä¸­çš„ä»£ç ï¼š

``` json
// package.json: https://github.com/vuejs/vue-cli/blob/dev/packages/%40vue/cli/package.json
// å†…éƒ¨è®¾ç½®äº† bin å­—æ®µï¼ŒæŒ‡å‘äº†å…¥å£æ–‡ä»¶ bin/vue.js
{
  "name": "@vue/cli",
  "version": "5.0.8",
  "description": "Command line interface for rapid Vue.js development",
  "bin": {
    // æ‰§è¡Œ vue create hello-world æ—¶åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†
    // 1ã€vue å‘½ä»¤ï¼švue å‘½ä»¤ä¼šæŒ‡å‘ package.json ä¸­çš„ bin.vue å­—æ®µï¼Œå¯»æ‰¾å¯¹åº”çš„æ‰§è¡Œè„šæœ¬è·¯å¾„ bin/vue.js
    // 2ã€create <app-name>ï¼š åœ¨ bin/vue.js ä¸­è§£æçš„å‘½ä»¤å‚æ•°
    "vue": "bin/vue.js"
  },
}
```

åœ¨ `package.json` çš„ `bin` å­—æ®µä¸­å‘ç°äº† `vue` æ‰§è¡Œå‘½ä»¤ï¼Œè¯¥å‘½ä»¤æŒ‡å‘äº† `bin/vue.js` æ–‡ä»¶ï¼š

``` javascript
// bin/vue.js: https://github.com/vuejs/vue-cli/blob/dev/packages/%40vue/cli/bin/vue.js
// å†…éƒ¨ä½¿ç”¨äº†ä¸€ä¸ª Shebangï¼Œé»˜è®¤ä½¿ç”¨ Node è§£é‡Šå™¨è¿›è¡Œæ‰§è¡Œ
#!/usr/bin/env node

// æ¥ä¸‹æ¥è®¾è®¡çš„éƒ½æ˜¯ Node ä»£ç 
```

ä¸Šè¿°çš„ `#!/usr/bin/env node` å’Œ `pre-commit` ä¸­çš„`#!/bin/sh` ç¨å¾®æœ‰ä¸€äº›å·®å¼‚ï¼Œé¦–å…ˆæŸ¥çœ‹ä¸€ä¸‹ Node çš„å®‰è£…è·¯å¾„ï¼š

``` bash
# æ‰§è¡Œ
which node
# æ‰“å°
/usr/local/bin/node
```

é€šå¸¸æƒ…å†µä¸‹è®¾è®¡ä¸€ä¸ª Node è„šæœ¬æ–‡ä»¶éœ€è¦é€šè¿‡ `node xxx.js` çš„æ–¹å¼è¿›è¡Œæ‰§è¡Œï¼Œä½†æ˜¯å¦‚æœè®¾è®¡ä¸€ä¸ªå¸¦ Shebang çš„ Node è„šæœ¬ï¼Œ `index.js` å¯ä»¥ç›´æ¥ä½¿ç”¨ `xxx.js` æ‰§è¡Œï¼Œåœ¨æ‰§è¡Œæ—¶å¯ä»¥ä¸éœ€è¦ä½¿ç”¨ `node index.js`ï¼š

``` javascript
// /usr/local/bin/node æ˜¯ä¸€ä¸ªç»å¯¹è·¯å¾„ï¼Œæ˜¯ä¸Šè¿° which node å‘½ä»¤æ‰“å°çš„ Node åœ°å€
// ç”¨äºæŒ‡æ˜ Node è§£é‡Šå™¨çš„ç»å¯¹è·¯å¾„
#!/usr/local/bin/node

console.log(111);
```

å› ä¸º Shebang é»˜è®¤ä¼šå¯»æ‰¾è§£é‡Šå™¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

``` bash
# æ‰§è¡Œï¼Œç»™ index.js æ·»åŠ å¯æ‰§è¡Œæƒé™
chmod +x index.js
# æ‰§è¡Œï¼Œç±»ä¼¼ shell è„šæœ¬
./index.js
# æ‰“å°
111
```

å°½ç®¡ä½¿ç”¨ `which node` å¯ä»¥å¯»æ‰¾åˆ°æ¯ä¸ªç”¨æˆ·å„è‡ªå®‰è£…çš„ Node åœ°å€ï¼Œä½†æ˜¯åœ¨é€šç”¨çš„æ¡†æ¶ä¸­ä½¿ç”¨ Shebangï¼Œä¸å¯èƒ½å…ˆæ‰§è¡Œ `which node`ã€‚åœ¨ Vue CLI ä¸­ä¼šå‘ç° Node è§£é‡Šå™¨çš„åœ°å€ä½¿ç”¨çš„æ˜¯ `#!/usr/bin/env node`ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ `which node` å¯»æ‰¾çš„åœ°å€ `/usr/local/bin/node`ï¼Œè¿™å…¶å®ç›¸å½“äºä» ` env | grep PATH  `å¯¹åº”çš„è·¯å¾„ä¸­å¯»æ‰¾ Node è§£é‡Šå™¨ï¼Œä»ä¸‹è¿°æ‰“å°å¯ä»¥å‘ç° `#!/usr/bin/env node` åŒ…å«äº† `/usr/local/bin/node` åœ°å€ï¼š

``` bash
# æ‰§è¡Œ
env | grep PATH 
# æ‰“å°ï¼ŒåŒ…å«äº† /usr/local/bin è·¯å¾„ï¼Œå› æ­¤èƒ½æ‰¾åˆ° /usr/local/bin/node
PATH=/opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/bin:/System/Cryptexes/App/usr/bin:/usr/bin:/bin:/usr/sbin:/sbin:/opt/homebrew/bin:/opt/homebrew/sbin
```

ç”±äº Node å¯èƒ½ä¼šéšç€å®‰è£…å·¥å…·çš„ä¸åŒè€Œæ”¾å…¥ä¸åŒçš„å®‰è£…è·¯å¾„ï¼Œå› æ­¤ä½¿ç”¨ `#!/usr/bin/env node` ç›¸æ¯”äº `#!/usr/local/bin/node` æ‰©å¤§äº†æœç´¢ Node è§£é‡Šå™¨çš„è·¯å¾„èŒƒå›´ï¼Œæ›´åŠ å…·å¤‡æ™®é€‚æ€§ã€‚å¯ä»¥ç›´æ¥åœ¨ç»ˆç«¯ä¸­å¯»æ‰¾ Node è§£é‡Šå™¨è¿›è¡ŒéªŒè¯ï¼š

``` bash
# æ‰§è¡Œ /usr/bin/env node å¯åŠ¨ Node 
# æ‰§è¡Œ /usr/local/bin/node ä¹Ÿå¯ä»¥å¯åŠ¨ Node

# æ‰§è¡Œ
/usr/bin/env node
# æ‰“å°
Welcome to Node.js v18.12.0.
Type ".help" for more information.
# è¾“å…¥
> 1 + 1
# æ‰“å°
2
> 

# æ‰§è¡Œ /usr/bin/env sh å¯åŠ¨ Shell
# æ‰§è¡Œ /bin/sh åŒç†ï¼Œå› æ­¤åœ¨ Shell ä¸­ä½¿ç”¨ #!/bin/sh å’Œ #!/usr/bin/env sh éƒ½è¡Œ

# æ‰§è¡Œ
/usr/bin/env sh  
# è¾“å…¥ echo 111
sh-3.2$ echo 111
# æ‰“å°
111
# è¾“å…¥ exit 1
sh-3.2$ exit 1
# æ‰“å°
exit
```

é€šè¿‡å­¦ä¹  Shebang å¯ä»¥å°† `.git/hooks` ä¸‹çš„ `pre-commit` æ›´æ”¹ä¸ºä½¿ç”¨å‰ç«¯æ›´åŠ ç†Ÿæ‚‰çš„ Node è„šæœ¬è¿›è¡Œè®¾è®¡ï¼š

``` javascript
#!/usr/bin/env node

console.log('Node: æ”¾å¼ƒ commit æäº¤');
process.exit(1);

// ä»¥ä¸‹æ˜¯ä¹‹å‰è®¾è®¡çš„ Shell è„šæœ¬
// #!/bin/sh
// åœ¨ç»ˆç«¯è¾“å‡ºå­—ç¬¦ä¸²ï¼Œå¹¶åœ¨æœ€åé»˜è®¤åŠ ä¸Šæ¢è¡Œç¬¦ï¼Œç±»ä¼¼äº Node ä¸­çš„ console.log
// echo "æ”¾å¼ƒ commit æäº¤"

// exit: https://linux.die.net/man/1/bash ä¸­æœç´¢ exit æŸ¥çœ‹è§£é‡Š
// ç”¨äºé€€å‡ºå½“å‰ shell è¿›ç¨‹ï¼Œå¹¶è¿”å›ä¸€ä¸ªé€€å‡ºçŠ¶æ€ç ï¼Œç±»ä¼¼äº Node ä¸­çš„ process.exit(1)
// exit 1
```

æ­¤æ—¶é€šè¿‡ `git commit` è¿›è¡Œä»£ç æäº¤å¯ä»¥å’Œ Shell è„šæœ¬äº§ç”Ÿé€šç”¨çš„æ•ˆæœï¼š

``` bash
# æ‰§è¡Œ
git add .
git commit -m "feat: 111"     
# æ‰“å°
Node: æ”¾å¼ƒ commit æäº¤
# æ‰§è¡Œ
git status
# æ‰“å°
On branch feat/typescript-prettier
Changes to be committed:
(use "git restore --staged <file>..." to unstage)
modified:   gulpfile.js
```

### é’©å­çš„ç±»å‹

Git é’©å­éå¸¸å¤šï¼Œè¿™é‡Œåˆ—ä¸¾åœ¨å®¢æˆ·ç«¯ä¸­å¸¸ç”¨çš„ä¸¤ä¸ªé’©å­ï¼š

-   `pre-commit`ï¼šGit ä¸­ `pre` ç³»åˆ—é’©å­å…è®¸ç»ˆæ­¢å³å°†å‘ç”Ÿçš„ Git æ“ä½œï¼Œè€Œ `post` ç³»åˆ—å¾€å¾€ç”¨ä½œé€šçŸ¥ Git æ“ä½œå®Œæˆåçš„è¡Œä¸ºã€‚`pre-commit` é’©å­åœ¨é”®å…¥æäº¤ä¿¡æ¯ï¼ˆ `git commit`ï¼‰å‰è¿è¡Œï¼Œä¸»è¦ç”¨äºæ£€æŸ¥å½“å‰å³å°†è¢«æäº¤çš„ä»£ç å¿«ç…§ï¼Œä¾‹å¦‚æäº¤é—æ¼ã€æµ‹è¯•ç”¨ä¾‹ä»¥åŠä»£ç æ£€æŸ¥ç­‰ã€‚è¯¥é’©å­å¦‚æœä»¥éé›¶å€¼é€€å‡ºï¼Œåˆ™ Git å°†æ”¾å¼ƒæœ¬æ¬¡æäº¤ã€‚
-   `commit-msg`ï¼šè¯¥é’©å­åœ¨ç”¨æˆ·è¾“å…¥ Commit Message åè¢«è°ƒç”¨ï¼Œæ¥æ”¶å­˜æœ‰å½“å‰ Commit Message ä¿¡æ¯çš„ä¸´æ—¶æ–‡ä»¶è·¯å¾„ä½œä¸ºå”¯ä¸€å‚æ•°ï¼Œå› æ­¤å¯ä»¥åˆ©ç”¨è¯¥é’©å­æ¥æ ¸å¯¹ Commit Meesage ä¿¡æ¯ã€‚è¯¥é’©å­å’Œ `pre-commit` ç±»ä¼¼ï¼Œä¸€æ—¦ä»¥éé›¶å€¼é€€å‡º Git å°†æ”¾å¼ƒæœ¬æ¬¡æäº¤ã€‚

é™¤äº†ä¸Šè¿°å¸¸ç”¨çš„å®¢æˆ·ç«¯é’©å­ï¼Œè¿˜æœ‰ä¸¤ä¸ªå¸¸ç”¨çš„æœåŠ¡ç«¯é’©å­ï¼š

-   `pre-receive`ï¼šè¯¥é’©å­ä¼šåœ¨è¿œç¨‹ä»“åº“æ¥æ”¶ `git push` æ¨é€çš„ä»£ç æ—¶æ‰§è¡Œï¼Œä¼šæ¯” `pre-commit` æ›´åŠ æœ‰çº¦æŸåŠ›ï¼Œå› ä¸ºæ€»ä¼šæœ‰å¼€å‘äººå‘˜ä¸å–œæ¬¢æäº¤ä»£ç æ—¶æ‰€åšçš„ä¸€å †æ£€æµ‹ï¼Œä»è€Œé€‰æ‹©ç»•è¿‡è¿™äº›å®¢æˆ·ç«¯é’©å­ã€‚`pre-receive` é’©å­å¯ç”¨äºæ¥æ”¶ä»£ç æ—¶çš„å¼ºåˆ¶è§„èŒƒæ ¡éªŒï¼Œå¦‚æœæŸä¸ªå¼€å‘äººå‘˜é‡‡ç”¨äº†ç»•è¿‡ `pre-commit` é’©å­çš„æ–¹å¼æäº¤äº†ä¸€å † ğŸ’© ä¸€æ ·çš„ä»£ç ï¼Œé‚£ä¹ˆé€šè¿‡è®¾ç½®è¯¥é’©å­ï¼Œå¯ä»¥æ‹’ç»ä»£ç æäº¤ã€‚å½“ç„¶è¯¥é’©å­æœ€å¸¸ç”¨çš„æ“ä½œè¿˜æ˜¯ç”¨äºæ£€æŸ¥æ˜¯å¦æœ‰æƒé™æ¨é€ä»£ç ã€éå¿«é€Ÿå‘å‰åˆå¹¶ç­‰ã€‚
-   `post-receive`ï¼šè¯¥é’©å­åœ¨æ¨é€ä»£ç æˆåŠŸåæ‰§è¡Œï¼Œé€‚åˆç”¨äºå‘é€é‚®ä»¶é€šçŸ¥æˆ–è€…è§¦å‘ CI ã€‚

> **æ¸©é¦¨æç¤º**ï¼šæƒ³äº†è§£æ›´å¤š Git é’©å­å¯ä»¥æŸ¥çœ‹ [å®˜æ–¹æ–‡æ¡£](https://git-scm.com/book/zh/v2/%E8%87%AA%E5%AE%9A%E4%B9%89-Git-Git-%E9%92%A9%E5%AD%90)ã€‚

### é’©å­çš„ä½œç”¨

é€šè¿‡ä¸Šè¿°è¯´æ˜å¯ä»¥å‘ç°ï¼Œ Git é’©å­æ˜¯è¿›è¡Œé¡¹ç›®çº¦æŸéå¸¸å¥½ç”¨çš„å·¥å…·ï¼Œå®ƒçš„ä½œç”¨åŒ…æ‹¬ä½†ä¸é™äºï¼š

-   Commit Message è§„èŒƒå¼ºåˆ¶ç»Ÿä¸€ï¼›
-   ESLint è§„åˆ™ç»Ÿä¸€ï¼Œé˜²æ­¢ä¸ç¬¦åˆè§„èŒƒçš„ä»£ç æäº¤ï¼›
-   Prettier è‡ªåŠ¨æ ¼å¼åŒ–ï¼ˆåŒ…æ‹¬ Style æ ·å¼æ ¼å¼ç­‰ï¼‰ï¼›
-   ä»£ç ç¨³å®šæ€§æäº¤ï¼Œæäº¤ä¹‹å‰ç¡®ä¿æµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡ï¼›
-   å‘é€é‚®ä»¶é€šçŸ¥ï¼›
-   CI é›†æˆã€‚

### ç¤¾åŒºå·¥å…·

å¯¹äºå‰ç«¯å¼€å‘è€Œè¨€æ›´æ”¹ `.git/hooks` ä¸‹çš„é’©å­è„šæœ¬é€‚é…å‰ç«¯é¡¹ç›®å¹¶ä¸å‹å¥½ï¼Œå› ä¸ºåœ¨å›¢é˜Ÿåä½œä¸­ `.git/hooks` å¹¶ä¸èƒ½è¢«ä¸Šä¼ åˆ°è¿œç¨‹ä»“åº“ï¼Œå› æ­¤ Git é’©å­ä¸èƒ½å½¢æˆå›¢é˜Ÿå…±äº«ã€‚ä¸ºäº†è§£å†³è¯¥é—®é¢˜ï¼Œç¤¾åŒºå‡ºç°äº†ä¸€äº›å¢å¼ºå·¥å…·ï¼Œå®ƒä»¬å¯¹é¡¹ç›®æŠ›å‡ºäº†ä¸€äº›ç®€å•çš„é’©å­é…ç½®ï¼ˆä¾‹å¦‚ [ghooks](https://github.com/ghooks-org/ghooks) åœ¨ `package.json` ä¸­åªéœ€è¦è¿›è¡Œç®€å•çš„[é’©å­å±æ€§é…ç½®](https://github.com/ghooks-org/ghooks#setup)ï¼‰ï¼Œç±»ä¼¼çš„å·¥å…·è¿˜åŒ…å« [husky](https://github.com/typicode/husky) å’Œ [pre-commit](https://github.com/pre-commit/pre-commit) ã€‚

> **æ¸©é¦¨æç¤º**ï¼šé€šè¿‡ Shebang çš„ä»‹ç»å¯ä»¥å‘ç°ï¼Œ Git é’©å­å¯ä»¥å®šåˆ¶è„šæœ¬æ‰§è¡Œçš„è¯­è¨€ç¯å¢ƒï¼Œå¯¹äºå‰ç«¯è€Œè¨€å¸Œæœ›ä½¿ç”¨ç†Ÿæ‚‰çš„ Node è¿›è¡Œè„šæœ¬è®¾è®¡ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡åœ¨è„šæœ¬æ–‡ä»¶çš„å¤´éƒ¨è®¾ç½® Shebang `#!/usr/bin/env node` å°† Node ä½œä¸ºå¯æ‰§è¡Œæ–‡ä»¶çš„ç¯å¢ƒè§£é‡Šå™¨ï¼Œè¿™é‡Œç»™å‡ºä¸€ä¸ªä½¿ç”¨ Node è§£é‡Šå™¨çš„ç¤ºä¾‹ï¼š[ghooks - hook.template.raw](https://github.com/ghooks-org/ghooks/blob/master/lib/hook.template.raw)ï¼Œghooks çš„å®ç°éå¸¸ç®€å•ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ä»”ç»†é˜…è¯»ä¸€äº›æºç çš„å®ç°ã€‚

ä¸ºäº†è¿›è¡Œ ESLint è§„èŒƒçº¦æŸï¼Œå¯ä»¥ä½¿ç”¨ Git çš„`pre-commit` é’©å­é…åˆ ESLint è¿›è¡Œä»£ç æäº¤å‰çš„ä»£ç æ£€æŸ¥ï¼Œå¦‚æœæ£€æŸ¥è¿›ç¨‹å¼‚å¸¸é€€å‡ºï¼Œåˆ™æ”¾å¼ƒä»£ç æäº¤ã€‚å½“ç„¶å¦‚æœé¡¹ç›®è¶Šæ¥è¶Šå¤§ï¼ŒESLint æ ¡éªŒçš„æ—¶é—´å¯èƒ½è¶Šæ¥è¶Šé•¿ï¼Œè¿™å¯¹äºé¢‘ç¹ä¿®æ”¹ä»£ç çš„æäº¤è€…è€Œè¨€å¯èƒ½æ˜¯ä¸€ä»¶ç›¸å¯¹ç—›è‹¦çš„äº‹æƒ…ï¼Œè¿™é‡Œè¿˜å¯ä»¥å€ŸåŠ© [lint-staged](https://github.com/okonet/lint-staged) å·¥å…·ï¼Œè¯¥å·¥å…·åªä¼šæ£€æŸ¥æ”¾åœ¨ Git æš‚å­˜åŒºçš„ä»£ç ï¼Œä»è€Œå¯ä»¥å‡å°‘ä»£ç çš„æ£€æŸ¥é‡ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬é‡ç‚¹çœ‹ä¸‹è¿™äº›ç¤¾åŒºå·¥å…·çš„å·¥ä½œåŸç†å’Œä½¿ç”¨æ–¹æ³•ã€‚

  
## Husky & Lint Staged é…ç½®

å¦‚æœæƒ³è¦å¼€å‘è€…æäº¤ç¬¦åˆ ESLint æ ¡éªŒçš„ä»£ç ï¼Œå¯ä»¥ä½¿ç”¨ husky é…åˆ lint-staged å·¥å…·å®ç°ã€‚ä¸¤è€…é…åˆä½¿ç”¨å¯ä»¥å®ç°åœ¨æäº¤è¯´æ˜æ—¶è‡ªåŠ¨ä½¿ç”¨ ESLint æ£€æŸ¥ Git æš‚å­˜åŒºçš„ä»£ç ï¼Œä¸€æ—¦å­˜åœ¨ ğŸ’© ä¸€æ ·ä¸ç¬¦åˆæ ¡éªŒè§„åˆ™çš„ä»£ç ï¼Œåˆ™ä¼šæ”¾å¼ƒæäº¤è¡Œä¸ºã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/16dcc17054214a1680c081dfb7c3c8ed~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1441&h=350&e=jpg&b=fefefe)

æ¥ä¸‹æ¥æˆ‘ä»¬é‡ç‚¹çœ‹ä¸‹ä¸Šè¿°åŠŸèƒ½å¦‚ä½•å®ç°ã€‚


### Husky é…ç½®

Git çš„é’©å­é»˜è®¤æ”¾åœ¨ `.git/hooks` ç›®å½•ä¸‹ï¼Œç”±äº `.git/hooks` ç›®å½•ä¸‹çš„å†…å®¹å˜æ›´ä¸ä¼šè¢«æäº¤åˆ°è¿œç¨‹ä»“åº“ï¼Œå› æ­¤åœ¨é»˜è®¤çš„ `.git/hooks` ç›®å½•ä¸‹è®¾è®¡é’©å­è„šæœ¬æ— æ³•å®æ—¶å…±äº«ç»™å›¢é˜Ÿçš„å…¶ä»–å¼€å‘è€…ã€‚ä¸ºäº†å¯ä»¥å®ç° Git é’©å­çš„å…±äº«ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼ï¼š

-   ç¬¬ä¸€æ­¥ï¼šé€šè¿‡ Git å‘½ä»¤æ›´æ”¹ Git é»˜è®¤çš„é’©å­ç›®å½• `.git/hooks`ï¼Œä»è€Œå¯ä»¥å°†è‡ªå®šä¹‰çš„é’©å­ç›®å½•æäº¤åˆ°è¿œç¨‹ä»“åº“ï¼›
-   ç¬¬äºŒæ­¥ï¼šå…¶ä»–å¼€å‘ä¸‹è½½ä»£ç åï¼Œä¹Ÿéœ€è¦é€šè¿‡ Git å‘½ä»¤æ›´æ”¹é»˜è®¤çš„é’©å­ç›®å½•ä¸ºä¸‹è½½åçš„è‡ªå®šä¹‰é’©å­ç›®å½•ï¼Œä»è€Œä½¿è¿œç«¯çš„è‡ªå®šä¹‰é’©å­ç›®å½•å¯ä»¥å½¢æˆå…±äº«

> æ¸©é¦¨æç¤ºï¼šåœ¨ä½¿ç”¨ `git pull` ä¹‹åï¼Œå¯ä»¥ä½¿ç”¨ `post-merge` é’©å­æ‰§è¡Œæ›´æ”¹ Git é’©å­ç›®å½•çš„æ“ä½œï¼Œä½†æ˜¯å‰ææ˜¯å¾—æ›´æ–° `.git/hooks` ç›®å½•ä¸‹çš„ `post-merge` é’©å­ï¼Œå¦‚ä½•å®æ—¶é€šçŸ¥å¼€å‘è€…æ›´æ–°é’©å­æœ¬å°±æ˜¯é—®é¢˜æ‰€åœ¨ã€‚å› æ­¤å¯ä»¥é€€è€Œæ±‚å…¶æ¬¡ï¼Œä½¿ç”¨ NPM çš„é’©å­æ¥å®ç° Git é’©å­ç›®å½•çš„æ›´æ”¹ã€‚

ç”±äºç¬¬äºŒæ­¥ç›¸å¯¹å¼€å‘è€…ä¸å¤Ÿå‹å¥½ï¼Œå¯ä»¥æ›´æ”¹æ‰§è¡Œç­–ç•¥ï¼š

-   ç¬¬ä¸€æ­¥ï¼šå‘å¸ƒä¸€ä¸ª NPM åŒ…ï¼Œå†…éƒ¨è®¾è®¡ CLI å‘½ä»¤ç”¨äºæ›´æ”¹ Git é»˜è®¤çš„é’©å­ç›®å½•ï¼›
-   ç¬¬äºŒæ­¥ï¼šåœ¨é¡¹ç›®ä¸­è®¾ç½® NPM Script çš„ `prepare` é’©å­ï¼Œç”¨äºæ‰§è¡Œ CLI å‘½ä»¤ï¼›
-   ç¬¬ä¸‰æ­¥ï¼šå°†è‡ªå®šä¹‰é’©å­ç›®å½•è®¾è®¡çš„é’©å­è„šæœ¬ï¼ˆå…·å¤‡å¯æ‰§è¡Œæƒé™ï¼‰æäº¤åˆ°è¿œç¨‹å½¢æˆå…±äº«ã€‚

> æ¸©é¦¨æç¤ºï¼š`prepare` é’©å­åœ¨ä½¿ç”¨ `npm i`ã€`npm publish`ã€`npm pack` ç­‰æƒ…å†µä¸‹è§¦å‘ï¼Œæ›´å¤šè§¦å‘çš„åœºæ™¯å¯ä»¥æŸ¥çœ‹ [NPM / Life Cycle Scripts](https://docs.npmjs.com/cli/v8/using-npm/scripts#life-cycle-scripts)ã€‚

Husky 8.0.3 ç‰ˆæœ¬å·®ä¸å¤šä½¿ç”¨ä¸Šè¿°æ€æƒ³å®ç°ï¼ŒæŸ¥çœ‹[å®˜æ–¹æ–‡æ¡£](https://github.com/typicode/husky)è¿›è¡Œä¾èµ–å®‰è£…ï¼Œå¹¶åœ¨é¡¹ç›®ä¸­è®¾ç½® NPM Script é’©å­ï¼š

``` bash
# åœ¨é¡¹ç›®ä¸­å›ºå®šäº† 8.0.3 ç‰ˆæœ¬
npm install husky -D

# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œä¸‹è¿°å‘½ä»¤ 
# ä¼šåœ¨ pacakge.json çš„ scripts å­—æ®µä¸­ç”Ÿæˆ "prepare": "husky install"
# ä¸Šä¼ åˆ°è¿œç¨‹ä»“åº“åï¼Œåˆ«çš„å¼€å‘è€…åŒæ­¥ä»£ç å¹¶ä½¿ç”¨ npm i å®‰è£…ä¾èµ–åï¼Œä¼šè‡ªåŠ¨è§¦å‘ husky install 
npm set-script prepare "husky install"
npm run prepare
```

> æ¸©é¦¨æç¤ºï¼šç¤ºä¾‹æºç å¯ä»¥ä» micro-framework çš„ [demo/husky](https://github.com/ziyi2/micro-framework/tree/demo/husky) åˆ†æ”¯è·å–ã€‚

æ‰§è¡Œåå¯ä»¥å‘ç°é¡¹ç›®çš„ `package.json` ä¸­ç”Ÿæˆäº† `prepare`é’©å­ï¼š

``` json
// package.json
"scripts": {
  // è‡ªåŠ¨ç”Ÿæˆé’©å­
  "prepare": "husky install"
},
```

> æ¸©é¦¨æç¤ºï¼šå¦‚æœåœ¨å®é™…é…ç½® Husky çš„è¿‡ç¨‹ä¸­å‘ç° Git é’©å­å¤±æ•ˆï¼Œå¯ä»¥æŸ¥çœ‹ä¸€ä¸‹æ˜¯å¦æ˜¯å†…éƒ¨åŸç†åšäº†éå…¼å®¹æ€§æ›´æ–°ï¼Œå¹¶é‡ç‚¹æŸ¥çœ‹ä¸€ä¸‹å®˜æ–¹çš„æ“ä½œå‘½ä»¤æ˜¯å¦æœ‰å˜æ›´ï¼Œæœ¬æ–‡ä½¿ç”¨çš„ Husky ç‰ˆæœ¬ä¸º 8.0.3ã€‚

  


é‡ç‚¹æ¥çœ‹ä¸€ä¸‹ `husky install` å‘½ä»¤ï¼Œä¸€èˆ¬å°† NPM åŒ…å°è£…æˆ CLI å·¥å…·åå¯ä»¥åœ¨ `package.json` çš„ `bin` å­—æ®µä¸­æ‰¾åˆ°å¯¹åº”çš„è„šæœ¬å…¥å£ï¼š

``` json
// node_modules/husky/package.json
{
  "bin": "lib/bin.js",
}

// ä¸Šè¿°é…ç½®ç­‰åŒäºï¼š
{
  "bin": {
    // æ‰§è¡Œ husky install æ—¶åˆ†ä¸ºä¸¤éƒ¨åˆ†
    // é€šè¿‡ husky å‘½ä»¤å¯»æ‰¾ lib/bin.js æ‰§è¡Œæ–‡ä»¶
    // install æ˜¯å†…éƒ¨ Node è„šæœ¬éœ€è¦è§£æçš„å‚æ•°
    "husky": "lib/bin.js",
  }
}
```

ä» `package.json` ä¸­å¯ä»¥çœ‹å‡ºä½¿ç”¨ `husky` å‘½ä»¤ä¼šæ‰§è¡Œ `lib/bin.js` è„šæœ¬ï¼š

``` javascript
// lib/bin.js
// ç†Ÿæ‚‰çš„ Shebang
#!/usr/bin/env node

"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const p = require("path");
// ./ æŒ‡å‘äº† lib/index.js
const h = require("./");
function help(code) {
  console.log(Usage:
  husky install [dir] (default: .husky)
  husky uninstall
  husky set|add <file> [cmd]);
  process.exit(code);
}

// è§£æ husky install ä¸­çš„ install å‘½ä»¤
// æ³¨æ„æ‰§è¡Œ husky install æ—¶ husky å‘½ä»¤ä¼šæ‰§è¡Œ lib/bin.jsï¼Œè€Œ install ä¼šè¢«è¯†åˆ«ä¸ºå‚æ•°
const [, , cmd, ...args] = process.argv;
const ln = args.length;
const [x, y] = args;
const hook = (fn) => () => !ln || ln > 2 ? help(2) : fn(x, y);
const cmds = {
    // husky intall æŒ‡å‘äº† install å‡½æ•°ï¼ŒæŸ¥çœ‹ h å¯¹è±¡æ‰€åœ¨çš„ lib/index.js æ–‡ä»¶
    install: () => (ln > 1 ? help(2) : h.install(x)),
    uninstall: h.uninstall,
    set: hook(h.set),
    add: hook(h.add),
    ['-v']: () => console.log(require(p.join(__dirname, '../package.json')).version),
};
try {
    cmds[cmd] ? cmds[cmd]() : help(0);
}
catch (e) {
    console.error(e instanceof Error ? husky - ${e.message} : e);
    process.exit(1);
}
```

> æ¸©é¦¨æç¤ºï¼šå¯ä»¥ç›´æ¥é˜…è¯» `npm i husky` ä¹‹åçš„ `node_modules` ç›®å½•ä¸‹å‘å¸ƒåçš„ç‰ˆæœ¬ä»£ç ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ github ä¸Šå¯»æ‰¾ husky æœ€æ–°ç‰ˆæœ¬çš„æºç è¿›è¡Œé˜…è¯»ï¼Œè¿™é‡Œç»Ÿä¸€é˜…è¯»æœ¬åœ°å®‰è£…ä¹‹åçš„åŒ…ä»£ç ã€‚

æŸ¥çœ‹ `h.install` å‡½æ•°å¯¹åº”çš„`lib/index.js`ï¼š

``` javascript
// lib/index.js
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.uninstall = exports.add = exports.set = exports.install = void 0;
const cp = require("child_process");
const fs = require("fs");
const p = require("path");
const l = (msg) => console.log(husky - ${msg});
const git = (args) => cp.spawnSync('git', args, { stdio: 'inherit' });

// é»˜è®¤ä½¿ç”¨ .husky ä½œä¸º hooks å­˜æ”¾çš„ç›®å½•
function install(dir = '.husky') {
    if (process.env.HUSKY === '0') {
        l('HUSKY env variable is set to 0, skipping install');
        return;
    }
    if (git(['rev-parse']).status !== 0) {
        return;
    }
    const url = 'https://typicode.github.io/husky/#/?id=custom-directory';
    if (!p.resolve(process.cwd(), dir).startsWith(process.cwd())) {
        throw new Error(.. not allowed (see ${url}));
    }
    if (!fs.existsSync('.git')) {
        throw new Error(.git can't be found (see ${url}));
    }
    
    try {
        // åˆ›å»º .hooks/_ ç›®å½•
        fs.mkdirSync(p.join(dir, '_'), { recursive: true });
        // åˆ›å»º .hooks/_/.gitignore ç›®å½•ï¼Œå¹¶å†™å…¥ *
        // _ ç›®å½•ä¸‹çš„æ–‡ä»¶éƒ½æ˜¯ç”± husky install å‘½ä»¤è‡ªåŠ¨ç”Ÿæˆï¼Œå› æ­¤ä¸éœ€è¦ä¸Šä¼ è¿œç¨‹ä»“åº“
        fs.writeFileSync(p.join(dir, '_/.gitignore'), '*');
        // å°† husky åŒ…ä¸­çš„ husky.sh æ‹·è´åˆ° .hooks/_/husky.sh
        fs.copyFileSync(p.join(__dirname, '../husky.sh'), p.join(dir, '_/husky.sh'));
        // ä½¿ç”¨ git config core.hooksPath .hooks æ›´æ”¹ git é»˜è®¤çš„é’©å­ç›®å½•ä¸º .hooks ç›®å½•
        // å¯ä»¥é€šè¿‡ git config --list æŸ¥çœ‹é…ç½®ç»“æœ  
        const { error } = git(['config', 'core.hooksPath', dir]);
        if (error) {
            throw error;
        }
    }
    catch (e) {
        l('Git hooks failed to install');
        throw e;
    }
    // husky æ‰§è¡ŒæˆåŠŸåä¼šæ‰“å°è¯¥ä¿¡æ¯
    l('Git hooks installed');
}
exports.install = install;
```

é€šè¿‡ä¸Šè¿°ä»£ç å¯ä»¥å‘ç°ï¼Œæ‰§è¡Œ `husky install` æœ€ä¸»è¦çš„ä½œç”¨å°±æ˜¯æ›´æ”¹ Git é’©å­çš„é»˜è®¤ç›®å½•ä¸º `.hooks` ç›®å½•ï¼š

``` bash
# æ‰§è¡Œ husky install å‘½ä»¤
# å¦‚æœæ˜¯å…¶ä»–å¼€å‘è€…å…‹éš†é¡¹ç›®å¹¶æ‰§è¡Œ npm iï¼Œé»˜è®¤ä¼šè§¦å‘ prepare é’©å­ï¼Œè¿™é‡Œæ‰‹åŠ¨æ‰§è¡Œ
npm run prepare

# æ‰“å°
> ziyi-sdk-demo@1.0.5 prepare
> husky install

husky - Git hooks installed
```

æ‰§è¡ŒæˆåŠŸåï¼Œå¯ä»¥å‘ç°ï¼Œåœ¨é¡¹ç›®æ ¹ç›®å½•è‡ªåŠ¨ç”Ÿæˆäº† `.husky` ç›®å½•ï¼š

``` bash
â”œâ”€â”€ .husky
â”‚   â””â”€â”€ -   # _ ç›®å½•ä¸ä¼šæäº¤åˆ°è¿œç¨‹ä»“åº“ï¼Œ husky install è‡ªåŠ¨ç”Ÿæˆ
â”‚       â”œâ”€â”€ .gitignore
â”‚       â””â”€â”€ husky.sh
â”œâ”€â”€ .vscode/                                                              
â”œâ”€â”€ node_modules/               
â”œâ”€â”€ build/      
â”œâ”€â”€ lib/          
â”œâ”€â”€ src/                 
â”œâ”€â”€ .eslintignore  
â”œâ”€â”€ eslintrc.js         
â”œâ”€â”€ .gitignore        
â”œâ”€â”€ README.md   
â”œâ”€â”€ package-lock.json        
â”œâ”€â”€ package.json         
â””â”€â”€ tsconfig.json 
```

æ­¤æ—¶åœ¨ `.husky` ç›®å½•ä¸‹æ²¡æœ‰è®¾ç½®ä»»ä½• Git é’©å­ï¼ŒæŸ¥çœ‹å®˜æ–¹æ–‡æ¡£å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œæ·»åŠ ï¼š

``` bash
# npx: https://docs.npmjs.com/cli/v8/commands/npx
# å…³äº npx husky çš„è¯´æ˜ï¼š
# 1ã€å¦‚æœé¡¹ç›®çš„ node_modules/bin ç›®å½•ä¸‹èƒ½å¤Ÿæ‰¾åˆ° husky å‘½ä»¤ï¼Œåˆ™ä¼˜å…ˆä½¿ç”¨å‘½ä»¤å¯¹åº”çš„æ‰§è¡Œè„šæœ¬
# 2ã€å¦‚æœæœ¬åœ°é¡¹ç›®ä¸­æ²¡æœ‰ï¼Œé‚£ä¹ˆä¼šä¸´æ—¶ä¸‹è½½ NPM åŒ…åˆ°ç¼“å­˜ç›®å½•ä¸­ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°æ“ä½œç³»ç»Ÿçš„ç¯å¢ƒå˜é‡ PATH ä¸­
npx husky add .husky/pre-commit "npm test"

# ç”±äºåœ¨æœ¬åœ°é¡¹ç›®ä¸­å®‰è£…äº† huskyï¼Œå› æ­¤ä¸Šè¿°å‘½ä»¤ç±»ä¼¼äºï¼š
node_modules/.bin/husky add .husky/pre-commit "npm test"

# å½“ç„¶ä¹Ÿå¯ä»¥å°† husky å‘½ä»¤æ”¾å…¥  package.json çš„ scripts å­—æ®µä¸­è¿›è¡Œæ‰§è¡Œ { "husky-add": "husky add" }
npm run husky-add .husky/pre-commit "npm test" 
```

> æ¸©é¦¨æç¤ºï¼šå¯ä»¥ç®€å•äº†è§£ä¸€ä¸‹ npx å’Œ npm çš„åŒºåˆ«ã€‚

é‡æ–°æŸ¥çœ‹ husky çš„ `lib/bin.js` å’Œ `lib/index.js` æ–‡ä»¶ï¼š

``` javascript
// lib/bin.js
#!/usr/bin/env node

"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const p = require("path");
const h = require("./");
function help(code) {
  console.log(Usage:
  husky install [dir] (default: .husky)
  husky uninstall
  husky set|add <file> [cmd]);
  process.exit(code);
}

// è§£æ husky add ä¸­çš„ add å‘½ä»¤
const [, , cmd, ...args] = process.argv;
const ln = args.length;
const [x, y] = args;
// husky add .husky/pre-commit "npm test"
// x ä¸ºé’©å­æ–‡ä»¶ .husky/pre-commit
// y ä¸ºé’©å­æ–‡ä»¶å¯¹åº”çš„å†…å®¹ "npm test"
const hook = (fn) => () => !ln || ln > 2 ? help(2) : fn(x, y);
const cmds = {
    // husky intall æŒ‡å‘äº† install å‡½æ•°ï¼ŒæŸ¥çœ‹ h å¯¹è±¡æ‰€åœ¨çš„ ./index.js æ–‡ä»¶
    install: () => (ln > 1 ? help(2) : h.install(x)),
    uninstall: h.uninstall,
    set: hook(h.set),
    // husky add æŒ‡å‘äº† h.add å‡½æ•°ï¼Œæœ€ç»ˆæ‰§è¡Œçš„æ˜¯ h.add(x, y)
    add: hook(h.add), 
    ['-v']: () => console.log(require(p.join(__dirname, '../package.json')).version),
};
try {
    cmds[cmd] ? cmds[cmd]() : help(0);
}
catch (e) {
    console.error(e instanceof Error ? husky - ${e.message} : e);
    process.exit(1);
}
```

æŸ¥çœ‹ `h.add` å‡½æ•°å¯¹åº”çš„`lib/index.js`ï¼š
  

``` javascript
// lib/index.js
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.uninstall = exports.add = exports.set = exports.install = void 0;
const cp = require("child_process");
const fs = require("fs");
const p = require("path");
const l = (msg) => console.log(husky - ${msg});
const git = (args) => cp.spawnSync('git', args, { stdio: 'inherit' });


function set(file, cmd) {
  const dir = p.dirname(file);
  // å¦‚æœ .hooks ç›®å½•ä¸å­˜åœ¨ï¼Œåˆ™æŠ¥é”™
  // æç¤ºæ‰§è¡Œ husky install åˆ›å»º .hooks ç›®å½•
  if (!fs.existsSync(dir)) {
    throw new Error(can't create hook, ${dir} directory doesn't exist (try running husky install));
  }
  // åœ¨ pre-commit é’©å­ä¸­å†™å…¥æ‰§è¡Œçš„ shell è„šæœ¬
  fs.writeFileSync(file, #!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

// è¿™é‡Œæ˜¯ npm test å†…å®¹
${cmd}
// æ³¨æ„è¿™é‡Œæ·»åŠ äº†æ–‡ä»¶çš„å¯æ‰§è¡Œæƒé™ï¼Œå¦åˆ™ git hook é’©å­æ‰§è¡Œæ—¶å› ä¸ºæ²¡æœ‰æ‰§è¡Œæƒé™è€Œå¤±æ•ˆ
, { mode: 0o0755 });
  l(created ${file});
}
exports.set = set;

// husky add .husky/pre-commit "npm test"
// file ä¸ºé’©å­æ–‡ä»¶ .husky/pre-commit
// cmd ä¸ºé’©å­æ–‡ä»¶å¯¹åº”çš„å†…å®¹ "npm test"
function add(file, cmd) {
  // å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œåˆ™è¿½åŠ å†…å®¹ï¼Œæ³¨æ„æ˜¯è¿½åŠ å†…å®¹
  if (fs.existsSync(file)) {
    fs.appendFileSync(file, ${cmd}\n);
    l(updated ${file});
  }
  else {
    // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°±æ‰§è¡Œ set å‡½æ•°
    set(file, cmd);
  }
}
exports.add = add;
```

æ‰§è¡Œ `husky add .husky/pre-commit "npm test"` çš„ä½œç”¨æ˜¯åœ¨ `.husky` ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª `pre-commit` é’©å­å†™å…¥éœ€è¦æ‰§è¡Œçš„ Shell å‘½ä»¤ï¼Œå¹¶ç»™æ–‡ä»¶æ·»åŠ å¯æ‰§è¡Œçš„æƒé™ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š

``` bash
â”œâ”€â”€ .husky
â”‚   â””â”€â”€ -           # _ ç›®å½•ä¸ä¼šæäº¤åˆ°è¿œç¨‹ä»“åº“ï¼Œ husky install è‡ªåŠ¨ç”Ÿæˆ
â”‚       â”œâ”€â”€ .gitignore
â”‚       â””â”€â”€ husky.sh
â”‚   â””â”€â”€ pre-commit  # æ‰§è¡Œ husky add ä¹‹åæ–°å¢çš„ Git é’©å­ pre-commit
â”œâ”€â”€ .vscode/                                                              
â”œâ”€â”€ node_modules/               
â”œâ”€â”€ build/      
â”œâ”€â”€ lib/          
â”œâ”€â”€ src/                 
â”œâ”€â”€ .eslintignore  
â”œâ”€â”€ eslintrc.js         
â”œâ”€â”€ .gitignore        
â”œâ”€â”€ README.md   
â”œâ”€â”€ package-lock.json        
â”œâ”€â”€ package.json         
â””â”€â”€ tsconfig.json 
```

æ­¤æ—¶å¦‚æœåœ¨ `package.json` ä¸­æ·»åŠ  `test` å‘½ä»¤ï¼š

``` json
  "scripts": {
    "prepare": "husky install",
    "husky-add": "husky add",
    // æ–°å¢ test å‘½ä»¤ï¼Œæ‰“å°æ”¾å¼ƒä¿¡æ¯å¹¶ä½¿ç”¨éé›¶å€¼é€€å‡º
    "test": "echo "æ”¾å¼ƒ commit æäº¤" && exit 2"
  },
```

æ‰§è¡Œ`git commit -m` ä¼šè§¦å‘ `pre-commit` é’©å­å¹¶è¿è¡Œ `test` å‘½ä»¤ï¼š

``` bash
# æ‰§è¡Œ
git add .
# æ‰§è¡Œ
git commit -m "feat: add husky"

# æ‰“å°
> micro-framework@1.0.6 test
> echo "æ”¾å¼ƒ commit æäº¤" && exit 2

æ”¾å¼ƒ commit æäº¤
# å¯ä»¥å‘ç° husky è¿é€€å‡ºç éƒ½æ•è·äº†ï¼Œé‚£ä¹ˆæ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿ
husky - pre-commit hook exited with code 2 (error)

# æ‰§è¡Œ
git status
# æ‰“å°
On branch test/husky
Changes to be committed:
  (use "git restore --staged <file>..." to unstage)
        new file:   .husky/pre-commit
        modified:   package-lock.json
        modified:   package.json
```

æ¥ä¸‹æ¥é‡ç‚¹æŸ¥çœ‹ä¸€ä¸‹ `pre-commit` é’©å­é‡Œçš„å†…å®¹ä¿¡æ¯ï¼š

``` bash
# Shebangï¼Œä½¿ç”¨ shell è§£æå™¨
#!/usr/bin/env sh

# åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†:  . å’Œ "$(dirname -- "$0")/_/husky.sh"
# ä½œç”¨ï¼šåœ¨ pre-commit ä¸­å°† .husky/_/husky.sh ä¸­çš„ shell æ‰§è¡Œè„šæœ¬æ‹¼æ¥åˆ°è¿™é‡Œæ‰§è¡Œ

# . å‘½ä»¤å’Œ source å‘½ä»¤ç›¸åŒï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ source "$(dirname -- "$0")/_/husky.sh"
# . è¡¨ç¤ºä¸äº§ç”Ÿæ–°çš„ shellï¼Œåœ¨å½“å‰ shell ä¸‹æ‰§è¡Œå‘½ä»¤ï¼Œå¯ä»¥å…±äº«åŒä¸€ä¸ª shell ä¸Šä¸‹æ–‡

# $(dirname -- "$0"): å½“å‰æ‰§è¡Œè„šæœ¬çš„çˆ¶ç›®å½• .husky
# å¯ä»¥ä½¿ç”¨ echo "$(dirname -- "$0")/_/husky.sh" éªŒè¯ä¸€ä¸‹æ˜¯å¦æ˜¯ .husky/_/husky.sh

. "$(dirname -- "$0")/_/husky.sh"

npm test
```

åœ¨ Mac ç”µè„‘ä¸­ï¼Œå¦‚æœæƒ³çŸ¥é“ Shell ä¸­å„ä¸ªå‘½ä»¤çš„ä½œç”¨ï¼Œå¯ä»¥ä½¿ç”¨ï¼š

``` bash
# å¦‚æœæƒ³æŸ¥è¯¢å…¶ä»–å‘½ä»¤ï¼Œä¾‹å¦‚ echoï¼Œåˆ™å°† source æ¢æˆ echo å³å¯
man bash | less -p "^       source"

# æ‰“å°
       source filename [arguments]
              Read and execute commands from filename in the current shell
              environment and return the exit status of the last command
              executed from filename.  If filename does not contain a slash,
              file names in PATH are used to find the directory containing
              filename.  The file searched for in PATH need not be executable.
              When bash is not in posix mode, the current directory is
              searched if no file is found in PATH.  If the sourcepath option
              to the shopt builtin command is turned off, the PATH is not
              searched.  If any arguments are supplied, they become the
              positional parameters when filename is executed.  Otherwise the
              positional parameters are unchanged.  The return status is the
              status of the last command exited within the script (0 if no
              commands are executed), and false if filename is not found or
              cannot be read.
```

> æ¸©é¦¨æç¤ºï¼šå¯ä»¥äº†è§£ä¸€ä¸‹[å¦‚ä½•æŸ¥è¯¢å„ä¸ªå‘½ä»¤çš„è§£é‡Š](https://stackoverflow.com/questions/22991942/where-to-view-man-pages-for-bash-builtin-commands)ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æŸ¥è¯¢å®˜æ–¹æ‰‹å†Œ [bash(1) - Linux man page](https://linux.die.net/man/1/bash)ã€‚

å¯ä»¥å‘ç° `pre-commit` é’©å­æ‰§è¡Œå¼€å‘è€…è®¾å®šçš„ `npm test` å‘½ä»¤ä¹‹å‰ï¼Œé¦–å…ˆéœ€è¦æ‰§è¡Œ`.huksy/_/husky.sh` è„šæœ¬ï¼š

``` bash
#!/usr/bin/env sh

# å¦‚æœä¸æ¸…æ¥š -z çš„ä½œç”¨ï¼Œå¯ä»¥å¿«é€Ÿé€šè¿‡ man bash | less -p "^       -z" äº†è§£å«ä¹‰
# -zï¼š True if the length of string is zero.
# å¦‚æœ husky_skip_init å˜é‡çš„å­—ç¬¦ä¸²é•¿åº¦ä¸º 0ï¼Œåˆ™æ¡ä»¶ä¸ºçœŸï¼Œé¦–æ¬¡æ‰§è¡Œ husky.sh æ—¶æ¡ä»¶ä¸ºçœŸ
if [ -z "$husky_skip_init" ]; then
  debug () {
    # å˜é‡ HUSKY_DEBUG=1 å¼€å¯ husky çš„ debug æ¨¡å¼
    if [ "$HUSKY_DEBUG" = "1" ]; then
      echo "husky (debug) - $1"
    fi
  }

  # hook_name:  .husky
  # æ³¨æ„æ‰§è¡Œç¯å¢ƒåœ¨ pre_commit è„šæœ¬ä¸­ï¼Œä¸æ˜¯åœ¨ husky.sh ä¸­
  readonly hook_name="$(basename -- "$0")"
  debug "starting $hook_name..."

  # å˜é‡ HUSKY=0 è·³è¿‡ git é’©å­æ‰§è¡Œ
  if [ "$HUSKY" = "0" ]; then
    debug "HUSKY env variable is set to 0, skipping hook"
    exit 0
  fi

  # é€šè¿‡åˆ›å»º ~/.huskyrc å¯ä»¥åœ¨ Git é’©å­æ‰§è¡Œå‰æ‰§è¡Œä¸€äº›å‘½ä»¤
  # å¯ä»¥ç†è§£ä¸º husky çš„é’©å­æ–‡ä»¶
  # ç¨å¾®æœ‰ç‚¹ç»•ï¼Œå°±æ˜¯æ‰§è¡Œ git hook ä¹‹å‰ï¼Œå…ˆæ‰§è¡Œ husky hook
  if [ -f ~/.huskyrc ]; then
    debug "sourcing ~/.huskyrc"
    . ~/.huskyrc
  fi


  # å°† husky_skip_init è®¾ç½®ä¸º 1
  # å†æ¬¡æ‰§è¡Œ husky.sh å°†ä¸ä¼šæ‰§è¡Œè¯¥æ–‡ä»¶æ‰€æœ‰å†…å®¹ï¼Œå› ä¸ºæ–‡ä»¶å¼€å¤´çš„ if [ -z "$husky_skip_init" ] ä¸æ»¡è¶³æ¡ä»¶
  readonly husky_skip_init=1
  export husky_skip_init
  
  # å†æ¬¡æ‰§è¡Œ pre-commit é’©å­ï¼Œä¸»è¦æ˜¯ä¸ºäº†æ‰§è¡Œ npm testï¼Œå› ä¸º husky.sh ä¸æ»¡è¶³æ¡ä»¶ä¼šè·³è¿‡æ‰§è¡Œ
  # sh: æ‰§è¡Œ shell è„šæœ¬ï¼Œç±»ä¼¼äº node index.js ä¸­çš„ node
  # -e: Exit immediately if a command exits with a non-zero status
  # $0: å½“å‰çš„è„šæœ¬å pre-commit
  # $@: æ‰§è¡Œçš„æ‰€æœ‰å‚æ•°
  # æ³¨æ„ shell çš„ä¸Šä¸‹æ–‡ä¸æ˜¯åœ¨ .husky/_/husky.sh ä¸­ï¼Œè€Œæ˜¯åœ¨ .husky/pre-commit ä¸­
  # å› æ­¤è¿™é‡Œå†æ¬¡æ‰§è¡Œçš„æ˜¯ pre-commit è„šæœ¬ï¼Œä¸æ˜¯ husky.sh è„šæœ¬
  sh -e "$0" "$@"
  # $?: ä¸Šè¿°å‘½ä»¤çš„æ‰§è¡ŒçŠ¶æ€ï¼Œä»è¿™é‡Œå¯ä»¥çŸ¥é“ husky å¦‚ä½•è·å–é€€å‡ºç å¹¶æ‰“å°ä¿¡æ¯
  exitCode="$?"

  if [ $exitCode != 0 ]; then
    echo "husky - $hook_name hook exited with code $exitCode (error)"
  fi

  if [ $exitCode = 127 ]; then
    echo "husky - command not found in PATH=$PATH"
  fi

  exit $exitCode
fi
```

å…¶ä¸­ `sh -e` ä¸­çš„ `-e` å‚æ•°å¯ä»¥é€šè¿‡ `sh --help` è·å–è§£é‡Šï¼š

``` bash
# æ‰§è¡Œ
sh --help     
# æ‰“å°
GNU bash, version 3.2.57(1)-release-(arm64-apple-darwin22)
Usage:        sh [GNU long option] [option] ...
sh [GNU long option] [option] script-file ...
GNU long options:
--debug
--debugger
--dump-po-strings
--dump-strings
--help
--init-file
--login
--noediting
--noprofile
--norc
--posix
--protected
--rcfile
--restricted
--verbose
--version
--wordexp
Shell options:
-irsD or -c command or -O shopt_option                (invocation only)
-abefhkmnptuvxBCHP or -o option
# é€šè¿‡è¯¥å‘½ä»¤æŸ¥è¯¢ CLI å‚æ•°
Type sh -c "help set" for more information about shell options.
# é€šè¿‡è¯¥å‘½ä»¤æŸ¥è¯¢å†…ç½®å‘½ä»¤
Type sh -c help for more information about shell builtin commands.
Use the bashbug command to report bugs.

# æ‰§è¡Œ
sh -c "help set"
# æ‰“å°
set: set [--abefhkmnptuvxBCHP] [-o option] [arg ...]
        -a  Mark variables which are modified or created for export.
        -b  Notify of job termination immediately.
        # æ‰¾åˆ° -e å‚æ•°çš„è§£é‡Šï¼šå¦‚æœå‘½ä»¤çš„é€€å‡ºçŠ¶æ€é 0 åˆ™ç«‹å³é€€å‡º
        # è¿™ä¸ªå’Œ Git é’©å­é€€å‡ºçš„éé›¶å€¼æ­£å¥½æ˜ å°„
        -e  Exit immediately if a command exits with a non-zero status.
        -f  Disable file name generation (globbing).
        -h  Remember the location of commands as they are looked up.
        -k  All assignment arguments are placed in the environment for a
            command, not just those that precede the command name.
        -m  Job control is enabled.
        -n  Read commands but do not execute them.
        -o option-name
            Set the variable corresponding to option-name:
                allexport    same as -a
                braceexpand  same as -B
                emacs        use an emacs-style line editing interface
                errexit      same as -e
                errtrace     same as -E
                functrace    same as -T
                hashall      same as -h
                histexpand   same as -H
                history      enable command history
                ignoreeof    the shell will not exit upon reading EOF
                interactive-comments
                             allow comments to appear in interactive commands
                keyword      same as -k
                monitor      same as -m
                noclobber    same as -C
                noexec       same as -n
                noglob       same as -f
                nolog        currently accepted but ignored
                notify       same as -b
                nounset      same as -u
                onecmd       same as -t
                physical     same as -P
                pipefail     the return value of a pipeline is the status of
                             the last command to exit with a non-zero status,
                             or zero if no command exited with a non-zero status
                posix        change the behavior of bash where the default
                             operation differs from the 1003.2 standard to
                             match the standard
                privileged   same as -p
                verbose      same as -v
                vi           use a vi-style line editing interface
                xtrace       same as -x
        -p  Turned on whenever the real and effective user ids do not match.
            Disables processing of the $ENV file and importing of shell
            functions.  Turning this option off causes the effective uid and
            gid to be set to the real uid and gid.
        -t  Exit after reading and executing one command.
        -u  Treat unset variables as an error when substituting.
        -v  Print shell input lines as they are read.
        -x  Print commands and their arguments as they are executed.
        -B  the shell will perform brace expansion
        -C  If set, disallow existing regular files to be overwritten
            by redirection of output.
        -E  If set, the ERR trap is inherited by shell functions.
        -H  Enable ! style history substitution.  This flag is on
            by default when the shell is interactive.
        -P  If set, do not follow symbolic links when executing commands
            such as cd which change the current directory.
        -T  If set, the DEBUG trap is inherited by shell functions.
        -   Assign any remaining arguments to the positional parameters.
            The -x and -v options are turned off.
    
    Using + rather than - causes these flags to be turned off.  The
    flags can also be used upon invocation of the shell.  The current
    set of flags may be found in $-.  The remaining n ARGs are positional
    parameters and are assigned, in order, to $1, $2, .. $n.  If no
    ARGs are given, all shell variables are printed.
```

> æ¸©é¦¨æç¤ºï¼šä¸€èˆ¬åœ¨è®¾è®¡ CLI å‘½ä»¤æ—¶éƒ½ä¼šé…å¥— `-- help` ç”¨äºæŸ¥è¯¢ CLI å‚æ•°çš„å«ä¹‰ï¼Œä¾‹å¦‚ `npx husky --help` ä¼šæ‰“å°æ‰€æœ‰çš„ husky å‘½ä»¤çš„å‚æ•°ä¿¡æ¯ã€‚

`husky.sh` ä¸»è¦æ˜¯ä¸ºäº†è¯†åˆ« husky å‘½ä»¤çš„å˜é‡å¹¶åšå‡ºç›¸åº”çš„åˆå§‹åŒ–å¤„ç†ï¼ŒåŒ…æ‹¬ï¼š

-   è®¾ç½®ç¯å¢ƒå˜é‡è·³è¿‡ Git é’©å­çš„æ‰§è¡Œï¼›
-   è®¾ç½®ç¯å¢ƒå˜é‡æ‰“å°è°ƒè¯•ä¿¡æ¯ï¼›
-   æ‰§è¡Œ `.huskyrc`ï¼Œè¯¥æ–‡ä»¶å¯ä»¥ç†è§£ä¸º husky çš„é’©å­è„šæœ¬ã€‚

å› æ­¤çœŸæ­£æ‰§è¡Œä¸€æ¬¡ `pre-commit` çš„æµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7c2e611905184e2a953559221f07861b~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1473&h=681&e=jpg&b=fffdfd)

> æ¸©é¦¨æç¤ºï¼šå†æ¬¡æ‰§è¡Œ `pre-commit` å¹¶ä¸æ˜¯è·³è¿‡æ•´ä¸ª `husky.sh` çš„æ‰§è¡Œè„šæœ¬ï¼Œè€Œæ˜¯è·³è¿‡åˆå§‹åŒ–å¤„ç†éƒ¨åˆ†ï¼Œå³ `husky_skip_init` å˜é‡å¯¹åº”çš„ä»£ç ï¼Œæœ€ç»ˆåœ¨ `husky.sh` ä¸­è¿˜ä¼šè·å–ç”¨æˆ·è‡ªå®šä¹‰è„šæœ¬æ‰§è¡Œç»“æœçš„é€€å‡ºç ã€‚

### Lint Staged é…ç½®

åœ¨ husky ä¸­æˆåŠŸé…ç½®äº† `pre-commit` é’©å­ï¼Œå¹¶ä¸”é€šè¿‡è®¾è®¡ `npm test` è„šæœ¬å¼ºåˆ¶æ”¾å¼ƒäº†æ¯ä¸€æ¬¡çš„ `git commit` æ“ä½œï¼Œæ¥ä¸‹æ¥å¯ä»¥å°† `npm test` è„šæœ¬æ”¹ä¸ºæ‰§è¡Œ `lint` è¿›è¡Œæµ‹è¯•ï¼š

``` bash
# ä¿®æ”¹ .husky/pre-commit è„šæœ¬
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# å°† npm test æ›´æ”¹ä¸º npm run lint
npm run lint
```

å‡è®¾æ­¤æ—¶ä¿®æ”¹ `src/index.ts`ï¼Œä½¿å®ƒäº§ç”Ÿ ESLint é”™è¯¯ï¼š

``` typescript
export * from "./comm/comm1";
export * from "./comm/comm2";
export * from "./core/core";
export * from "./nav/nav";
export * from "./opt/opt1";
export * from "./opt/opt2";
export * from "./sandbox/sandbox1";
export * from "./sandbox/sandbox2";
export * from "./sandbox/sandbox3";

// å˜é‡ b æ²¡æœ‰å£°æ˜ç±»å‹
export function add(a: number, b) {
  // error  Unsafe return of an any typed value                                                   @typescript-eslint/no-unsafe-return
  // error  Operands of '+' operation with any is possible only with string, number, bigint or any  @typescript-eslint/restrict-plus-operands
  return a + b;
}
```

è¿›è¡Œä»£ç æäº¤æ“ä½œï¼š

``` bash
# æ‰§è¡Œ
git add .
# æ‰§è¡Œ
git commit -m "feat: add lint git hook"

# æ‰“å°
> micro-framework@1.0.6 lint
> eslint --ext .ts src


/Users/zhuxiankang/Desktop/Github/micro-framework/src/index.ts
  15:3   error  Unsafe return of an `any` typed value                                                   @typescript-eslint/no-unsafe-return
  15:10  error  Operands of '+' operation with any is possible only with string, number, bigint or any  @typescript-eslint/restrict-plus-operands

âœ– 2 problems (2 errors, 0 warnings)

husky - pre-commit hook exited with code 1 (error)
```

> æ¸©é¦¨æç¤ºï¼šæ‰§è¡Œ ESLint æ—¶å¦‚æœå­˜åœ¨é”™è¯¯ç±»å‹ï¼Œåˆ™ ESLint çš„æ‰§è¡Œè¿›ç¨‹ä¼šé€€å‡ºï¼Œé€€å‡ºç ä¸º 1ï¼Œæ­£å¥½å¯ä»¥æ˜ å°„ Git é’©å­çš„éé›¶å€¼é€€å‡ºç æ”¾å¼ƒæ‰§è¡Œã€‚
>
> å¦‚æœ ESLint åªå­˜åœ¨è­¦å‘Šç±»å‹ï¼Œåˆ™ä¸ä¼šå½±å“é€€å‡ºç ï¼Œä¸ä¼šé˜»æ–­ Git é’©å­çš„æ­£å¸¸æ‰§è¡Œã€‚å½“ç„¶å¦‚æœå¸Œæœ›åœ¨ ESLint å­˜åœ¨è­¦å‘Šçš„æƒ…å†µä¸‹ä¹Ÿæ”¾å¼ƒ `git commit` æ‰§è¡Œï¼Œå¯ä»¥ç»™ ESLint è®¾ç½® CLI å‚æ•° `--max-warnings` çš„å€¼ä¸º 0ï¼Œæ­¤æ—¶å¦‚æœå­˜åœ¨è­¦å‘Šï¼Œåˆ™ä¼šä½¿ ESLint ä»¥éé›¶å€¼é€€å‡ºï¼Œå…·ä½“å¯ä»¥æŸ¥çœ‹ [ESLint / Exit Codes](https://eslint.org/docs/latest/use/command-line-interface#exit-codes)ã€‚

å…¨é‡æ‰§è¡Œ ESLint æ ¡éªŒå¯¹äºå¤§å‹é¡¹ç›®è€Œè¨€éœ€è¦èŠ±è´¹ä¸å°‘æ—¶é—´ï¼Œç†è®ºä¸Šåªéœ€è¦ç¡®ä¿æäº¤åˆ°è¿œç¨‹ä»“åº“çš„å˜æ›´ä»£ç å¯ä»¥é€šè¿‡ ESLint æ ¡éªŒå³å¯ï¼Œè€Œæ²¡æœ‰æ”¹åŠ¨çš„ä»£ç åˆ™ä¸éœ€è¦è¿›è¡Œ ESLint æ ¡éªŒã€‚ä¸ºæ­¤å¯ä»¥ä½¿ç”¨ [lint-staged](https://github.com/okonet/lint-staged) å·¥å…·ï¼š

``` bash
# å›ºå®šä½¿ç”¨ 13.2.0 ç‰ˆæœ¬
npm install --save-dev lint-staged
```

> æ¸©é¦¨æç¤ºï¼šç¤ºä¾‹æºç å¯ä»¥ä» micro-framework çš„ [demo/lint-staged](https://github.com/ziyi2/micro-framework/tree/demo/lint-staged) åˆ†æ”¯è·å–ã€‚

å®‰è£…å®Œæˆåï¼Œä»ç„¶å¯ä»¥äº†è§£ä¸€ä¸‹å®ç°åŸç†ï¼š

``` json
// node_modules/lint-staged/package.json

{
  "bin": "./bin/lint-staged.js"
}

// ä¸Šè¿°ä»£ç ç­‰åŒäº
{
  "bin":  {
    // å¯¹å¤–æŠ›å‡ºäº† lint-staged å‘½ä»¤ï¼Œå¯ä»¥é€šè¿‡ node_modules/bin æŸ¥çœ‹
    "lint-staged": "./bin/lint-staged.js"
  }
}

// bin/lint-staged.js

// è§£æ lint-staged çš„å‚æ•°å¹¶æ‰§è¡Œç›¸åº”çš„é€»è¾‘
```

ç”±äº lint-staged å†…éƒ¨çš„å®ç°ä»£ç ç›¸å¯¹è¾ƒå¤šï¼Œè¿™é‡Œä¸å†è¯¦ç»†è®²è¿°å…·ä½“çš„å®ç°ï¼Œå¤§è‡´çš„å®ç°é€»è¾‘å¦‚ä¸‹æ‰€ç¤ºï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/df500d0495a04d19acf081fe18a6420d~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1220&h=144&e=jpg&b=fefefe)

  


> æ¸©é¦¨æç¤ºï¼šæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥äº†è§£ä¸€ä¸‹ lint-staged å¦‚ä½•è®¡ç®—æš‚å­˜åŒºçš„ä»£ç ï¼Œè¯¥å†…å®¹çš„å­¦ä¹ æœ‰åŠ©äºè‡ªå·±è®¾è®¡ä¸€äº›æ„å»ºå’Œå‘å¸ƒè„šæœ¬çš„æƒ…å†µåˆ¤æ–­ï¼Œä¾‹å¦‚åœ¨**å·¥ç¨‹è®¾è®¡ï¼šç‰ˆæœ¬å‘å¸ƒ**çš„é‚£èŠ‚è¯¾ä¸­ï¼Œä½¿ç”¨äº† `git diff` æ¥åˆ¤æ–­æœ¬åœ°å’Œè¿œç¨‹ master åˆ†æ”¯çš„å†…å®¹æ˜¯å¦ä¸€è‡´ã€‚

ä¸ºäº†æ‰§è¡Œ lint-stagedï¼Œé¦–å…ˆéœ€è¦æ”¹é€  `pre-commit` é’©å­çš„è„šæœ¬å‘½ä»¤ï¼š

``` bash
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# å°† npm run lint æ”¹ä¸º npx lint-staged
# ä¹‹å‰å·²ç»ä»‹ç»è¿‡ npx å‘½ä»¤ï¼Œä¼šä¼˜å…ˆä» node_modules/bin ç›®å½•ä¸‹å¯»æ‰¾ lint-staged å‘½ä»¤
# https://github.com/okonet/lint-staged#examples
npx lint-staged
```

å…¶æ¬¡éœ€è¦è®¾ç½® lint-staged çš„é…ç½®ä¿¡æ¯ï¼Œæ ¹æ®[å®˜æ–¹æ–‡æ¡£](https://github.com/okonet/lint-staged#configuration)çš„è¯´æ˜å‘ç°æœ‰å¤šç§é…ç½®æ–¹å¼ï¼Œæœ¬æ–‡é‡‡ç”¨å’Œ ESLint ä»¥åŠ Prettier ç±»ä¼¼çš„é…ç½®æ–¹å¼ï¼š

``` javascript
// .lintstagedrc.js
// å’Œä¹‹å‰çš„é…ç½®æ–‡ä»¶ .eslintrc.js ä»¥åŠ .prettierrc.js ç±»ä¼¼
// è¿™é‡Œä¸æ¨èå°†é…ç½®ä¿¡æ¯æ”¾åœ¨ package.json ä¸­ï¼Œç‹¬ç«‹çš„é…ç½®æ–‡ä»¶æ›´å¥½ç»´æŠ¤

module.exports = {
  // æ³¨æ„å’Œ package.json ä¸­çš„ {  "lint": "eslint --ext .ts src" } ä¿æŒä¸€è‡´
  'src/**/*.ts': 'eslint',
};
```

> æ¸©é¦¨æç¤ºï¼šéœ€è¦æ³¨æ„ ESLint çš„é…ç½®åŒ…æ‹¬ï¼šVS Code çš„é…ç½®ã€`npm run lint` å‘½ä»¤çš„é…ç½®ä»¥åŠ lint-staged çš„é…ç½®ï¼Œç†è®ºä¸Šä¸‰è€…çš„æ ¡éªŒèŒƒå›´åº”è¯¥ä¸€è‡´ï¼Œä¾‹å¦‚æœ¬æ–‡é…ç½®ä¸‰è€…çš„ç”Ÿæ•ˆèŒƒå›´éƒ½æ˜¯ `src` ç›®å½•ä¸‹çš„ TypeScript æ–‡ä»¶ã€‚

  


æ‰§è¡Œ lint-staged å‘½ä»¤åï¼Œä¼šè¯»å– `lintstagedrc.js` ä¸­çš„é…ç½®ï¼Œå¹¶æ ¹æ®è·å–çš„æš‚å­˜åŒºæ–‡ä»¶è¿›è¡Œç­›é€‰ï¼Œä¾‹å¦‚ä¸Šè¿°çš„ `glob` åŒ¹é…æ¨¡å¼ `src/**/*.ts` ä¼šä½¿ä¸åœ¨ `src` ç›®å½•ä¸‹çš„ TypeScript æ–‡ä»¶è¢«å¿½ç•¥ã€‚ lint-staged åŒ¹é…éœ€è¦æ ¡éªŒçš„æ–‡ä»¶åˆ—è¡¨ä¹‹åï¼Œä¼šå°†æ–‡ä»¶è¿½åŠ åˆ°å¯¹åº”çš„ ESLint å‘½ä»¤åé¢ï¼Œä¾‹å¦‚åŒ¹é…åˆ°äº† `src/index.ts` å’Œ `src/core/core.ts`ï¼Œé‚£ä¹ˆæœ€ç»ˆçš„æ‰§è¡Œå‘½ä»¤ä¸ºï¼š

``` bash
# eslint --ext .ts src: æ‰§è¡Œæ‰€æœ‰ src ç›®å½•ä¸‹çš„æ ¡éªŒ
# eslint src/core/core.ts src/index.ts: åªæ‰§è¡Œä¸¤ä¸ªå˜æ›´æ–‡ä»¶çš„æ ¡éªŒ
eslint src/add.ts src/index.ts
```

æˆ‘ä»¬ä»ç„¶ä¿®æ”¹ `src/index.ts`ï¼Œä½¿å®ƒäº§ç”Ÿ ESLint é”™è¯¯ï¼š

``` typescript
export * from "./comm/comm1";
export * from "./comm/comm2";
export * from "./core/core";
export * from "./nav/nav";
export * from "./opt/opt1";
export * from "./opt/opt2";
export * from "./sandbox/sandbox1";
export * from "./sandbox/sandbox2";
export * from "./sandbox/sandbox3";

// å˜é‡ b æ²¡æœ‰å£°æ˜ç±»å‹
export function add(a: number, b) {
  // error  Unsafe return of an any typed value                                                   @typescript-eslint/no-unsafe-return
  // error  Operands of '+' operation with any is possible only with string, number, bigint or any  @typescript-eslint/restrict-plus-operands
  return a + b;
}
```

é‡æ–°æ‰§è¡Œä»£ç çš„æäº¤æ“ä½œï¼š

``` bash
# æ‰§è¡Œ
git add .  
# æ‰§è¡Œ
git commit -m "feat: add lint git hook"
âœ” Preparing lint-staged...
â¯ Running tasks for staged files...
  # å¯ä»¥å‘ç°è¯»å–äº† .lintstagedrc.js æ–‡ä»¶
  â¯ .lintstagedrc.js â€” 6 files
    â¯ src/**/*.ts â€” 1 file
      # æ ¡éªŒå¤±è´¥
      âœ– eslint [FAILED]
â†“ Skipped because of errors from tasks. [SKIPPED]
âœ” Reverting to original state because of errors...
âœ” Cleaning up temporary files...

âœ– eslint:

/Users/zhuxiankang/Desktop/Github/micro-framework/src/index.ts
  15:3   error  Unsafe return of an `any` typed value                                                   @typescript-eslint/no-unsafe-return
  15:10  error  Operands of '+' operation with any is possible only with string, number, bigint or any  @typescript-eslint/restrict-plus-operands

âœ– 2 problems (2 errors, 0 warnings)

# husky ä¸­çš„é€€å‡ºæ‰§è¡Œ
husky - pre-commit hook exited with code 1 (error)
```

è‡³æ­¤ husky å’Œ lint-staged å…¨éƒ¨é…ç½®å®Œæˆã€‚

## å›¢é˜Ÿåä½œ

é…ç½®å®Œæˆåï¼Œæœ€ä¸»è¦çš„æ˜¯æµ‹è¯•å›¢é˜Ÿæˆå‘˜å…‹éš†è¯¥é¡¹ç›®åæ˜¯å¦ä¼šç”Ÿæ•ˆ Git é’©å­ï¼Œè¿™é‡Œå°†æœ¬åœ°é¡¹ç›®è¿›è¡Œåˆ é™¤å¹¶é‡æ–°è¿›è¡Œå…‹éš†å®‰è£…ï¼š

``` bash
# å…‹éš†ä»“åº“
git clone https://github.com/ziyi2/micro-framework.git
# è¿›å…¥ä»“åº“å¹¶åˆ‡æ¢åˆ†æ”¯
cd micro-framework
git checkout demo/lint-staged
# å®‰è£…ä¾èµ–
npm i
# æ‰“å°ï¼Œé»˜è®¤ä¼šè§¦å‘ prepare é’©å­æ‰§è¡Œ husky install
> micro-framework@1.0.6 prepare
> husky install

husky - Git hooks installed
```

æ‰§è¡Œ `npm i` åï¼Œé»˜è®¤ä¼šè§¦å‘ NPM Script çš„ `prepare` é’©å­è‡ªåŠ¨æ‰§è¡Œ `husky install` ç”Ÿæˆ `.husky/_` ç›®å½•ï¼Œå¹¶æ›´æ”¹æœ¬åœ°çš„ Git é’©å­ç›®å½•ä¸º `.husky`ï¼Œç”±äº `.husky/pre-commit` è¢«æäº¤åˆ°äº†è¿œç¨‹ä»“åº“ï¼Œå› æ­¤å…‹éš†çš„æ—¶å€™ä¼šå½¢æˆå›¢é˜Ÿå…±äº«ï¼Œä¸éœ€è¦å†æ‰§è¡Œ `husky add` æ“ä½œã€‚

åœ¨ `src/index.ts` ä¸­éšä¾¿è®¾è®¡ä¸€äº›å…·å¤‡ ESLint æ ¡éªŒé”™è¯¯çš„ä»£ç å¹¶å°è¯•æäº¤ï¼Œä¼šå‘ç°é…ç½®çš„ Husky å’Œ Lint Staged å¯ä»¥ç”Ÿæ•ˆï¼Œå› æ­¤åœ¨å¼€å‘è€…ä¸éœ€è¦åšä»»ä½•é…ç½®çš„æƒ…å†µä¸‹ï¼Œå°±ç”Ÿæ•ˆäº† Git æäº¤çš„ ESLint æ ¡éªŒåŠŸèƒ½ã€‚

## å°ç»“

æœ¬èŠ‚è¯¾ä¸»è¦è®²è§£äº† Git é’©å­çš„åŸºç¡€çŸ¥è¯†ï¼ŒåŒ…æ‹¬é’©å­çš„ç±»å‹å’Œä½œç”¨ç­‰ï¼Œé¢å¤–è®²è§£äº† Shebang çŸ¥è¯†ç‚¹ï¼Œè¯¥çŸ¥è¯†åœ¨ CLI å·¥å…·çš„è®¾è®¡ä¸­éå¸¸é‡è¦ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œä½¿å¤§å®¶äº†è§£äº†ç¤¾åŒºçš„ä¸€äº› Git é’©å­å·¥å…·ï¼Œå¹¶é‡ç‚¹è®²è§£äº† Husky çš„åŸç†ä»¥åŠ Lint Staged çš„é…ç½®è¿‡ç¨‹ï¼Œä»è€Œå¯ä»¥ç¡®ä¿æ•´ä¸ªå›¢é˜Ÿçš„é¡¹ç›®åœ¨æäº¤ä»£ç æ—¶èƒ½å¤Ÿå¼ºåˆ¶æ‰§è¡Œ ESLint æ ¡éªŒã€‚åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä¼šè®²è§£å¦‚ä½•ä½¿ç”¨å·¥å…·è‡ªåŠ¨ç”Ÿæˆåº“åŒ…å‘å¸ƒçš„å˜æ›´æ—¥å¿—ï¼Œä»¥åŠå¦‚ä½•è§„èŒƒä»£ç çš„æäº¤è¯´æ˜ã€‚