### æœ¬èµ„æºç”± itjc8.com æ”¶é›†æ•´ç†
# åº”ç”¨ 7ï¼šä¸€æ¯›ä¸æ‹” â€”â€” æ¼æ–—é™æµ

æ¼æ–—é™æµæ˜¯æœ€å¸¸ç”¨çš„é™æµæ–¹æ³•ä¹‹ä¸€ï¼Œé¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªç®—æ³•çš„çµæ„Ÿæºäºæ¼æ–—ï¼ˆfunnelï¼‰çš„ç»“æ„ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/10/164847a37cfcea2e?w=730&h=320&f=png&s=73710)

æ¼æ–—çš„å®¹é‡æ˜¯æœ‰é™çš„ï¼Œå¦‚æœå°†æ¼å˜´å µä½ï¼Œç„¶åä¸€ç›´å¾€é‡Œé¢çŒæ°´ï¼Œå®ƒå°±ä¼šå˜æ»¡ï¼Œç›´è‡³å†ä¹Ÿè£…ä¸è¿›å»ã€‚å¦‚æœå°†æ¼å˜´æ”¾å¼€ï¼Œæ°´å°±ä¼šå¾€ä¸‹æµï¼Œæµèµ°ä¸€éƒ¨åˆ†ä¹‹åï¼Œå°±åˆå¯ä»¥ç»§ç»­å¾€é‡Œé¢çŒæ°´ã€‚å¦‚æœæ¼å˜´æµæ°´çš„é€Ÿç‡å¤§äºçŒæ°´çš„é€Ÿç‡ï¼Œé‚£ä¹ˆæ¼æ–—æ°¸è¿œéƒ½è£…ä¸æ»¡ã€‚å¦‚æœæ¼å˜´æµæ°´é€Ÿç‡å°äºçŒæ°´çš„é€Ÿç‡ï¼Œé‚£ä¹ˆä¸€æ—¦æ¼æ–—æ»¡äº†ï¼ŒçŒæ°´å°±éœ€è¦æš‚åœå¹¶ç­‰å¾…æ¼æ–—è…¾ç©ºã€‚

![](https://user-gold-cdn.xitu.io/2018/7/11/16487813367a459d?w=483&h=174&f=png&s=30383)

æ‰€ä»¥ï¼Œæ¼æ–—çš„å‰©ä½™ç©ºé—´å°±ä»£è¡¨ç€å½“å‰è¡Œä¸ºå¯ä»¥æŒç»­è¿›è¡Œçš„æ•°é‡ï¼Œæ¼å˜´çš„æµæ°´é€Ÿç‡ä»£è¡¨ç€ç³»ç»Ÿå…è®¸è¯¥è¡Œä¸ºçš„æœ€å¤§é¢‘ç‡ã€‚ä¸‹é¢æˆ‘ä»¬ä½¿ç”¨ä»£ç æ¥æè¿°å•æœºæ¼æ–—ç®—æ³•ã€‚

```py
# coding: utf8

import time

class Funnel(object):

    def __init__(self, capacity, leaking_rate):
        self.capacity = capacity  # æ¼æ–—å®¹é‡
        self.leaking_rate = leaking_rate  # æ¼å˜´æµæ°´é€Ÿç‡
        self.left_quota = capacity  # æ¼æ–—å‰©ä½™ç©ºé—´
        self.leaking_ts = time.time()  # ä¸Šä¸€æ¬¡æ¼æ°´æ—¶é—´

    def make_space(self):
        now_ts = time.time()
        delta_ts = now_ts - self.leaking_ts  # è·ç¦»ä¸Šä¸€æ¬¡æ¼æ°´è¿‡å»äº†å¤šä¹…
        delta_quota = delta_ts * self.leaking_rate  # åˆå¯ä»¥è…¾å‡ºä¸å°‘ç©ºé—´äº†
        if delta_quota < 1:  # è…¾çš„ç©ºé—´å¤ªå°‘ï¼Œé‚£å°±ç­‰ä¸‹æ¬¡å§
            return
        self.left_quota += delta_quota  # å¢åŠ å‰©ä½™ç©ºé—´
        self.leaking_ts = now_ts  # è®°å½•æ¼æ°´æ—¶é—´
        if self.left_quota > self.capacity:  # å‰©ä½™ç©ºé—´ä¸å¾—é«˜äºå®¹é‡
            self.left_quota = self.capacity

    def watering(self, quota):
        self.make_space()
        if self.left_quota >= quota:  # åˆ¤æ–­å‰©ä½™ç©ºé—´æ˜¯å¦è¶³å¤Ÿ
            self.left_quota -= quota
            return True
        return False


funnels = {}  # æ‰€æœ‰çš„æ¼æ–—

# capacity  æ¼æ–—å®¹é‡
# leaking_rate æ¼å˜´æµæ°´é€Ÿç‡ quota/s
def is_action_allowed(
        user_id, action_key, capacity, leaking_rate):
    key = '%s:%s' % (user_id, action_key)
    funnel = funnels.get(key)
    if not funnel:
        funnel = Funnel(capacity, leaking_rate)
        funnels[key] = funnel
    return funnel.watering(1)


for i in range(20):
    print is_action_allowed('laoqian', 'reply', 15, 0.5)
```
å†æä¾›ä¸€ä¸ª Java ç‰ˆæœ¬çš„ï¼š
```java
public class FunnelRateLimiter {

  static class Funnel {
    int capacity;
    float leakingRate;
    int leftQuota;
    long leakingTs;

    public Funnel(int capacity, float leakingRate) {
      this.capacity = capacity;
      this.leakingRate = leakingRate;
      this.leftQuota = capacity;
      this.leakingTs = System.currentTimeMillis();
    }

    void makeSpace() {
      long nowTs = System.currentTimeMillis();
      long deltaTs = nowTs - leakingTs;
      int deltaQuota = (int) (deltaTs * leakingRate);
      if (deltaQuota < 0) { // é—´éš”æ—¶é—´å¤ªé•¿ï¼Œæ•´æ•°æ•°å­—è¿‡å¤§æº¢å‡º
        this.leftQuota = capacity;
        this.leakingTs = nowTs;
        return;
      }
      if (deltaQuota < 1) { // è…¾å‡ºç©ºé—´å¤ªå°ï¼Œæœ€å°å•ä½æ˜¯1
        return;
      }
      this.leftQuota += deltaQuota;
      this.leakingTs = nowTs;
      if (this.leftQuota > this.capacity) {
        this.leftQuota = this.capacity;
      }
    }

    boolean watering(int quota) {
      makeSpace();
      if (this.leftQuota >= quota) {
        this.leftQuota -= quota;
        return true;
      }
      return false;
    }
  }

  private Map<String, Funnel> funnels = new HashMap<>();

  public boolean isActionAllowed(String userId, String actionKey, int capacity, float leakingRate) {
    String key = String.format("%s:%s", userId, actionKey);
    Funnel funnel = funnels.get(key);
    if (funnel == null) {
      funnel = new Funnel(capacity, leakingRate);
      funnels.put(key, funnel);
    }
    return funnel.watering(1); // éœ€è¦1ä¸ªquota
  }
}
```
Funnel å¯¹è±¡çš„ make_space æ–¹æ³•æ˜¯æ¼æ–—ç®—æ³•çš„æ ¸å¿ƒï¼Œå…¶åœ¨æ¯æ¬¡çŒæ°´å‰éƒ½ä¼šè¢«è°ƒç”¨ä»¥è§¦å‘æ¼æ°´ï¼Œç»™æ¼æ–—è…¾å‡ºç©ºé—´æ¥ã€‚èƒ½è…¾å‡ºå¤šå°‘ç©ºé—´å–å†³äºè¿‡å»äº†å¤šä¹…ä»¥åŠæµæ°´çš„é€Ÿç‡ã€‚Funnel å¯¹è±¡å æ®çš„ç©ºé—´å¤§å°ä¸å†å’Œè¡Œä¸ºçš„é¢‘ç‡æˆæ­£æ¯”ï¼Œå®ƒçš„ç©ºé—´å ç”¨æ˜¯ä¸€ä¸ªå¸¸é‡ã€‚

é—®é¢˜æ¥äº†ï¼Œåˆ†å¸ƒå¼çš„æ¼æ–—ç®—æ³•è¯¥å¦‚ä½•å®ç°ï¼Ÿèƒ½ä¸èƒ½ä½¿ç”¨ Redis çš„åŸºç¡€æ•°æ®ç»“æ„æ¥æå®šï¼Ÿ

æˆ‘ä»¬è§‚å¯Ÿ Funnel å¯¹è±¡çš„å‡ ä¸ªå­—æ®µï¼Œæˆ‘ä»¬å‘ç°å¯ä»¥å°† Funnel å¯¹è±¡çš„å†…å®¹æŒ‰å­—æ®µå­˜å‚¨åˆ°ä¸€ä¸ª hash ç»“æ„ä¸­ï¼ŒçŒæ°´çš„æ—¶å€™å°† hash ç»“æ„çš„å­—æ®µå–å‡ºæ¥è¿›è¡Œé€»è¾‘è¿ç®—åï¼Œå†å°†æ–°å€¼å›å¡«åˆ° hash ç»“æ„ä¸­å°±å®Œæˆäº†ä¸€æ¬¡è¡Œä¸ºé¢‘åº¦çš„æ£€æµ‹ã€‚

ä½†æ˜¯æœ‰ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æ— æ³•ä¿è¯æ•´ä¸ªè¿‡ç¨‹çš„åŸå­æ€§ã€‚ä» hash ç»“æ„ä¸­å–å€¼ï¼Œç„¶ååœ¨å†…å­˜é‡Œè¿ç®—ï¼Œå†å›å¡«åˆ° hash ç»“æ„ï¼Œè¿™ä¸‰ä¸ªè¿‡ç¨‹æ— æ³•åŸå­åŒ–ï¼Œæ„å‘³ç€éœ€è¦è¿›è¡Œé€‚å½“çš„åŠ é”æ§åˆ¶ã€‚è€Œä¸€æ—¦åŠ é”ï¼Œå°±æ„å‘³ç€ä¼šæœ‰åŠ é”å¤±è´¥ï¼ŒåŠ é”å¤±è´¥å°±éœ€è¦é€‰æ‹©é‡è¯•æˆ–è€…æ”¾å¼ƒã€‚

å¦‚æœé‡è¯•çš„è¯ï¼Œå°±ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚å¦‚æœæ”¾å¼ƒçš„è¯ï¼Œå°±ä¼šå½±å“ç”¨æˆ·ä½“éªŒã€‚åŒæ—¶ï¼Œä»£ç çš„å¤æ‚åº¦ä¹Ÿè·Ÿç€å‡é«˜å¾ˆå¤šã€‚è¿™çœŸæ˜¯ä¸ªè‰°éš¾çš„é€‰æ‹©ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼ŸRedis-Cell æ•‘æ˜Ÿæ¥äº†ï¼

## Redis-Cell

Redis 4.0 æä¾›äº†ä¸€ä¸ªé™æµ Redis æ¨¡å—ï¼Œå®ƒå« redis-cellã€‚è¯¥æ¨¡å—ä¹Ÿä½¿ç”¨äº†æ¼æ–—ç®—æ³•ï¼Œå¹¶æä¾›äº†åŸå­çš„é™æµæŒ‡ä»¤ã€‚æœ‰äº†è¿™ä¸ªæ¨¡å—ï¼Œé™æµé—®é¢˜å°±éå¸¸ç®€å•äº†ã€‚

![](https://user-gold-cdn.xitu.io/2018/7/11/1648780927d6f4ec?w=522&h=202&f=png&s=32765)

è¯¥æ¨¡å—åªæœ‰1æ¡æŒ‡ä»¤```cl.throttle```ï¼Œå®ƒçš„å‚æ•°å’Œè¿”å›å€¼éƒ½ç•¥æ˜¾å¤æ‚ï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªæŒ‡ä»¤å…·ä½“è¯¥å¦‚ä½•ä½¿ç”¨ã€‚
```
> cl.throttle laoqian:reply 15 30 60 1
                      â–²     â–²  â–²  â–²  â–²
                      |     |  |  |  â””â”€â”€â”€â”€â”€ need 1 quota (å¯é€‰å‚æ•°ï¼Œé»˜è®¤å€¼ä¹Ÿæ˜¯1)
                      |     |  â””â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€ 30 operations / 60 seconds è¿™æ˜¯æ¼æ°´é€Ÿç‡
                      |     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 15 capacity è¿™æ˜¯æ¼æ–—å®¹é‡
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ key laoqian
```
ä¸Šé¢è¿™ä¸ªæŒ‡ä»¤çš„æ„æ€æ˜¯å…è®¸ã€Œç”¨æˆ·è€é’±å›å¤è¡Œä¸ºã€çš„é¢‘ç‡ä¸ºæ¯ 60s æœ€å¤š 30 æ¬¡(æ¼æ°´é€Ÿç‡)ï¼Œæ¼æ–—çš„åˆå§‹å®¹é‡ä¸º 15ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€å¼€å§‹å¯ä»¥è¿ç»­å›å¤ 15 ä¸ªå¸–å­ï¼Œç„¶åæ‰å¼€å§‹å—æ¼æ°´é€Ÿç‡çš„å½±å“ã€‚æˆ‘ä»¬çœ‹åˆ°è¿™ä¸ªæŒ‡ä»¤ä¸­æ¼æ°´é€Ÿç‡å˜æˆäº† 2 ä¸ªå‚æ•°ï¼Œæ›¿ä»£äº†ä¹‹å‰çš„å•ä¸ªæµ®ç‚¹æ•°ã€‚ç”¨ä¸¤ä¸ªå‚æ•°ç›¸é™¤çš„ç»“æœæ¥è¡¨è¾¾æ¼æ°´é€Ÿç‡ç›¸å¯¹å•ä¸ªæµ®ç‚¹æ•°è¦æ›´åŠ ç›´è§‚ä¸€äº›ã€‚
```
> cl.throttle laoqian:reply 15 30 60
1) (integer) 0   # 0 è¡¨ç¤ºå…è®¸ï¼Œ1è¡¨ç¤ºæ‹’ç»
2) (integer) 15  # æ¼æ–—å®¹é‡capacity
3) (integer) 14  # æ¼æ–—å‰©ä½™ç©ºé—´left_quota
4) (integer) -1  # å¦‚æœæ‹’ç»äº†ï¼Œéœ€è¦å¤šé•¿æ—¶é—´åå†è¯•(æ¼æ–—æœ‰ç©ºé—´äº†ï¼Œå•ä½ç§’)
5) (integer) 2   # å¤šé•¿æ—¶é—´åï¼Œæ¼æ–—å®Œå…¨ç©ºå‡ºæ¥(left_quota==capacityï¼Œå•ä½ç§’)
```

åœ¨æ‰§è¡Œé™æµæŒ‡ä»¤æ—¶ï¼Œå¦‚æœè¢«æ‹’ç»äº†ï¼Œå°±éœ€è¦ä¸¢å¼ƒæˆ–é‡è¯•ã€‚cl.throttle æŒ‡ä»¤è€ƒè™‘çš„éå¸¸å‘¨åˆ°ï¼Œè¿é‡è¯•æ—¶é—´éƒ½å¸®ä½ ç®—å¥½äº†ï¼Œç›´æ¥å–è¿”å›ç»“æœæ•°ç»„çš„ç¬¬å››ä¸ªå€¼è¿›è¡Œ sleep å³å¯ï¼Œå¦‚æœä¸æƒ³é˜»å¡çº¿ç¨‹ï¼Œä¹Ÿå¯ä»¥å¼‚æ­¥å®šæ—¶ä»»åŠ¡æ¥é‡è¯•ã€‚

## æ€è€ƒ
æ¼æ–—é™æµæ¨¡å—é™¤äº†åº”ç”¨äº UGCï¼Œè¿˜èƒ½åº”ç”¨äºå“ªäº›åœ°æ–¹ï¼Ÿ

## æ‹“å±•é˜…è¯»

**1. ã€ŠRedis-Cell ä½œè€… Itamar Haber å…¶äººè¶£äº‹ã€‹**

![](https://user-gold-cdn.xitu.io/2018/7/11/164872dc531f1a48?w=865&h=141&f=png&s=56775)

Redis-Cell ä½œè€… Itamar Haber  çš„ä»‹ç»å¾ˆæœ‰æ„æ€â€”â€”ä¸€ä¸ªã€Œè‡ªå°ã€çš„ Redis æå®¢ã€‚è¿˜æœ‰ï¼ŒCell è¿™ä¸ªæ¨¡å—å±…ç„¶æ˜¯ç”¨ Rust ç¼–å†™çš„ã€‚â€”â€” åŸæ¥ Redis æ¨¡å—å¯ä»¥ä½¿ç”¨ Rust ç¼–å†™ï¼Ÿï¼

è¿™æ„å‘³ç€æˆ‘ä»¬ä¸ç”¨å»æå¤è€çš„ C è¯­è¨€äº†ã€‚è€é’±è¡¨ç¤ºè¦é‡æ–°æ‹¾èµ·æ”¾å¼ƒå¾ˆä¹…çš„ Rust è¯­è¨€ã€‚å“ï¼Œå¹²ç¨‹åºå‘˜è¿™ä¸€è¡Œï¼ŒçœŸæ˜¯è¦æ´»åˆ°è€ï¼Œå­¦åˆ°æ­»å•Šï¼ğŸ˜¢
