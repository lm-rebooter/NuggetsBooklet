## ä¸€ å‰è¨€

ä»æœ¬èŠ‚å¼€å§‹ï¼Œæˆ‘ä»¬å°†å¼€å§‹æ­£å¼ä»‹ç» React ä¼˜åŒ–ç¯èŠ‚ï¼ŒReact ä¼˜åŒ–ä¼šä»**æ¸²æŸ“ã€åŠ è½½ã€æµ·é‡æ•°æ®ã€ç»†èŠ‚**å››ä¸ªæ–¹å‘å…¥æ‰‹ï¼Œè¯¦ç»†ä»‹ç» React ä¼˜åŒ–è¿‡ç¨‹ä¸­çš„æ–¹æ³•å’ŒæŠ€å·§ã€‚æœ¬ç« èŠ‚å°†é‡ç‚¹è°ˆè°ˆ React çš„æ¸²æŸ“ä»¥åŠä¼˜åŒ–æ‰‹æ®µã€‚

é€šè¿‡æœ¬ç« èŠ‚çš„å­¦ä¹ ï¼Œä½ å°†æ”¶è· React æ¸²æŸ“æ§åˆ¶çš„å¸¸è§„æ–¹æ³•ä»¥åŠåŸç†ï¼Œå¹¶ä¸”å­¦ä¼šæ€§èƒ½ä¼˜åŒ–çš„ä¸»è¦æ‰‹æ®µã€‚

## äºŒ å†è°ˆ React æ¸²æŸ“

å¯¹äº React æ¸²æŸ“ï¼Œä½ ä¸è¦ä»…ä»…ç†è§£æˆç±»ç»„ä»¶è§¦å‘ render å‡½æ•°ï¼Œå‡½æ•°ç»„ä»¶æœ¬èº«æ‰§è¡Œï¼Œäº‹å®ä¸Šï¼Œä»è°ƒåº¦æ›´æ–°ä»»åŠ¡åˆ°è°ƒå’Œ fiberï¼Œå†åˆ°æµè§ˆå™¨æ¸²æŸ“çœŸå® DOMï¼Œæ¯ä¸€ä¸ªç¯èŠ‚éƒ½æ˜¯æ¸²æŸ“çš„ä¸€éƒ¨åˆ†ï¼Œè‡³äºå¯¹äºæ¯ä¸ªç¯èŠ‚çš„æ€§èƒ½ä¼˜åŒ–ï¼ŒReact åœ¨åº•å±‚å·²ç»å¤„ç†äº†å¤§éƒ¨åˆ†ä¼˜åŒ–ç»†èŠ‚ï¼ŒåŒ…æ‹¬è®¾ç«‹ä»»åŠ¡ä¼˜å…ˆçº§ã€å¼‚æ­¥è°ƒåº¦ã€diffç®—æ³•ã€æ—¶é—´åˆ†ç‰‡éƒ½æ˜¯ React ä¸ºäº†æé«˜æ€§èƒ½ï¼Œæå‡ç”¨æˆ·ä½“éªŒé‡‡å–çš„æ‰‹æ®µã€‚æ‰€ä»¥ï¼Œå¼€å‘è€…åªéœ€è¦å‘Šè¯‰ React å“ªäº›ç»„ä»¶éœ€è¦æ›´æ–°ï¼Œå“ªäº›ç»„ä»¶ä¸éœ€è¦æ›´æ–°ã€‚äºæ˜¯ï¼ŒReact æä¾›äº† PureComponentï¼ŒshouldComponentUpdatedï¼Œmemo ç­‰ä¼˜åŒ–æ‰‹æ®µã€‚è¿™äº›æ‰‹æ®µæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

### renderé˜¶æ®µä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

é¦–å…ˆæ¥æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œç»„ä»¶åœ¨ä¸€æ¬¡æ›´æ–°ä¸­ï¼Œç±»ç»„ä»¶æ‰§è¡Œ render ï¼Œæ‰§è¡Œå‡½æ•°ç»„ä»¶ renderWithHooks ï¼ˆ renderWithHook å†…éƒ¨æ‰§è¡Œ React å‡½æ•°ç»„ä»¶æœ¬èº«ï¼‰ï¼Œä»–ä»¬çš„ä½œç”¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ ä»–ä»¬çœŸå®æ¸²æŸ“äº† DOM äº†å—ï¼Ÿæ˜¾ç„¶ä¸æ˜¯ï¼ŒçœŸå® DOM æ˜¯åœ¨ commit é˜¶æ®µæŒ‚è½½çš„ï¼Œä¹‹å‰ç« èŠ‚æ‰“å°è¿‡ render åçš„å†…å®¹ã€‚

é‚£ä¹ˆ**renderçš„ä½œç”¨**æ˜¯æ ¹æ®ä¸€æ¬¡æ›´æ–°ä¸­äº§ç”Ÿçš„æ–°çŠ¶æ€å€¼ï¼Œé€šè¿‡ React.createElement ï¼Œæ›¿æ¢æˆæ–°çš„çŠ¶æ€ï¼Œå¾—åˆ°æ–°çš„ React element å¯¹è±¡ï¼Œæ–°çš„ element å¯¹è±¡ä¸Šï¼Œä¿å­˜äº†æœ€æ–°çŠ¶æ€å€¼ã€‚ createElement ä¼šäº§ç”Ÿä¸€ä¸ªå…¨æ–°çš„propsã€‚åˆ°æ­¤ render å‡½æ•°ä½¿å‘½å®Œæˆäº†ã€‚

æ¥ä¸‹æ¥ï¼ŒReact ä¼šè°ƒå’Œç”± render å‡½æ•°äº§ç”Ÿ chidlrenï¼Œå°†å­ä»£ element å˜æˆ  fiberï¼ˆè¿™ä¸ªè¿‡ç¨‹å¦‚æœå­˜åœ¨ alternateï¼Œä¼šå¤ç”¨ alternate è¿›è¡Œå…‹éš†ï¼Œå¦‚æœæ²¡æœ‰ alternate ï¼Œé‚£ä¹ˆå°†åˆ›å»ºä¸€ä¸ªï¼‰ï¼Œå°† props å˜æˆ pendingProps ï¼Œè‡³æ­¤å½“å‰ç»„ä»¶æ›´æ–°å®Œæ¯•ã€‚ç„¶åå¦‚æœ children æ˜¯ç»„ä»¶ï¼Œä¼šç»§ç»­é‡å¤ä¸Šä¸€æ­¥ï¼Œç›´åˆ°å…¨éƒ¨ fiber è°ƒå’Œå®Œæ¯•ã€‚å®Œæˆ render é˜¶æ®µã€‚


## ä¸‰ React å‡ ç§æ§åˆ¶ render æ–¹æ³•

React æä¾›äº†å‡ ç§æ§åˆ¶ render çš„æ–¹å¼ã€‚æˆ‘è¿™é‡Œä¼šä»‹ç»åŸç†å’Œä½¿ç”¨ã€‚è¯´åˆ°å¯¹render çš„æ§åˆ¶ï¼Œç©¶å…¶æœ¬è´¨ï¼Œä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼ï¼š
* ç¬¬ä¸€ç§å°±æ˜¯ä»çˆ¶ç»„ä»¶ç›´æ¥éš”æ–­å­ç»„ä»¶çš„æ¸²æŸ“ï¼Œç»å…¸çš„å°±æ˜¯ memoï¼Œç¼“å­˜ element å¯¹è±¡ã€‚
* ç¬¬äºŒç§å°±æ˜¯ç»„ä»¶ä»è‡ªèº«æ¥æ§åˆ¶æ˜¯å¦ render ï¼Œæ¯”å¦‚ï¼šPureComponent ï¼ŒshouldComponentUpdate ã€‚

### 1 ç¼“å­˜React.elementå¯¹è±¡

ç¬¬ä¸€ç§æ˜¯å¯¹ React.element å¯¹è±¡çš„ç¼“å­˜ã€‚è¿™æ˜¯ä¸€ç§çˆ¶å¯¹å­çš„æ¸²æŸ“æ§åˆ¶æ–¹æ¡ˆï¼Œæ¥æºäºä¸€ç§æƒ…å†µï¼Œçˆ¶ç»„ä»¶ render ï¼Œå­ç»„ä»¶æœ‰æ²¡æœ‰å¿…è¦è·Ÿç€çˆ¶ç»„ä»¶ä¸€èµ· render ï¼Œå¦‚æœæ²¡æœ‰å¿…è¦ï¼Œåˆ™å°±éœ€è¦é˜»æ–­æ›´æ–°æµï¼Œå¦‚ä¸‹å…ˆä¸¾ä¸¤ä¸ªå°ä¾‹å­ğŸŒ°ï¼š

````js
/* å­ç»„ä»¶ */
function Children ({ number }){
    console.log('å­ç»„ä»¶æ¸²æŸ“')
    return <div>let us learn React!  { number } </div>
}
/* çˆ¶ç»„ä»¶ */
export default class Index extends React.Component{
    state={
        numberA:0,
        numberB:0,
    }
    render(){
        return <div>
            <Children number={ this.state.numberA } />
           <button onClick={ ()=> this.setState({ numberA:this.state.numberA + 1 }) } >æ”¹å˜numberA -{ this.state.numberA } </button>
           <button onClick={ ()=> this.setState({ numberB:this.state.numberB + 1 }) } >æ”¹å˜numberB -{ this.state.numberB }</button>
        </div>
     }

}
````
å¯¹äºå­ç»„ä»¶ Children ï¼Œåªæœ‰ props ä¸­ numberA æ›´æ–°æ‰æ˜¯æœ‰ç”¨çš„ï¼Œ numberB æ›´æ–°å¸¦æ¥æ¸²æŸ“ï¼ŒChildren æ ¹æœ¬ä¸éœ€è¦ã€‚ä½†æ˜¯å¦‚æœä¸å¤„ç†å­ç»„ä»¶çš„è¯ï¼Œå°±ä¼šå‡ºç°å¦‚ä¸‹æƒ…å†µã€‚æ— è®ºæ”¹å˜ numberA è¿˜æ˜¯æ”¹å˜ numberB ï¼Œå­ç»„ä»¶éƒ½ä¼šé‡æ–°æ¸²æŸ“ï¼Œæ˜¾ç„¶è¿™ä¸æ˜¯æƒ³è¦çš„ç»“æœã€‚

**æ•ˆæœ**


![1.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/99e32bcd5b1344ea9654001fb56917c0~tplv-k3u1fbpfcp-watermark.image)

é‚£ä¹ˆæ€ä¹ˆæ ·ç”¨ç¼“å­˜ element æ¥é¿å… children æ²¡æœ‰å¿…è¦çš„æ›´æ–°å‘¢ï¼Ÿå°†å¦‚ä¸Šçˆ¶ç»„ä»¶åšå¦‚ä¸‹ä¿®æ”¹ã€‚ 

````js
export default class Index extends React.Component{
    constructor(props){
        super(props)
        this.state={
            numberA:0,
            numberB:0,
        }
        this.component =  <Children number={this.state.numberA} />
    }
    controllComponentRender=()=>{ /* é€šè¿‡æ­¤å‡½æ•°åˆ¤æ–­ */
        const { props } = this.component
        if(props.number !== this.state.numberA ){ /* åªæœ‰ numberA å˜åŒ–çš„æ—¶å€™ï¼Œé‡æ–°åˆ›å»º element å¯¹è±¡  */
            return this.component = React.cloneElement(this.component,{ number:this.state.numberA })
        }
        return this.component
    }
    render(){
       return <div>
          { this.controllComponentRender()  } 
          <button onClick={ ()=> this.setState({ numberA:this.state.numberA + 1 }) } >æ”¹å˜numberA</button>
          <button onClick={ ()=> this.setState({ numberB:this.state.numberB + 1 }) }  >æ”¹å˜numberB</button>
       </div>
    }
}
````
* é¦–å…ˆæŠŠ Children ç»„ä»¶å¯¹åº”çš„ element å¯¹è±¡ï¼ŒæŒ‚è½½åˆ°ç»„ä»¶å®ä¾‹çš„ component å±æ€§ä¸‹ã€‚
* é€šè¿‡ controllComponentRender æ§åˆ¶æ¸²æŸ“ Children ç»„ä»¶ï¼Œå¦‚æœ numberA å˜åŒ–äº†ï¼Œè¯æ˜ Childrençš„props å˜åŒ–äº†ï¼Œé‚£ä¹ˆé€šè¿‡ cloneElement  è¿”å›æ–°çš„ element å¯¹è±¡ï¼Œå¹¶é‡æ–°èµ‹å€¼ç»™ component ï¼Œå¦‚æœæ²¡æœ‰å˜åŒ–ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›ç¼“å­˜çš„ component ã€‚


![2.gif](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c60e3744029f45d3a6ef8a324c0e0327~tplv-k3u1fbpfcp-watermark.image)

**å®Œç¾è¾¾åˆ°æ•ˆæœ**


ä½†æ˜¯åœ¨è¿™é‡Œä¸æ¨èåœ¨ React ç±»ç»„ä»·ä¸­è¿™ä¹ˆå†™ï¼Œå¯¹äºåŸºç¡€ä¸å¤Ÿæ‰å®çš„åŒå­¦ï¼Œå¾ˆå®¹æ˜“å‡ºç°é”™è¯¯ã€‚æˆ‘è¿˜æ˜¯æ¨èå¤§å®¶åœ¨å‡½æ•°ç»„ä»¶é‡Œç”¨ `useMemo` è¾¾åˆ°åŒæ ·çš„æ•ˆæœï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚

````js
export default function Index(){
    const [ numberA , setNumberA ] = React.useState(0)
    const [ numberB , setNumberB ] = React.useState(0)
    return <div>
        { useMemo(()=> <Children number={numberA} />,[ numberA ]) }
        <button onClick={ ()=> setNumberA(numberA + 1) } >æ”¹å˜numberA</button>
        <button onClick={ ()=> setNumberB(numberB + 1) } >æ”¹å˜numberB</button>
    </div>
}
````
* ç”¨ React.useMemo å¯ä»¥è¾¾åˆ°åŒæ ·çš„æ•ˆæœï¼Œ éœ€è¦æ›´æ–°çš„å€¼ numberA æ”¾åœ¨ deps ä¸­ï¼ŒnumberA æ”¹å˜ï¼Œé‡æ–°å½¢æˆelementå¯¹è±¡ï¼Œå¦åˆ™é€šè¿‡ useMemo æ‹¿åˆ°ä¸Šæ¬¡çš„ç¼“å­˜å€¼ã€‚è¾¾åˆ°å¦‚ä¸ŠåŒæ ·æ•ˆæœã€‚æ¯”èµ·ç±»ç»„ä»¶ï¼Œæˆ‘æ›´æ¨èå‡½æ•°ç»„ä»¶ç”¨ useMemo è¿™ç§æ–¹å¼ã€‚

**ï½œ--------é—®ä¸ç­”---------ï½œ**<br/>
è¯¦ç»†ä»‹ç»ä¸€ä¸‹ useMemo ï¼Ÿ

**useMemo ç”¨æ³•ï¼š**

````js
const cacheSomething = useMemo(create,deps)
````

* `create`ï¼šç¬¬ä¸€ä¸ªå‚æ•°ä¸ºä¸€ä¸ªå‡½æ•°ï¼Œå‡½æ•°çš„è¿”å›å€¼ä½œä¸ºç¼“å­˜å€¼ï¼Œå¦‚ä¸Š demo ä¸­æŠŠ Children å¯¹åº”çš„ element å¯¹è±¡ï¼Œç¼“å­˜èµ·æ¥ã€‚
* `deps`ï¼š ç¬¬äºŒä¸ªå‚æ•°ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œå­˜æ”¾å½“å‰ useMemo çš„ä¾èµ–é¡¹ï¼Œåœ¨å‡½æ•°ç»„ä»¶ä¸‹ä¸€æ¬¡æ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šå¯¹æ¯” deps ä¾èµ–é¡¹é‡Œé¢çš„çŠ¶æ€ï¼Œæ˜¯å¦æœ‰æ”¹å˜ï¼Œå¦‚æœæœ‰æ”¹å˜é‡æ–°æ‰§è¡Œ create ï¼Œå¾—åˆ°æ–°çš„ç¼“å­˜å€¼ã€‚
* `cacheSomething`ï¼šè¿”å›å€¼ï¼Œæ‰§è¡Œ create çš„è¿”å›å€¼ã€‚å¦‚æœ deps ä¸­æœ‰ä¾èµ–é¡¹æ”¹å˜ï¼Œè¿”å›çš„é‡æ–°æ‰§è¡Œ create äº§ç”Ÿçš„å€¼ï¼Œå¦åˆ™å–ä¸Šä¸€æ¬¡ç¼“å­˜å€¼ã€‚

**useMemoåŸç†ï¼š**

 useMemo ä¼šè®°å½•ä¸Šä¸€æ¬¡æ‰§è¡Œ create çš„è¿”å›å€¼ï¼Œå¹¶æŠŠå®ƒç»‘å®šåœ¨å‡½æ•°ç»„ä»¶å¯¹åº”çš„ fiber å¯¹è±¡ä¸Šï¼Œåªè¦ç»„ä»¶ä¸é”€æ¯ï¼Œç¼“å­˜å€¼å°±ä¸€ç›´å­˜åœ¨ï¼Œä½†æ˜¯ deps ä¸­å¦‚æœæœ‰ä¸€é¡¹æ”¹å˜ï¼Œå°±ä¼šé‡æ–°æ‰§è¡Œ create ï¼Œè¿”å›å€¼ä½œä¸ºæ–°çš„å€¼è®°å½•åˆ° fiber å¯¹è±¡ä¸Šã€‚

**useMemoåº”ç”¨åœºæ™¯ï¼š**

* å¯ä»¥ç¼“å­˜ element å¯¹è±¡ï¼Œä»è€Œè¾¾åˆ°æŒ‰æ¡ä»¶æ¸²æŸ“ç»„ä»¶ï¼Œä¼˜åŒ–æ€§èƒ½çš„ä½œç”¨ã€‚
* å¦‚æœç»„ä»¶ä¸­ä¸æœŸæœ›æ¯æ¬¡ render éƒ½é‡æ–°è®¡ç®—ä¸€äº›å€¼,å¯ä»¥åˆ©ç”¨ useMemo æŠŠå®ƒç¼“å­˜èµ·æ¥ã€‚
* å¯ä»¥æŠŠå‡½æ•°å’Œå±æ€§ç¼“å­˜èµ·æ¥ï¼Œä½œä¸º PureComponent çš„ç»‘å®šæ–¹æ³•ï¼Œæˆ–è€…é…åˆå…¶ä»–Hooksä¸€èµ·ä½¿ç”¨ã€‚

**ï½œ--------end---------ï½œ**<br/>

**åŸç†æ­ç§˜**

å¦‚ä¸Šè®²äº†åˆ©ç”¨ element çš„ç¼“å­˜ï¼Œå®ç°äº†æ§åˆ¶å­ç»„ä»¶ä¸å¿…è¦çš„æ¸²æŸ“ï¼Œç©¶å…¶åŸç†æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ 

åŸç†å…¶å®å¾ˆç®€å•ï¼Œä¸Šè¿°æ¯æ¬¡æ‰§è¡Œ render æœ¬è´¨ä¸Š createElement ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„ propsï¼Œè¿™ä¸ª props å°†ä½œä¸ºå¯¹åº” fiber çš„ `pendingProps` ï¼Œåœ¨æ­¤ fiber æ›´æ–°è°ƒå’Œé˜¶æ®µï¼ŒReact ä¼šå¯¹æ¯” fiber ä¸Šè€ oldProps å’Œæ–°çš„ newProp ï¼ˆ pendingProps ï¼‰æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰å‡½æ•°ç»„ä»¶å°±ä¼šæ”¾å¼ƒå­ç»„ä»¶çš„è°ƒå’Œæ›´æ–°ï¼Œä»è€Œå­ç»„ä»¶ä¸ä¼šé‡æ–°æ¸²æŸ“ï¼›å¦‚æœä¸Šè¿°æŠŠ element å¯¹è±¡ç¼“å­˜èµ·æ¥ï¼Œä¸Šé¢ props ä¹Ÿå°±å’Œ fiber ä¸Š oldProps æŒ‡å‘ç›¸åŒçš„å†…å­˜ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯ç›¸ç­‰ï¼Œä»è€Œè·³è¿‡äº†æœ¬æ¬¡æ›´æ–°ã€‚

### 2 PureComponent

çº¯ç»„ä»¶æ˜¯ä¸€ç§å‘è‡ªç»„ä»¶æœ¬èº«çš„æ¸²æŸ“ä¼˜åŒ–ç­–ç•¥ï¼Œå½“å¼€å‘ç±»ç»„ä»¶é€‰æ‹©äº†ç»§æ‰¿ PureComponent ï¼Œå°±æ„å‘³è¿™è¦éµå¾ªå…¶æ¸²æŸ“è§„åˆ™ã€‚è§„åˆ™å°±æ˜¯**æµ…æ¯”è¾ƒ state å’Œ props æ˜¯å¦ç›¸ç­‰**ã€‚é¦–å…ˆæ¥çœ‹ä¸€ä¸‹ PureComponent çš„åŸºæœ¬ä½¿ç”¨ã€‚

````js
/* çº¯ç»„ä»¶æœ¬èº« */
class Children extends React.PureComponent{
    state={
        name:'alien',
        age:18,
        obj:{
            number:1,
        }
    }
    changeObjNumber=()=>{
        const { obj } = this.state
        obj.number++
        this.setState({ obj })
    }
    render(){
        console.log('ç»„ä»¶æ¸²æŸ“')
        return <div  >
           <div> ç»„ä»¶æœ¬èº«æ”¹å˜state </div>
           <button onClick={() => this.setState({ name:'alien' }) } >stateç›¸åŒæƒ…å†µ</button>
           <button onClick={() => this.setState({ age:this.state.age + 1  }) }>stateä¸åŒæƒ…å†µ</button>
           <button onClick={ this.changeObjNumber } >stateä¸ºå¼•ç”¨æ•°æ®ç±»å‹æ—¶å€™</button>
           <div>hello,my name is alien,let us learn React!</div>
        </div>
    }
}
/* çˆ¶ç»„ä»¶ */
export default function Home (){
    const [ numberA , setNumberA ] = React.useState(0)
    const [ numberB , setNumberB ] = React.useState(0)
    return <div>
        <div> çˆ¶ç»„ä»¶æ”¹å˜props </div>
        <button onClick={ ()=> setNumberA(numberA + 1) } >æ”¹å˜numberA</button>
        <button onClick={ ()=> setNumberB(numberB + 1) } >æ”¹å˜numberB</button>
        <Children number={numberA}  /> 
    </div>
}
````
æ•ˆæœï¼š


![3.gif](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/23bb0f80f537418a8dedaf9a3fd88f1e~tplv-k3u1fbpfcp-watermark.image)

* å¯¹äº props ï¼ŒPureComponent ä¼šæµ…æ¯”è¾ƒ props æ˜¯å¦å‘ç”Ÿæ”¹å˜ï¼Œå†å†³å®šæ˜¯å¦æ¸²æŸ“ç»„ä»¶ï¼Œæ‰€ä»¥åªæœ‰ç‚¹å‡» numberA æ‰ä¼šä¿ƒä½¿ç»„ä»¶é‡æ–°æ¸²æŸ“ã€‚
* å¯¹äº state ï¼Œå¦‚ä¸Šä¹Ÿä¼šæµ…æ¯”è¾ƒå¤„ç†ï¼Œå½“ä¸Šè¿°è§¦å‘ â€˜ state ç›¸åŒæƒ…å†µâ€™ æŒ‰é’®æ—¶ï¼Œç»„ä»¶æ²¡æœ‰æ¸²æŸ“ã€‚
* æµ…æ¯”è¾ƒåªä¼šæ¯”è¾ƒåŸºç¡€æ•°æ®ç±»å‹ï¼Œå¯¹äºå¼•ç”¨ç±»å‹ï¼Œæ¯”å¦‚ demo ä¸­ state çš„ obj ï¼Œå•çº¯çš„æ”¹å˜ obj ä¸‹å±æ€§æ˜¯ä¸ä¼šä¿ƒä½¿ç»„ä»¶æ›´æ–°çš„ï¼Œå› ä¸ºæµ…æ¯”è¾ƒä¸¤æ¬¡ obj è¿˜æ˜¯æŒ‡å‘åŒä¸€ä¸ªå†…å­˜ç©ºé—´ï¼Œæƒ³è¦è§£å†³è¿™ä¸ªé—®é¢˜ä¹Ÿå®¹æ˜“ï¼Œæµ…æ‹·è´å°±å¯ä»¥è§£å†³ï¼Œå°†å¦‚ä¸Š changeObjNumber è¿™ä¹ˆä¿®æ”¹ã€‚è¿™æ ·å°±æ˜¯é‡æ–°åˆ›å»ºäº†ä¸€ä¸ª obj ï¼Œæ‰€ä»¥æµ…æ¯”è¾ƒä¼šä¸ç›¸ç­‰ï¼Œç»„ä»¶å°±ä¼šæ›´æ–°äº†ã€‚

````js
  changeObjNumber=()=>{
        const { obj } = this.state
        obj.number++
        this.setState({ obj:{...obj} })
    }
````

**PureComponent åŸç†åŠå…¶æµ…æ¯”è¾ƒåŸåˆ™**

PureComponent å†…éƒ¨æ˜¯å¦‚ä½•å·¥ä½œçš„å‘¢ï¼Œé¦–å…ˆå½“é€‰æ‹©åŸºäº PureComponent ç»§æ‰¿çš„ç»„ä»¶ã€‚åŸå‹é“¾ä¸Šä¼šæœ‰ isPureReactComponent å±æ€§ã€‚ä¸€èµ·çœ‹ä¸€ä¸‹åˆ›å»º PureComponent æ—¶å€™ï¼š

> react/src/ReactBaseClasses.js
````js
/* pureComponentPrototype çº¯ç»„ä»¶æ„é€ å‡½æ•°çš„ prototype å¯¹è±¡ï¼Œç»‘å®šisPureReactComponent å±æ€§ã€‚ */
pureComponentPrototype.isPureReactComponent = true;
````

`isPureReactComponent` è¿™ä¸ªå±æ€§åœ¨æ›´æ–°ç»„ä»¶ `updateClassInstance` æ–¹æ³•ä¸­ä½¿ç”¨çš„ï¼Œåœ¨ç”Ÿå‘½å‘¨æœŸç« èŠ‚ä¸­å·²ç»è®²è¿‡ï¼Œç›¸ä¿¡çœ‹è¿‡çš„åŒå­¦éƒ½ä¼šæœ‰å°è±¡ï¼Œè¿™ä¸ªå‡½æ•°åœ¨æ›´æ–°ç»„ä»¶çš„æ—¶å€™è¢«è°ƒç”¨ï¼Œåœ¨è¿™ä¸ªå‡½æ•°å†…éƒ¨ï¼Œæœ‰ä¸€ä¸ªä¸“é—¨è´Ÿè´£æ£€æŸ¥æ˜¯å¦æ›´æ–°çš„å‡½æ•°  `checkShouldComponentUpdate` ã€‚

> react/react-reconciler/ReactFiberClassComponent.js
````js
function checkShouldComponentUpdate(){
     if (typeof instance.shouldComponentUpdate === 'function') {
         return instance.shouldComponentUpdate(newProps,newState,nextContext)  /* shouldComponentUpdate é€»è¾‘ */
     } 
    if (ctor.prototype && ctor.prototype.isPureReactComponent) {
        return  !shallowEqual(oldProps, newProps) || !shallowEqual(oldState, newState)
    }
}
````
* isPureReactComponent å°±æ˜¯åˆ¤æ–­å½“å‰ç»„ä»¶æ˜¯ä¸æ˜¯çº¯ç»„ä»¶çš„ï¼Œå¦‚æœæ˜¯ PureComponent ä¼šæµ…æ¯”è¾ƒ props å’Œ state æ˜¯å¦ç›¸ç­‰ã€‚
* è¿˜æœ‰ä¸€ç‚¹å€¼å¾—æ³¨æ„çš„å°±æ˜¯ shouldComponentUpdate çš„æƒé‡ï¼Œä¼šå¤§äº PureComponentã€‚
* shallowEqual æ˜¯å¦‚ä½•æµ…æ¯”è¾ƒçš„å‘¢ï¼Œç”±äºæˆ‘ä¸æƒ³åœ¨ç« èŠ‚ä¸­å†™è¿‡å¤šçš„æºç ï¼Œæˆ‘åœ¨è¿™é‡Œå°±ç›´æ¥æè¿°è¿‡ç¨‹äº†ã€‚

shallowEqual æµ…æ¯”è¾ƒæµç¨‹ï¼š
* ç¬¬ä¸€æ­¥ï¼Œé¦–å…ˆä¼šç›´æ¥æ¯”è¾ƒæ–°è€ props æˆ–è€…æ–°è€ state æ˜¯å¦ç›¸ç­‰ã€‚å¦‚æœç›¸ç­‰é‚£ä¹ˆä¸æ›´æ–°ç»„ä»¶ã€‚
* ç¬¬äºŒæ­¥ï¼Œåˆ¤æ–­æ–°è€ state æˆ–è€… props ï¼Œæœ‰ä¸æ˜¯å¯¹è±¡æˆ–è€…ä¸º null çš„ï¼Œé‚£ä¹ˆç›´æ¥è¿”å› false ï¼Œæ›´æ–°ç»„ä»¶ã€‚
* ç¬¬ä¸‰æ­¥ï¼Œé€šè¿‡ Object.keys å°†æ–°è€ props æˆ–è€…æ–°è€ state çš„å±æ€§å key å˜æˆæ•°ç»„ï¼Œåˆ¤æ–­æ•°ç»„çš„é•¿åº¦æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœä¸ç›¸ç­‰ï¼Œè¯æ˜æœ‰å±æ€§å¢åŠ æˆ–è€…å‡å°‘ï¼Œé‚£ä¹ˆæ›´æ–°ç»„ä»¶ã€‚
* ç¬¬å››æ­¥ï¼Œéå†è€ props æˆ–è€…è€ state ï¼Œåˆ¤æ–­å¯¹åº”çš„æ–° props æˆ–æ–° state ï¼Œæœ‰æ²¡æœ‰ä¸ä¹‹å¯¹åº”å¹¶ä¸”ç›¸ç­‰çš„ï¼ˆè¿™ä¸ªç›¸ç­‰æ˜¯æµ…æ¯”è¾ƒï¼‰ï¼Œå¦‚æœæœ‰ä¸€ä¸ªä¸å¯¹åº”æˆ–è€…ä¸ç›¸ç­‰ï¼Œé‚£ä¹ˆç›´æ¥è¿”å› false ï¼Œæ›´æ–°ç»„ä»¶ã€‚
åˆ°æ­¤ä¸ºæ­¢ï¼Œæµ…æ¯”è¾ƒæµç¨‹ç»“æŸï¼Œ PureComponent å°±æ˜¯è¿™ä¹ˆåšæ¸²æŸ“èŠ‚æµä¼˜åŒ–çš„ã€‚

**PureComponentæ³¨æ„äº‹é¡¹**

PureComponent å¯ä»¥è®©ç»„ä»¶è‡ªå‘çš„åšä¸€å±‚æ€§èƒ½ä¸Šçš„è°ƒä¼˜ï¼Œä½†æ˜¯ï¼Œçˆ¶ç»„ä»¶ç»™æ˜¯ PureComponent çš„å­ç»„ä»¶ç»‘å®šäº‹ä»¶è¦æ ¼å¤–å°å¿ƒï¼Œé¿å…ä¸¤ç§æƒ…å†µå‘ç”Ÿï¼š

1 é¿å…ä½¿ç”¨ç®­å¤´å‡½æ•°ã€‚ä¸è¦ç»™æ˜¯ PureComponent å­ç»„ä»¶ç»‘å®šç®­å¤´å‡½æ•°ï¼Œå› ä¸ºçˆ¶ç»„ä»¶æ¯ä¸€æ¬¡ render ï¼Œå¦‚æœæ˜¯ç®­å¤´å‡½æ•°ç»‘å®šçš„è¯ï¼Œéƒ½ä¼šé‡æ–°ç”Ÿæˆä¸€ä¸ªæ–°çš„ç®­å¤´å‡½æ•°ï¼Œ PureComponent å¯¹æ¯”æ–°è€ props æ—¶å€™ï¼Œå› ä¸ºæ˜¯æ–°çš„å‡½æ•°ï¼Œæ‰€ä»¥ä¼šåˆ¤æ–­ä¸æƒ³ç­‰ï¼Œè€Œè®©ç»„ä»¶ç›´æ¥æ¸²æŸ“ï¼ŒPureComponent ä½œç”¨ç»ˆä¼šå¤±æ•ˆã€‚

````js
class Index extends React.PureComponent{}

export default class Father extends React.Component{
    render=()=> <Index callback={()=>{}}   />
}
````

2 PureComponent çš„çˆ¶ç»„ä»¶æ˜¯å‡½æ•°ç»„ä»¶çš„æƒ…å†µï¼Œç»‘å®šå‡½æ•°è¦ç”¨ useCallback æˆ–è€… useMemo å¤„ç†ã€‚è¿™ç§æƒ…å†µè¿˜æ˜¯å¾ˆå®¹æ˜“å‘ç”Ÿçš„ï¼Œå°±æ˜¯åœ¨ç”¨ class + function  ç»„ä»¶å¼€å‘é¡¹ç›®çš„æ—¶å€™ï¼Œå¦‚æœçˆ¶ç»„ä»¶æ˜¯å‡½æ•°ï¼Œå­ç»„ä»¶æ˜¯ PureComponent ï¼Œé‚£ä¹ˆç»‘å®šå‡½æ•°è¦å°å¿ƒï¼Œå› ä¸ºå‡½æ•°ç»„ä»¶æ¯ä¸€æ¬¡æ‰§è¡Œï¼Œå¦‚æœä¸å¤„ç†ï¼Œè¿˜ä¼šå£°æ˜ä¸€ä¸ªæ–°çš„å‡½æ•°ï¼Œæ‰€ä»¥ PureComponent å¯¹æ¯”åŒæ ·ä¼šå¤±æ•ˆï¼Œå¦‚ä¸‹æƒ…å†µï¼š

````js

class Index extends React.PureComponent{}
export default function (){
    const callback = function handerCallback(){} /* æ¯ä¸€æ¬¡å‡½æ•°ç»„ä»¶æ‰§è¡Œé‡æ–°å£°æ˜ä¸€ä¸ªæ–°çš„callbackï¼ŒPureComponentæµ…æ¯”è¾ƒä¼šè®¤ä¸ºä¸æƒ³ç­‰ï¼Œä¿ƒä½¿ç»„ä»¶æ›´æ–°  */
    return <Index callback={callback}  />
}
````
ç»¼ä¸Šå¯ä»¥ç”¨ useCallback æˆ–è€… useMemo è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒuseCallback é¦–é€‰ï¼Œè¿™ä¸ª hooks åˆè¡·å°±æ˜¯ä¸ºäº†è§£å†³è¿™ç§æƒ…å†µçš„ã€‚

````js
export default function (){
    const callback = React.useCallback(function handerCallback(){},[])
    return <Index callback={callback}  />
}
````
useCallback æ¥å—äºŒä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯éœ€è¦ç¼“å­˜çš„å‡½æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºdeps, deps ä¸­ä¾èµ–é¡¹æ”¹å˜è¿”å›æ–°çš„å‡½æ•°ã€‚å¦‚ä¸Šå¤„ç†ä¹‹åï¼Œå°±èƒ½ä»æ ¹æœ¬ä¸Šè§£å†³ PureComponent å¤±æ•ˆé—®é¢˜ã€‚ 

**ï½œ--------é—®ä¸ç­”---------ï½œ**<br/>

`useCallback` å’Œ `useMemo` æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

ç­”ï¼šuseCallback ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯ç¼“å­˜çš„å†…å®¹ï¼ŒuseMemo éœ€è¦æ‰§è¡Œç¬¬ä¸€ä¸ªå‡½æ•°ï¼Œè¿”å›å€¼ä¸ºç¼“å­˜çš„å†…å®¹ï¼Œæ¯”èµ· useCallback ï¼Œ useMemo æ›´åƒæ˜¯ç¼“å­˜äº†ä¸€æ®µé€»è¾‘ï¼Œæˆ–è€…è¯´æ‰§è¡Œè¿™æ®µé€»è¾‘è·å–çš„ç»“æœã€‚é‚£ä¹ˆå¯¹äºç¼“å­˜ element ç”¨ useCallback å¯ä»¥å—ï¼Œç­”æ¡ˆæ˜¯å½“ç„¶å¯ä»¥äº†ã€‚

**ï½œ----------------------ï½œ**<br/>

### 3 shouldComponentUpdate

æœ‰çš„æ—¶å€™ï¼ŒæŠŠæ§åˆ¶æ¸²æŸ“ï¼Œæ€§èƒ½è°ƒä¼˜äº¤ç»™ React ç»„ä»¶æœ¬èº«å¤„ç†æ˜¾ç„¶æ˜¯é ä¸ä½çš„ï¼ŒReact éœ€è¦æä¾›ç»™ä½¿ç”¨è€…ä¸€ç§æ›´çµæ´»é…ç½®çš„è‡ªå®šä¹‰æ¸²æŸ“æ–¹æ¡ˆï¼Œä½¿ç”¨è€…å¯ä»¥è‡ªå·±å†³å®šæ˜¯å¦æ›´æ–°å½“å‰ç»„ä»¶ï¼ŒshouldComponentUpdate å°±èƒ½è¾¾åˆ°è¿™ç§æ•ˆæœã€‚åœ¨ç”Ÿå‘½å‘¨æœŸç« èŠ‚ä»‹ç»äº† shouldComponentUpdate çš„ç”¨æ³•ï¼Œæ¥ä¸‹æ¥è¯•ä¸€ä¸‹ shouldComponentUpdate å¦‚ä½•ä½¿ç”¨ã€‚

````js
class Index extends React.Component{ //å­ç»„ä»¶
    state={
        stateNumA:0,
        stateNumB:0
    }
    shouldComponentUpdate(newProp,newState,newContext){
        if(newProp.propsNumA !== this.props.propsNumA || newState.stateNumA !== this.state.stateNumA ){
            return true /* åªæœ‰å½“ props ä¸­ propsNumA å’Œ state ä¸­ stateNumA å˜åŒ–æ—¶ï¼Œæ›´æ–°ç»„ä»¶  */
        }
        return false 
    }
    render(){
        console.log('ç»„ä»¶æ¸²æŸ“')
        const { stateNumA ,stateNumB } = this.state
        return <div>
            <button onClick={ ()=> this.setState({ stateNumA: stateNumA + 1 }) } >æ”¹å˜stateä¸­numA</button>
            <button onClick={ ()=> this.setState({ stateNumB: stateNumB + 1 }) } >æ”¹å˜stataä¸­numB</button>
            <div>hello,let us learn React!</div>
        </div>
    }
}
export default function Home(){ // çˆ¶ç»„ä»¶
    const [ numberA , setNumberA ] = React.useState(0)
    const [ numberB , setNumberB ] = React.useState(0)
    return <div>
        <button onClick={ ()=> setNumberA(numberA + 1) } >æ”¹å˜propsä¸­numA</button>
        <button onClick={ ()=> setNumberB(numberB + 1) } >æ”¹å˜propsä¸­numB</button>
        <Index propsNumA={numberA}  propsNumB={numberB}   />
    </div>
}
````

**æ•ˆæœ**


![4.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1be67563c9ba4e3487b8209664439491~tplv-k3u1fbpfcp-watermark.image)

shouldComponentUpdate å¯ä»¥æ ¹æ®ä¼ å…¥çš„æ–°çš„ props å’Œ state ï¼Œæˆ–è€…  newContext æ¥ç¡®å®šæ˜¯å¦æ›´æ–°ç»„ä»¶ï¼Œå¦‚ä¸Šé¢ä¾‹å­ğŸŒ°ï¼Œåªæœ‰å½“ props ä¸­ propsNumA å±æ€§å’Œ state ä¸­ stateNumA æ”¹å˜çš„æ—¶å€™ï¼Œç»„ä»¶æ‰æ¸²æŸ“ã€‚ä½†æ˜¯æœ‰ä¸€ç§æƒ…å†µå°±æ˜¯å¦‚æœå­ç»„ä»¶çš„ props æ˜¯å¼•ç”¨æ•°æ®ç±»å‹ï¼Œæ¯”å¦‚ object ï¼Œè¿˜æ˜¯ä¸èƒ½ç›´è§‚æ¯”è¾ƒæ˜¯å¦ç›¸ç­‰ã€‚é‚£ä¹ˆå¦‚æœæƒ³æœ‰å¯¹æ¯”æ–°è€å±æ€§ç›¸ç­‰ï¼Œæ€ä¹ˆå¯¹æ¯”å‘¢ï¼Œè€Œä¸”å¾ˆå¤šæƒ…å†µä¸‹ï¼Œç»„ä»¶ä¸­æ•°æ®å¯èƒ½æ¥æºäºæœåŠ¡ç«¯äº¤äº’ï¼Œå¯¹äºå±æ€§ç»“æ„æ˜¯æœªçŸ¥çš„ã€‚

`immutable.js` å¯ä»¥è§£å†³æ­¤é—®é¢˜ï¼Œimmutable.js ä¸å¯å˜çš„çŠ¶æ€ï¼Œå¯¹ Immutable å¯¹è±¡çš„ä»»ä½•ä¿®æ”¹æˆ–æ·»åŠ åˆ é™¤æ“ä½œéƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ Immutable å¯¹è±¡ã€‚é‰´äºè¿™ä¸ªåŠŸèƒ½ï¼Œæ‰€ä»¥å¯ä»¥æŠŠéœ€è¦å¯¹æ¯”çš„ props æˆ–è€… state æ•°æ®å˜æˆ Immutable å¯¹è±¡ï¼Œé€šè¿‡å¯¹æ¯” Immutable æ˜¯å¦ç›¸ç­‰ï¼Œæ¥è¯æ˜çŠ¶æ€æ˜¯å¦æ”¹å˜ï¼Œä»è€Œç¡®å®šæ˜¯å¦æ›´æ–°ç»„ä»¶ã€‚

å¯¹äº shouldComponentUpdate ç”Ÿå‘½å‘¨æœŸç¯‡ç« å’Œä¸Šé¢éƒ½æœ‰æåŠï¼Œå®ƒçš„æ‰§è¡Œæ˜¯åœ¨ checkShouldComponentUpdateï¼Œä¼šæ‰§è¡Œæ­¤ç”Ÿå‘½å‘¨æœŸã€‚

### 4 React.memo

````js
React.memo(Component,compare)
````

React.memo å¯ä½œä¸ºä¸€ç§å®¹å™¨åŒ–çš„æ§åˆ¶æ¸²æŸ“æ–¹æ¡ˆï¼Œå¯ä»¥å¯¹æ¯” props å˜åŒ–ï¼Œæ¥å†³å®šæ˜¯å¦æ¸²æŸ“ç»„ä»¶ï¼Œé¦–å…ˆå…ˆæ¥çœ‹ä¸€ä¸‹ memo çš„åŸºæœ¬ç”¨æ³•ã€‚React.memo æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•° Component åŸå§‹ç»„ä»¶æœ¬èº«ï¼Œç¬¬äºŒä¸ªå‚æ•° compare æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥æ ¹æ®ä¸€æ¬¡æ›´æ–°ä¸­ props æ˜¯å¦ç›¸åŒå†³å®šåŸå§‹ç»„ä»¶æ˜¯å¦é‡æ–°æ¸²æŸ“ã€‚

memoçš„å‡ ä¸ªç‰¹ç‚¹æ˜¯ï¼š
* React.memo: ç¬¬äºŒä¸ªå‚æ•° è¿”å› true ç»„ä»¶ä¸æ¸²æŸ“ ï¼Œ è¿”å› false ç»„ä»¶é‡æ–°æ¸²æŸ“ã€‚å’Œ shouldComponentUpdate ç›¸åï¼ŒshouldComponentUpdate : è¿”å› true ç»„ä»¶æ¸²æŸ“ ï¼Œ è¿”å› false ç»„ä»¶ä¸æ¸²æŸ“ã€‚
* memo å½“äºŒä¸ªå‚æ•° compare ä¸å­˜åœ¨æ—¶ï¼Œä¼šç”¨**æµ…æ¯”è¾ƒåŸåˆ™**å¤„ç† props ï¼Œç›¸å½“äºä»…æ¯”è¾ƒ props ç‰ˆæœ¬çš„ pureComponent ã€‚
* memo åŒæ ·é€‚åˆç±»ç»„ä»¶å’Œå‡½æ•°ç»„ä»¶ã€‚ 

è¢« memo åŒ…è£¹çš„ç»„ä»¶ï¼Œelement ä¼šè¢«æ‰“æˆ `REACT_MEMO_TYPE` ç±»å‹çš„ element æ ‡ç­¾ï¼Œåœ¨ element å˜æˆ fiber çš„æ—¶å€™ï¼Œ fiber ä¼šè¢«æ ‡è®°æˆ MemoComponent çš„ç±»å‹ã€‚
> react/src/ReactMemo.js
````js
function memo(type,compare){
  const elementType = {
    $$typeof: REACT_MEMO_TYPE, 
    type,  // æˆ‘ä»¬çš„ç»„ä»¶
    compare: compare === undefined ? null : compare,  //ç¬¬äºŒä¸ªå‚æ•°ï¼Œä¸€ä¸ªå‡½æ•°ç”¨äºåˆ¤æ–­propï¼Œæ§åˆ¶æ›´æ–°æ–¹å‘ã€‚
  };
  return elementType
}
````
> react-reconciler/src/ReactFiber.js
````js
  case REACT_MEMO_TYPE:
  fiberTag = MemoComponent;
````

é‚£ä¹ˆå¯¹äº MemoComponent React å†…éƒ¨åˆæ˜¯å¦‚ä½•å¤„ç†çš„å‘¢ï¼Ÿé¦–å…ˆ React å¯¹ MemoComponent ç±»å‹çš„ fiber æœ‰å•ç‹¬çš„æ›´æ–°å¤„ç†é€»è¾‘ updateMemoComponent ã€‚é¦–å…ˆä¸€èµ·çœ‹ä¸€ä¸‹ä¸»è¦é€»è¾‘ï¼š
> react-reconciler/src/ReactFiberBeginWork.js
````js
function updateMemoComponent(){
    if (updateExpirationTime < renderExpirationTime) {
         let compare = Component.compare;
         compare = compare !== null ? compare : shallowEqual //å¦‚æœ memo æœ‰ç¬¬äºŒä¸ªå‚æ•°ï¼Œåˆ™ç”¨äºŒä¸ªå‚æ•°åˆ¤å®šï¼Œæ²¡æœ‰åˆ™æµ…æ¯”è¾ƒpropsæ˜¯å¦ç›¸ç­‰ã€‚
        if (compare(prevProps, nextProps) && current.ref === workInProgress.ref) {
            return bailoutOnAlreadyFinishedWork(current,workInProgress,renderExpirationTime); //å·²ç»å®Œæˆå·¥ä½œåœæ­¢å‘ä¸‹è°ƒå’ŒèŠ‚ç‚¹ã€‚
        }
    }
    // è¿”å›å°†è¦æ›´æ–°ç»„ä»¶,memoåŒ…è£…çš„ç»„ä»¶å¯¹åº”çš„fiberï¼Œç»§ç»­å‘ä¸‹è°ƒå’Œæ›´æ–°ã€‚
}
````
memo ä¸»è¦é€»è¾‘æ˜¯
* é€šè¿‡ memo ç¬¬äºŒä¸ªå‚æ•°ï¼Œåˆ¤æ–­æ˜¯å¦æ‰§è¡Œæ›´æ–°ï¼Œå¦‚æœæ²¡æœ‰é‚£ä¹ˆç¬¬äºŒä¸ªå‚æ•°ï¼Œé‚£ä¹ˆä»¥æµ…æ¯”è¾ƒ props ä¸º diff è§„åˆ™ã€‚å¦‚æœç›¸ç­‰ï¼Œå½“å‰ fiber å®Œæˆå·¥ä½œï¼Œåœæ­¢å‘ä¸‹è°ƒå’ŒèŠ‚ç‚¹ï¼Œæ‰€ä»¥è¢«åŒ…è£¹çš„ç»„ä»¶å³å°†ä¸æ›´æ–°ã€‚
* memo å¯ä»¥ç†è§£ä¸ºåŒ…äº†ä¸€å±‚çš„é«˜é˜¶ç»„ä»¶ï¼Œå®ƒçš„é˜»æ–­æ›´æ–°æœºåˆ¶ï¼Œæ˜¯é€šè¿‡æ§åˆ¶ä¸‹ä¸€çº§ children ï¼Œä¹Ÿå°±æ˜¯ memo åŒ…è£…çš„ç»„ä»¶ï¼Œæ˜¯å¦ç»§ç»­è°ƒå’Œæ¸²æŸ“ï¼Œæ¥è¾¾åˆ°ç›®çš„çš„ã€‚

æ¥ä¸‹æ¥åšä¸€ä¸ªå°æ¡ˆä¾‹ï¼Œåˆ©ç”¨ memo åšåˆ°è‡ªå®šä¹‰ props æ¸²æŸ“ã€‚
è§„åˆ™ï¼š æ§åˆ¶ props ä¸­çš„ number ã€‚
* 1 åªæœ‰ number æ›´æ”¹ï¼Œç»„ä»¶æ¸²æŸ“ã€‚
* 2 åªæœ‰ number å°äº 5 ï¼Œç»„ä»¶æ¸²æŸ“ã€‚

````js
function TextMemo(props){ / /å­ç»„ä»¶
    console.log('å­ç»„ä»¶æ¸²æŸ“')
    return <div>hello,world</div> 
}
const controlIsRender = (pre,next)=>{
   return ( pre.number === next.number ) ||  (pre.number !== next.number && next.number > 5) // numberä¸æ”¹å˜æˆ–number æ”¹å˜ä½†å€¼å¤§äº5->ä¸æ¸²æŸ“ç»„ä»¶ | å¦åˆ™æ¸²æŸ“ç»„ä»¶
}
const NewTexMemo = memo(TextMemo,controlIsRender)
class Index extends React.Component{
    constructor(props){
        super(props)
        this.state={
            number:1,
            num:1
        }
    }
    render(){
        const { num , number }  = this.state
        return <div>
            <div>
                æ”¹å˜numï¼šå½“å‰å€¼ { num }  
                <button onClick={ ()=>this.setState({ num:num + 1 }) } >num++</button>
                <button onClick={ ()=>this.setState({ num:num - 1 }) } >num--</button>  
            </div>
            <div>
                æ”¹å˜numberï¼š å½“å‰å€¼ { number } 
                <button onClick={ ()=>this.setState({ number:number + 1 }) } > number ++</button>
                <button onClick={ ()=>this.setState({ number:number - 1 }) } > number -- </button>  
            </div>
            <NewTexMemo num={ num } number={number}  />
        </div>
    }
}
````

![memo.gif](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/823787ff6ac5492c9da013b1acb4dfbc~tplv-k3u1fbpfcp-watermark.image)

**å®Œç¾è¾¾åˆ°æ•ˆæœ**

memo æ³¨æ„äº‹é¡¹ï¼Œåƒå¦‚ä¸‹è¿™æ ·ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸è¦è¯•å›¾ç»„ä»¶é€šè¿‡ç¬¬äºŒä¸ªå‚æ•°ç›´æ¥è¿”å› true æ¥é˜»æ–­æ¸²æŸ“ã€‚è¿™æ ·å¯èƒ½ä¼šé€ æˆå¾ˆå¤šéº»çƒ¦ã€‚

````js
// å°½é‡ä¸è¦è¿™ä¹ˆå°è¯•
const NewIndex = React.memo(Index,() => true )
````

### 5 æ‰“ç ´æ¸²æŸ“é™åˆ¶

* 1 forceUpdateã€‚ç±»ç»„ä»¶æ›´æ–°å¦‚æœè°ƒç”¨çš„æ˜¯ forceUpdate è€Œä¸æ˜¯  setState ï¼Œä¼šè·³è¿‡ PureComponent çš„æµ…æ¯”è¾ƒå’Œ shouldComponentUpdate è‡ªå®šä¹‰æ¯”è¾ƒã€‚å…¶åŸç†æ˜¯ç»„ä»¶ä¸­è°ƒç”¨ forceUpdate æ—¶å€™ï¼Œå…¨å±€ä¼šå¼€å¯ä¸€ä¸ª hasForceUpdate çš„å¼€å…³ã€‚å½“ç»„ä»¶æ›´æ–°çš„æ—¶å€™ï¼Œæ£€æŸ¥è¿™ä¸ªå¼€å…³æ˜¯å¦æ‰“å¼€ï¼Œå¦‚æœæ‰“å¼€ï¼Œå°±ç›´æ¥è·³è¿‡ shouldUpdate ã€‚

* 2 contextç©¿é€ï¼Œä¸Šè¿°çš„å‡ ç§æ–¹å¼ï¼Œéƒ½ä¸èƒ½æœ¬è´¨ä¸Šé˜»æ–­ context æ”¹å˜ï¼Œè€Œå¸¦æ¥çš„æ¸²æŸ“ç©¿é€ï¼Œæ‰€ä»¥å¼€å‘è€…åœ¨ä½¿ç”¨ Context è¦æ ¼å¤–å°å¿ƒï¼Œæ—¢ç„¶é€‰æ‹©äº†æ¶ˆè´¹ context ï¼Œå°±è¦æ‰¿æ‹… context æ”¹å˜ï¼Œå¸¦æ¥çš„æ›´æ–°ä½œç”¨ã€‚

### 6 æ¸²æŸ“æ§åˆ¶æµç¨‹å›¾


![5.jpg](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3df03000a39549bead3c84750c62576c~tplv-k3u1fbpfcp-watermark.image)


## å›› å¯¹äºrenderçš„æ€è€ƒ

### 1 æœ‰æ²¡æœ‰å¿…è¦åœ¨ä¹ç»„ä»¶ä¸å¿…è¦æ¸²æŸ“ã€‚

åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œæ— é¡»è¿‡åˆ†åœ¨ä¹ React æ²¡æœ‰å¿…è¦çš„æ¸²æŸ“ï¼Œè¦ç†è§£æ‰§è¡Œ render ä¸ç­‰äºçœŸæ­£çš„æµè§ˆå™¨æ¸²æŸ“è§†å›¾ï¼Œrender é˜¶æ®µæ‰§è¡Œæ˜¯åœ¨ js å½“ä¸­ï¼Œjs ä¸­è¿è¡Œä»£ç è¿œå¿«äºæµè§ˆå™¨çš„ Rendering å’Œ Painting çš„ï¼Œæ›´ä½•å†µ React è¿˜æä¾›äº† diff ç®—æ³•ç­‰æ‰‹æ®µï¼Œå»å¤ç”¨çœŸå® DOM ã€‚

### 2 ä»€ä¹ˆæ—¶å€™éœ€è¦æ³¨æ„æ¸²æŸ“èŠ‚æµã€‚

ä½†æ˜¯å¯¹äºä»¥ä¸‹æƒ…å†µï¼Œå€¼å¾—å¼€å‘è€…æ³¨æ„ï¼Œéœ€è¦é‡‡ç”¨æ¸²æŸ“èŠ‚æµï¼š

* ç¬¬ä¸€ç§æƒ…å†µæ•°æ®å¯è§†åŒ–çš„æ¨¡å—ç»„ä»¶ï¼ˆå±•ç¤ºäº†å¤§é‡çš„æ•°æ®ï¼‰ï¼Œè¿™ç§æƒ…å†µæ¯”è¾ƒå°å¿ƒå› ä¸ºä¸€æ¬¡æ›´æ–°ï¼Œå¯èƒ½ä¼´éšå¤§é‡çš„ diff ï¼Œæ•°æ®é‡è¶Šå¤§ä¹Ÿå°±è¶Šæµªè´¹æ€§èƒ½ï¼Œæ‰€ä»¥å¯¹äºæ•°æ®å±•ç¤ºæ¨¡å—ç»„ä»¶ï¼Œæœ‰å¿…è¦é‡‡å– memo ï¼Œ shouldComponentUpdate ç­‰æ–¹æ¡ˆæ§åˆ¶è‡ªèº«ç»„ä»¶æ¸²æŸ“ã€‚

* ç¬¬äºŒç§æƒ…å†µå«æœ‰å¤§é‡è¡¨å•çš„é¡µé¢ï¼ŒReact ä¸€èˆ¬ä¼šé‡‡ç”¨å—æ§ç»„ä»¶çš„æ¨¡å¼å»ç®¡ç†è¡¨å•æ•°æ®å±‚ï¼Œè¡¨å•æ•°æ®å±‚å®Œå…¨æ‰˜ç®¡äº props æˆ–æ˜¯ state ï¼Œè€Œç”¨æˆ·æ“ä½œè¡¨å•å¾€å¾€æ˜¯é¢‘ç¹çš„ï¼Œéœ€è¦é¢‘ç¹æ”¹å˜æ•°æ®å±‚ï¼Œæ‰€ä»¥å¾ˆæœ‰å¯èƒ½è®©æ•´ä¸ªé¡µé¢ç»„ä»¶é«˜é¢‘ç‡ render ã€‚

* ç¬¬ä¸‰ç§æƒ…å†µå°±æ˜¯è¶Šæ˜¯é è¿‘ app root æ ¹ç»„ä»¶è¶Šå€¼å¾—æ³¨æ„ï¼Œæ ¹ç»„ä»¶æ¸²æŸ“ä¼šæ³¢åŠåˆ°æ•´ä¸ªç»„ä»¶æ ‘é‡æ–° render ï¼Œå­ç»„ä»¶ render ï¼Œä¸€æ˜¯æµªè´¹æ€§èƒ½ï¼ŒäºŒæ˜¯å¯èƒ½æ‰§è¡Œ useEffect ï¼ŒcomponentWillReceiveProps ç­‰é’©å­ï¼Œé€ æˆæ„æƒ³ä¸åˆ°çš„æƒ…å†µå‘ç”Ÿã€‚

### 3 ä¸€äº›å¼€å‘ä¸­çš„ç»†èŠ‚é—®é¢˜

* å¼€å‘è¿‡ç¨‹ä¸­å¯¹äºå¤§é‡æ•°æ®å±•ç¤ºçš„æ¨¡å—ï¼Œå¼€å‘è€…æœ‰å¿…è¦ç”¨ shouldComponentUpdate ï¼ŒPureComponentæ¥ä¼˜åŒ–æ€§èƒ½ã€‚
* å¯¹äºè¡¨å•æ§ä»¶ï¼Œæœ€å¥½åŠæ³•å•ç‹¬æŠ½ç¦»ç»„ä»¶ï¼Œç‹¬è‡ªç®¡ç†è‡ªå·±çš„æ•°æ®å±‚ï¼Œè¿™æ ·å¯ä»¥è®© state æ”¹å˜ï¼Œæ³¢åŠçš„èŒƒå›´æ›´å°ã€‚
* å¦‚æœéœ€è¦æ›´ç²¾è‡´åŒ–æ¸²æŸ“ï¼Œå¯ä»¥é…åˆ immutable.js ã€‚
* ç»„ä»¶é¢—ç²’åŒ–ï¼Œé…åˆ memo ç­‰ api ï¼Œå¯ä»¥åˆ¶å®šç§æœ‰åŒ–çš„æ¸²æŸ“ç©ºé—´ã€‚

## äº” æ€»ç»“

æœ¬èŠ‚ä¸»è¦è®²äº†ï¼š
1. è¯¦ç»†ä»‹ç»Reactçš„å‡ ç§æ§åˆ¶æ¸²æŸ“ï¼Œä¼˜åŒ–æ¸²æŸ“çš„æ‰‹æ®µåŠå…¶åŸç†ã€‚
2. å…³äºReactä»€ä¹ˆæƒ…å†µä¸‹é€‚åˆåšæ¸²æŸ“ä¼˜åŒ–ã€‚åŠå…¶å¼€å‘è¿‡ç¨‹ä¸­ä¸€äº›ç»†èŠ‚é—®é¢˜ã€‚


