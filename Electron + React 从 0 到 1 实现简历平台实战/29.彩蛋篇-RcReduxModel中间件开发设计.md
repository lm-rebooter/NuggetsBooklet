## å‰è¨€

æœ¬ç« èŠ‚å°†ä¼šç»™å¤§å®¶åˆ†äº« [re-redux-model](https://github.com/SugarTurboS/rc-redux-model) çš„å‡ºç°ç¼˜ç”±ä»¥åŠè®¾è®¡è¿‡ç¨‹ï¼Œå½“ç„¶è¿˜æœ‰æ ¸å¿ƒæºç çš„è§£è¯»ï¼Œå¦‚æœä½ å¯¹æœ¬ç« èŠ‚å†…å®¹å…´è¶£ä¸å¤§ï¼Œå¯ä»¥å¿«é€Ÿé˜…è¯»æˆ–è·³è¿‡ã€‚

æœ¬æ–‡çš„æ•´ä½“æ€è·¯ï¼š

- ä¸ºä»€ä¹ˆè¦å†™ rc-redux-model
- æˆ‘æœŸæœ›åšæˆä»€ä¹ˆæ ·
- çŸ¥è¯†å‚¨å¤‡
- æ ¸å¿ƒæºç è§£è¯»

## A. ä¸ºä»€ä¹ˆè¦å†™ rc-redux-model

### 1. å‡ºç°ç¼˜ç”±

å‰é¢ç»™å¤§å®¶ä¸æ–­å¼ºè°ƒï¼Œ**React æ˜¯å•å‘æ•°æ®æµçš„å½¢å¼**ï¼Œå®ƒä¸å­˜åœ¨æ•°æ®å‘ä¸Šå›æº¯çš„æŠ€èƒ½ï¼Œè¦ä¹ˆå°±æ˜¯å‘ä¸‹åˆ†å‘ï¼Œè¦ä¹ˆå°±æ˜¯è‡ªå·±å†…éƒ¨ç®¡ç†ã€‚

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ec1c1df7d3594a7cae3e702aaddbfdd1~tplv-k3u1fbpfcp-watermark.image)

> åœ¨ react ä¸­ï¼Œæœ‰ props å’Œ stateï¼Œå½“æˆ‘æƒ³ä»çˆ¶ç»„ä»¶ç»™å­ç»„ä»¶ä¼ é€’æ•°æ®æ—¶ï¼Œå¯é€šè¿‡ props è¿›è¡Œæ•°æ®ä¼ é€’ï¼Œå¦‚æœæˆ‘æƒ³åœ¨ç»„ä»¶å†…éƒ¨è‡ªè¡Œç®¡ç†çŠ¶æ€ï¼Œé‚£å¯ä»¥é€‰æ‹©ä½¿ç”¨ stateã€‚

å¾ˆå¿«ï¼Œæˆ‘é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯å…„å¼Ÿç»„ä»¶ä¹‹é—´å¦‚ä½•è¿›è¡Œé€šä¿¡ï¼Ÿç­”æ¡ˆæ˜¯åœ¨çˆ¶ç»„ä»¶ä¸­ç®¡ç† stateï¼Œé€šè¿‡ props ä¸‹å‘ç»™å„å­ç»„ä»¶ï¼Œå­ç»„ä»¶é€šè¿‡å›è°ƒæ–¹å¼ï¼Œè¿›è¡Œé€šä¿¡ã€‚

è¿™ä¼šå­˜åœ¨ä»€ä¹ˆé—®é¢˜ï¼Ÿå¦‚æœä½ æƒ³å…±äº«æ•°æ®ï¼Œä½ å¾—æŠŠæ‰€æœ‰éœ€è¦å…±äº«çš„ state é›†ä¸­æ”¾åˆ°ç»„ä»¶é¡¶å±‚ï¼Œç„¶ååˆ†å‘ç»™æ‰€æœ‰å­ç»„ä»¶ã€‚ä¸ºæ­¤ï¼Œéœ€è¦ä¸€ä¸ªåº“æ¥ä½œä¸ºæ›´åŠ ç‰›é€¼ã€ä¸“ä¸šçš„é¡¶å±‚ state å‘ç»™å„ç»„ä»¶ï¼Œäºæ˜¯ï¼Œæˆ‘å¼•å…¥äº† reduxã€‚

### 2. ä½“éªŒä¸ä½³

[redux](https://github.com/reduxjs/redux) å¯ä»¥è¯´æ˜¯è¾ƒæˆç†Ÿï¼Œç”Ÿæ€åœˆè¾ƒå®Œå–„çš„ä¸€ä¸ªåº“äº†ï¼Œæ­é… Â [redux-devtools-extension](https://github.com/zalmoxisus/redux-devtools-extension)Â  è¿™ä¸ª chrome æ’ä»¶ï¼Œè®©ä½ å¼€å‘æ›´åŠ å¿«ä¹ã€‚ç„¶ï¼Œä¸–é—´ä¸‡ç‰©ï¼Œçš†æœ‰åˆ©å¼Šã€‚

æœ¬èº«æˆ‘ä½¿ç”¨ redux ä¸ä¼šæœ‰æ‰€è°“çš„â€œç—›ç‚¹â€ï¼Œ**å› ä¸º redux é»˜è®¤åªæ”¯æŒåŒæ­¥æ“ä½œï¼Œè®©ä½¿ç”¨è€…è‡ªè¡Œé€‰æ‹©å¤„ç†å¼‚æ­¥ï¼Œå¯¹äºå¼‚æ­¥è¯·æ±‚ redux æ˜¯æ— èƒ½ä¸ºåŠ›çš„**ã€‚è¿™ä¹ˆè¯´å§ï¼Œå®ƒä¿è¯è‡ªå·±æ˜¯çº¯ç²¹çš„ï¼Œè„æ´»ç´¯æ´»ä¸¢ç»™åˆ«äººå»å¹²ã€‚

äºæ˜¯æˆ‘çš„ç—›ç‚¹åœ¨äºï¼šå¦‚ä½•å¤„ç†å¼‚æ­¥è¯·æ±‚ï¼Œä¸ºæ­¤æˆ‘ä½¿ç”¨äº† redux-saga å»è§£å†³å¼‚æ­¥é—®é¢˜ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨ Â `redux` + `redux-saga` ä¸­ï¼Œæˆ‘å‘ç°ï¼Œè¿™ä¼šè®©æˆ‘çš„ **[é‡å¤æ€§]** å·¥ä½œå˜å¤š(é€æ­¥æ™‹å‡ CV å·¥ç¨‹å¸ˆ)ï¼Œå› ä¸ºå®ƒåœ¨æˆ‘é¡¹ç›®ä¸­ï¼Œä¼šå­˜åœ¨å•°å—¦çš„æ ·æ¿ä»£ç ã€‚

ä¸¾ä¸ªä¾‹å­ï¼šå¼‚æ­¥è¯·æ±‚ï¼Œè·å–ç”¨æˆ·ä¿¡æ¯ï¼Œæˆ‘éœ€è¦åˆ›å»º Â `saga/user.js`ã€`reducers/user.js`ã€ä»¥åŠ `action/user.js`ï¼Œä¸ºäº†ç»Ÿä¸€ç®¡ç† constï¼Œæˆ‘å¯èƒ½è¿˜ä¼šæœ‰ä¸€ä¸ª Â `const/user.js`ï¼Œç„¶ååœ¨è¿™äº›æ–‡ä»¶ä¹‹é—´æ¥å›åˆ‡æ¢ã€‚ï¼ˆä»€ä¹ˆç©æ„ï¼Ÿï¼‰

```js
// const/user.js
const FETCH_USER_INFO = 'FETCH_USER_INFO';
const FETCH_USER_INFO_SUCCESS = 'FETCH_USER_INFO_SUCCESS';
```

```js
// actions/user.js
export function fetchUserInfo(params, callback) {
  return {
    type: FETCH_USER_INFO,
    params,
    callback,
  };
}
```

```js
// sagas/user.js
function* fetchUserInfoSaga({ params, callback }) {
  const res = yield call(fetch.callAPI, {
    actionName: FETCH_USER_INFO,
    params,
  });
  if (res.code === 0) {
    yield put({
      type: FETCH_USER_INFO_SUCCESS,
      data: res.data,
    });
    callback && callback();
  } else {
    throw res.msg;
  }
}
```

```js
// reducers/user.js
function userReducer(state, action) {
  switch (action.type) {
    case FETCH_USER_INFO_SUCCESS:
      return Immutable.set(state, 'userInfo', action.data);
  }
}
```

è¿™ç§æ ·æ¿ä»£ç ï¼Œç®€ç›´å°±æ˜¯ CV æ“ä½œï¼Œåªéœ€å¤åˆ¶ä¸€ä»½ï¼Œä¿®æ”¹ä¸€ä¸‹æ–‡ä»¶åã€å‚æ•°ç­‰ï¼Œå°±èƒ½å®ç°ä¸€ä¸ªè¯·æ±‚æµç¨‹ã€‚å¯¹æˆ‘ä¸ªäººè€Œè¨€ï¼Œè¿™ä¼šè®©æˆ‘ä¸å¤Ÿä¸“æ³¨ï¼Œåˆ†æ•£ç®¡ç† constã€actionã€sagaã€reducer ä¸€å¥—æµç¨‹ï¼Œéœ€è¦ä¸æ–­çš„è·³è·ƒæ€è·¯ã€‚éšç€æ–‡ä»¶æ•°é‡å˜å¤šï¼Œæˆ‘æ˜¯çœŸçš„ä¸å–œæ¬¢å¦‚æ­¤`ç¹ç`çš„æµç¨‹ï¼Œæœ‰æ²¡æœ‰å¥½çš„æ¡†æ¶èƒ½å¸®æˆ‘æŠŠè¿™äº›äº‹éƒ½åšå®Œå‘¢ï¼Ÿ

### 3. dva é€Ÿå¿ƒä¸¸ï¼Ÿ

> dvaï¼ŒåŸºäº redux å’Œ redux-saga çš„æ•°æ®æµæ–¹æ¡ˆï¼Œè®©ä½ åœ¨ä¸€ä¸ª model æ–‡ä»¶ä¸­å†™æ‰€æœ‰çš„ Â `actionã€stateã€effectã€reducers`ç­‰ï¼Œä¸ºäº†ç®€åŒ–å¼€å‘ä½“éªŒï¼Œå†…ç½®äº† react-router å’Œ fetch\*\*ã€‚

æˆ‘æ˜¯å¦‚ä½•çœ‹å¾… dva çš„ï¼Ÿä»å®˜æ–¹å£°æ˜æ¥çœ‹ï¼Œdva æ˜¯åŸºäº Â `redux`Â +Â `redux-saga`Â  çš„æ–¹æ¡ˆï¼Œåªæ˜¯åœ¨ä½ å†™çš„æ—¶å€™ï¼Œéƒ½å†™åœ¨ä¸€ä¸ª model æ–‡ä»¶ï¼Œç„¶åå®ƒå¸®ä½ åšä¸€äº›å¤„ç†ï¼›å…¶æ¬¡å®ƒæ˜¯ä¸€ä¸ªæ¡†æ¶ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªåº“ï¼Œæ˜¯å¦æ„å‘³ç€ï¼šæˆ‘åœ¨é¡¹ç›®å¼€å§‹ä¹‹å‰ï¼Œæˆ‘å°±éœ€è¦ç¡®å®šé¡¹ç›®çš„æ¶æ„æ˜¯ä¸æ˜¯ç”¨ dvaï¼Œå¦‚æœå¼€å‘ä¸€åŠï¼Œæˆ‘æƒ³æ¢æˆ dva è¿™ç§çŠ¶æ€ç®¡ç†çš„å†™æ³•ï¼Œè€Œå»å¼•å…¥ dva ï¼Œæ˜¯å¦ä¸åˆç†ï¼Ÿå†æˆ–è€…ï¼Œæˆ‘åªæ˜¯åšä¸€äº› demoã€å†™ç‚¹ä¸ªäººå°é¡¹ç›®ï¼Œä½†æˆ‘åˆæƒ³åƒå†™ dva çš„æ•°æ®çŠ¶æ€ç®¡ç† model é‚£ç§æ–¹å¼ï¼Œå¼•å…¥ dva æ˜¯ä¸æ˜¯åè€Œå˜å¾—ç¬¨é‡å‘¢ï¼Ÿ

### 4. è‡ªå·±æ‰€éœ€

å‡ºå‘ç‚¹ä¸ºï¼šåœ¨äºè§£å†³ç¹çé‡å¤çš„å·¥ä½œï¼Œstore æ–‡ä»¶åˆ†æ•£ï¼Œstate ç±»å‹å’Œèµ‹å€¼é”™è¯¯çš„é—®é¢˜ï¼Œä¸ºæ­¤ï¼Œæˆ‘æœŸæœ›ä¸ºè·Ÿæˆ‘ä¸€æ ·å›°æƒ‘çš„å°ä¼™ä¼´ï¼Œæä¾›ä¸€ä¸ªå†™çŠ¶æ€ç®¡ç†è¾ƒä¸º **[èˆ’æœ]** çš„ä¹¦å†™æ–¹å¼ï¼Œæ— ç¼å…¼å®¹åŸæœ‰é¡¹ç›®ï¼Œåªéœ€è¦å®‰è£…è¿™ä¸ªåŒ…ï¼Œå°±èƒ½å¼•å…¥ä¸€å¥—æ•°æ®ç®¡ç†æ–¹æ¡ˆï¼Œå†™èµ·æ¥åˆèˆ’æœç®€æ´ã€‚

## B. å¦‚ä½•å®ç° rc-redux-model

### 01. åˆå»ºé›å½¢

ç”±äºä¹‹å‰æœ‰é˜…è¯»è¿‡ `redux` çš„æºç ï¼ŒåŒæ—¶ä¹Ÿå¤§è‡´é˜…è¯»è¿‡ `redux-thunk` çš„æºç ï¼Œå¹¶ä¸”æŸ¥é˜…äº†ä¸€äº›ä¸ redux ç›¸å…³æ–‡ç« ï¼Œåœ¨æœ‰äº†ä¸€äº›çŸ¥è¯†å‚¨å¤‡ä¹‹åï¼Œå¼€å§‹ç€æ‰‹ç¼–å†™ç›¸å…³ä»£ç ã€‚ï¼ˆä¸‹é¢æˆ‘ä¼šä»‹ç»éƒ¨åˆ†çŸ¥è¯†ç‚¹ï¼‰

> å¦‚æœä½ å¯¹ redux æºç å­˜åœ¨ç–‘æƒ‘ï¼Œä½ ä¸å¦¨çœ‹çœ‹è¿™ç¯‡ [ã€KTã€‘è½»æ¾æå®š Redux æºç è§£è¯»ä¸ç¼–ç¨‹è‰ºæœ¯](https://juejin.cn/post/6844904183426973703)

åœ¨å‚è€ƒäº† dva å¯¹ model çš„å‚æ•°è¯´æ˜ï¼Œè¿›è¡Œå‚æ•°å®šä¹‰ï¼Œç”±äºæˆ‘æ²¡æœ‰ redux-saga ï¼Œæ‰€ä»¥æ˜¯æ²¡æœ‰ Â `effect`Â  è¿™ä¸ªå±æ€§çš„ï¼Œäºæ˜¯åˆæ­¥å¾—åˆ°æˆ‘çš„ model å‚æ•°

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/51a302b2e11b48f0b4a9e0f31c9c6bec~tplv-k3u1fbpfcp-watermark.image)

ä¸‹é¢æ˜¯ä¸€ä¸ª `model` çš„ç±»å‹çº¦æŸ

```ts
export interface RModel {
  namespace: string; // å‘½åç©ºé—´
  state: {
    [key: string]: any;
  };
  action?: {
    [key: string]: ({
      dispatch,
      getState,
      currentAction,
      commit,
      call,
    }) => void;
  };
  reducers?: {
    [key: string]: any;
  };
}
```

æŒ‰ç…§æˆ‘çš„è®¾æƒ³ï¼Œæˆ‘ä¼šå­˜åœ¨å¤šä¸ª model æ–‡ä»¶ï¼Œèšé›†åœ¨ä¸€èµ·ä¹‹åï¼Œå¾—åˆ°çš„æ˜¯ä¸€ä¸ªæ•°ç»„ :

```js
// model.js
import aModel from './aModel';
import bModel from './bModel';
import cModel from './cModel';

export default [aModel, bModel, cModel];
```

æˆ‘æ‰€å¸Œæœ›çš„æ˜¯ï¼šé€šè¿‡ä¼ å…¥ Â `RModel[]`ï¼Œå®ä¾‹åŒ– `RcReduxModel`ï¼Œå¾—åˆ°çš„å®ä¾‹å¸¦æœ‰ç»è¿‡å¤„ç†åçš„ reducers

- reducersï¼šæ‰€æœ‰ `model.reducers` é›†åˆï¼Œè¿™æ ·æˆ‘å¯ä»¥æ— éšœç¢çš„ç”¨åœ¨ Â `store.combineReducers`ä¸­ï¼Œå¯ä»¥å…¼å®¹ä½ ç°æœ‰çš„é¡¹ç›®ï¼Œå› ä¸ºåªè¦ä½ ç”¨äº† reduxï¼Œ é‚£ä¹ˆä½ è‚¯å®šå¾—é€šè¿‡ Â `combineReducers API`Â  å»é›†åˆæ‰€æœ‰çš„ reducers

```js
// createStore.js

// ğŸ‘‡ å¯¼å…¥èšé›†æ‰€æœ‰ modelï¼Œå¾—åˆ°çš„æ˜¯ä¸€ä¸ªæ•°ç»„
import models from './models';
import RcReduxModel from 'rc-redux-model';

const reduxModel = new RcReduxModel(models);

const reducerList = combineReducers(reduxModel.reducers);
return createStore(reducerList);
```

å› ä¸ºæˆ‘æƒ³åƒå†™ model é‚£æ ·ï¼Œæ‰€æœ‰ä¸œè¥¿éƒ½åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œè‡ªç„¶è€Œç„¶ï¼Œè¿™ä¸ª action é›†åˆ° model é‡Œè¾¹ä¹‹åï¼Œå¦‚ä½•å¤„ç†å¼‚æ­¥å°±æˆäº†æˆ‘éœ€è¦è§£å†³çš„ä¸€ä¸ªé—®é¢˜

### 02. å¼‚æ­¥å¤„ç†

æˆ‘å¯ä»¥å°† `redux-thunk`Â  æˆ– Â `redux-saga`Â  é›†æˆè¿›å»ï¼Œä½†æ„Ÿè§‰æ²¡å¿…è¦ã€‚å‡ºäºå¯¹è¿™ä¸¤ä¸ªåº“çš„å­¦ä¹ ï¼Œä»¥åŠåœ¨ä½¿ç”¨ä¸Šå¸¦ç»™æˆ‘çš„ **[ä½“éªŒ]**ï¼Œæˆ‘åœ¨æƒ³ï¼Œèƒ½ä¸èƒ½è‡ªè¡Œå¤„ç†ï¼Ÿäºæ˜¯ï¼Œæˆ‘å»å°† Â `redux-thunk`Â  çš„æºç çœ‹äº†ä¸€éã€‚

> redux-thunk ä¸­åˆ¤æ–­ä½ çš„ action æ˜¯ function è¿˜æ˜¯ objectï¼Œä»è€Œåˆ¤æ–­ä½ çš„ action æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥

æ€ä¹ˆç†è§£å‘¢ï¼Ÿå¤§å®¶è‚¯å®šéƒ½æœ‰å†™è¿‡åŒæ­¥ action æˆ–è€…å¼‚æ­¥ action

- åŒæ­¥ï¼šé€šè¿‡ dispatch å‘èµ·ä¸€ä¸ª actionï¼Œå»ä¿®æ”¹ redux çš„ state å€¼

- å¼‚æ­¥ï¼šé€šè¿‡ dispatch å‘èµ·ä¸€ä¸ª actionï¼Œç”±äº redux æ²¡æœ‰å¼‚æ­¥èƒ½åŠ›ï¼Œæ‰€ä»¥å€ŸåŠ© redux-thunk çš„èƒ½åŠ›ï¼Œredux-thunk å‘ç°ä½ å‘èµ·çš„ action å¹¶ä¸æ˜¯ä¸€ä¸ª objectï¼Œè€Œæ˜¯ä¸€ä¸ª functionï¼Œå®ƒå°±ä¼šå»å¸®ä½ æŠŠè¯·æ±‚å‘å‡ºï¼Œå½“è¯·æ±‚å¤„ç†å®Œåï¼Œå¾—åˆ°æ•°æ®ï¼Œä½ å†å‘èµ·ä¸€ä¸ªåŒæ­¥çš„ action å»ä¿®æ”¹ redux çš„ state å€¼

æœ€åå¾—å‡ºäº†ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼š**åœ¨ Â `rc-redux-model`Â  ä¸­ï¼Œæ¯ä¸€ä¸ª action éƒ½æ˜¯å¼‚æ­¥çš„ï¼Œä¹Ÿå°±æ˜¯ä½ å‘èµ·çš„æ¯ä¸€ä¸ª actionï¼Œéƒ½æ˜¯å‡½æ•°**ã€‚

```js
aModel = {
  state: {
    a: '',
  },
  action: {
    // è¿™ä¸¤ä¸ª action éƒ½æ˜¯ function
    firstAction: ({ getState, dispatch }) => {},
    secondAction: ({ getState, dispatch }) => {},
  },
};
```

å³ä½¿ä½ æƒ³è¦å‘èµ·ä¸€ä¸ªåŒæ­¥ actionï¼Œå»ä¿®æ”¹ state çš„å€¼ï¼Œæˆ‘ä¹Ÿä¼šå°†å…¶ä½œä¸ºå¼‚æ­¥è¿›è¡Œå¤„ç†ï¼Œä¹Ÿå°±æ˜¯ä½ ä¿®æ”¹ state å€¼ï¼Œä½ éœ€è¦è¿™ä¹ˆå†™

```js
// component.js

// ğŸ‘‡ 1. å‘èµ·ä¸€ä¸ª action ç”¨äºä¿®æ”¹ state å€¼
this.props.dispatch({
  type: 'aModel/setStateA',
  payload: '666',
});
```

```js
// aModel.js

aModel = {
  namespace: 'aModel',
  state: {
    a: '111',
  },
  action: {
    // ğŸ‘‡ 2. è¿™æ˜¯å¼‚æ­¥actionï¼Œåœ¨è¿™é‡Œä½ å¯ä»¥åšå¼‚æ­¥è¯·æ±‚ï¼Œä¹Ÿå¯ä»¥åšåŒæ­¥å¤„ç†
    // æ€»ä¹‹ï¼Œå¼‚æ­¥æˆ–åŒæ­¥ï¼Œéƒ½éœ€è¦ç»è¿‡è¿™é‡Œçš„â€œè½¬å‘â€ï¼Œå†å»ä¿®æ”¹ state å€¼
    setStateA: ({ currentAction, dispatch }) => {
      dispatch({
        type: 'aModel/CHANGE_STATE_A',
        payload: currentAction.payload,
      });
    },
  },
  reducers: {
    ['CHANGE_STATE_A'](state, payload) {
      return {
        ...state,
        a: payload,
      };
    },
  },
};
```

æ˜ç¡®äº†è¿™ä¸¤ç‚¹ï¼Œæ¥ä¸‹æ¥å°±åªéœ€è¦å¼€å‘å³å¯ã€‚å¼€å‘æ¥ä¸‹æ¥æˆ‘ä¼šè®²åˆ°ï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹

### 03. æé«˜ä½“éªŒ

ç”±äºæ¯ä¸ª actionï¼Œéƒ½éœ€è¦å°ä¼™ä¼´ä»¬è‡ªå·±å»å†™ï¼Œæåº¦éº»çƒ¦ï¼Œä»¥ä¸‹é¢è¿™ä¸ªä¾‹å­è¯´æ˜

æˆ‘æƒ³è¦ä¿®æ”¹ state ä¸­çš„ a å€¼ï¼Œéœ€è¦è‡ªå·±å†™ actionã€reducers

```js
// aModel.js

aModel = {
  namespace: 'aModel',
  state: {
    a: '111',
  },
  action: {
    // ğŸ‘‡ 2. è¿™æ˜¯å¼‚æ­¥actionï¼Œåœ¨è¿™é‡Œä½ å¯ä»¥åšå¼‚æ­¥è¯·æ±‚ï¼Œä¹Ÿå¯ä»¥åšåŒæ­¥å¤„ç†
    // æ€»ä¹‹ï¼Œå¼‚æ­¥æˆ–åŒæ­¥ï¼Œéƒ½éœ€è¦ç»è¿‡è¿™é‡Œçš„â€œè½¬å‘â€ï¼Œå†å»ä¿®æ”¹ state å€¼
    setStateA: ({ currentAction, dispatch }) => {
      dispatch({
        type: 'aModel/CHANGE_STATE_A',
        payload: currentAction.payload,
      });
    },
  },
  reducers: {
    ['CHANGE_STATE_A'](state, payload) {
      return {
        ...state,
        a: payload,
      };
    },
  },
};
```

å‡è®¾æˆ‘ç°åœ¨æœ‰ 20 ä¸ª stateï¼Œæ„å‘³ç€æˆ‘å¾—åœ¨ model.action ä¸­ï¼Œå†™å¯¹åº”çš„ 20 ä¸ªä¿®æ”¹ state çš„ actionï¼Œç„¶ååœ¨ model.reducers ä¸­åŒæ ·å†™ 20 ä¸ªç›¸å¯¹åº”çš„ reducerï¼Œé‚£ä¹ˆå°±ä¼šä½¿å¾—è¯¥æ–‡ä»¶ä»£ç é‡æå¤§ï¼Œé‚£è·Ÿä¸€å¼€å§‹å†™ redux åŒºåˆ«åœ¨å“ªï¼Ÿçœ‹èµ·æ¥åªæ˜¯å°† stateã€actionã€reducers æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶è€Œå·²ã€‚**å¹¶æ²¡æœ‰çœŸæ­£çš„è§£å†³ç¹çé‡å¤çš„å·¥ä½œ**ã€‚

äºæ˜¯æˆ‘æƒ³åˆ°äº†è§£å†³æ–¹æ¡ˆï¼šæä¾›ä¸€ä¸ªé»˜è®¤çš„ actionï¼Œå¤§å®¶éƒ½é€šè¿‡è¿™ä¸ª action
å»ä¿®æ”¹ state å€¼ã€‚ä½†è¿™ä¼šæœ‰ä¸ªé—®é¢˜ï¼Œæ‰€æœ‰ä¿®æ”¹ state çš„ actionï¼Œéƒ½èµ°åŒä¸€ä¸ª Â `action.type`ï¼Œé‚£ä¹ˆåœ¨ Â [redux-devtools-extension](https://github.com/zalmoxisus/redux-devtools-extension)Â  ä¸­ï¼Œæ˜¯å¾ˆéš¾å‘ç°è¿™ä¸ª action è§¦å‘ï¼Œå…·ä½“æ˜¯ä¸ºäº†ä¿®æ”¹å“ªä¸ª state å€¼ã€‚

å¦‚ä½•è§£å†³æ­¤é—®é¢˜å‘¢ï¼Ÿæœ€ç»ˆçš„è§£å†³æ–¹æ¡ˆå°±æ˜¯ï¼š**ä¸ºæ¯ä¸€ä¸ª state ï¼Œè‡ªåŠ¨æ³¨å†Œå¯¹åº”çš„ action å’Œ reducerï¼Œ åŒæ—¶å†æä¾›äº†ä¸€ä¸ªé»˜è®¤çš„ action(setStore)**

> âœ¨Â  ä¾‹ : state æœ‰ n ä¸ªå€¼ï¼Œé‚£ä¹ˆæœ€ç»ˆä¼šè‡ªåŠ¨æ³¨å†Œ n+1 ä¸ª actionï¼Œç”¨æˆ·åªéœ€è¦è®°ä½å¹¶è°ƒç”¨é»˜è®¤çš„è¿™ä¸ª action(setStore) å³å¯

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/16444ad9771242c9a09aa9f911933d2c~tplv-k3u1fbpfcp-watermark.image)

ç”¨æˆ·åªéœ€è¦è°ƒç”¨é»˜è®¤æä¾›çš„ Â `setStore`Â  å³å¯ï¼Œç„¶åæ ¹æ® key è¿›è¡Œåˆ¤æ–­ï¼Œä»è€Œè½¬å‘åˆ°å¯¹åº”åˆ° action ä¸Š

```js
this.props.dispatch({
  type: '[model.namespace]/setStore',
  payload: {
    key: `${model.state.key}`,
    values: `${your values}`
  },
})
```

ç”±äº `setStore` æ¯æ¬¡éƒ½åªèƒ½ä¿®æ”¹ä¸€ä¸ª state å€¼ï¼Œå¦‚æœåœ¨åŒä¸€æ—¶åˆ»ï¼Œæƒ³ä¿®æ”¹ m ä¸ª state å€¼ï¼Œå°±å¾—å‘ m ä¸ª actionï¼Œäºæ˜¯æˆ‘åˆæ·»åŠ äº†ä¸€ä¸ª `setStoreList`

```js
this.props.dispatch({
  type: '[model.namespace]/setStoreList',
  payload: [
    {
      key: `${model.state.key}`,
      values: `${your values}`
    },
    {
      key: `${model.state.key}`,
      values: `${your values}`
    }
  ]
})
```

### 04. æ•°æ®ä¸å¯å˜

åœ¨å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œæ•°æ®æ˜¯ä¸å¯å˜çš„ï¼Œ[(è¿™ä¹Ÿæ˜¯å®˜æ–¹è¯´çš„)](http://cn.redux.js.org/tutorials/essentials/part-1-overview-concepts#%E4%B8%8D%E5%8F%AF%E5%8F%98%E6%80%A7-immutability)ï¼Œæ‰€æœ‰çš„æ•°æ®ä¸€æ—¦äº§ç”Ÿï¼Œå°±ä¸èƒ½æ”¹å˜å…¶ä¸­çš„å€¼ï¼Œå¦‚æœè¦æ”¹å˜ï¼Œé‚£å°±åªèƒ½ç”Ÿæˆä¸€ä¸ªæ–°çš„æ•°æ®ã€‚ç”±äºç°åœ¨å¾ˆå¤šé¡¹ç›®éƒ½ä¼šä½¿ç”¨ Â `seamless-immutable`ï¼Œé‚£ä¹ˆåœ¨ä¸šåŠ¡ä¸­çš„ `model.state` ä¸­ï¼Œä½¿ç”¨äº† Immutable åŒ…è£¹äº† stateï¼Œç„¶åè°ƒç”¨é»˜è®¤æä¾›çš„ actionï¼Œæœ€åä¼šæŠ¥é”™ï¼Œæ‡‚çš„éƒ½æ‡‚ !

é‚£ä¹ˆè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿå†…éƒ¨æ”¯æŒ Immutable ï¼Œæä¾›ä¸€ä¸ªé…ç½®å‚æ•° `openSeamlessImmutable`ï¼Œé»˜è®¤ä¸º falseï¼Œå¦‚æœä½ ä¸šåŠ¡ä¸­çš„ state æ˜¯ Immutableï¼Œè€Œåœ¨ model ä¸­ä¸è®¾ç½®æ­¤é…ç½®ï¼Œé‚£ä¹ˆä¼šæŠ¥é”™ã€‚

```js
// ä½¿ç”¨ seamless-immutable

import Immutable from 'seamless-immutable';

export default {
  namespace: 'appModel',
  state: Immutable({}),
  openSeamlessImmutable: true, // å¿…é¡»å¼€å¯æ­¤é…ç½®
};
```

### 05. å¤„ç†ç±»å‹ä¸ä¸€è‡´

è¿™ä¹Ÿæ˜¯æˆ‘æœ‰æ—¶å€™çŠ¯çš„é”™è¯¯ï¼Œç‰¹åˆ«æ˜¯åœ¨æ²¡æœ‰ TypeScript çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æœ‰æ—¶åœ¨ Â `model.state`Â  ä¸­å®šä¹‰å¥½æŸä¸ªå€¼çš„ç±»å‹ï¼Œä½†åœ¨æ”¹çš„æ—¶å€™å´å°†å…¶æ”¹ä¸ºå¦ä¸€ä¸ªç±»å‹ï¼Œæ¯”å¦‚

```js
export default {
  namespace: 'userModel',
  state: {
    name: '', // è¿™é‡Œå®šä¹‰ name ä¸º string ç±»å‹
  },
};
```

ä½†åœ¨ä¿®æ”¹æ­¤ state value æ—¶ï¼Œä¼ é€’çš„ç¡®æ˜¯ä¸€ä¸ªé string ç±»å‹çš„å€¼

```js
this.props.dispatch({
  type: 'userModel/setStore',
  payload: {
    key: 'name',
    values: {}, // è¿™é‡Œ name å˜æˆäº†object
  },
});
```

è¿™å…¶å®æ˜¯ä¸åˆç†çš„ï¼Œåœ¨ rc-redux-model ä¸­ï¼Œä¼šé’ˆå¯¹éœ€è¦ä¿®æ”¹çš„ Â `state[key]`Â  åšç±»å‹æ£€æµ‹å¤„ç†

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/98b7d90ef77c4f43b7a739dde95a1a92~tplv-k3u1fbpfcp-watermark.image)

åŒæ—¶åš `state[key]` å­—æ®µçš„å¤„ç†

```js
export default {
  namespace: 'userModel',
  state: {
    name: '', // è¿™é‡Œåªå®šä¹‰ state ä¸­å­˜åœ¨ name
  },
};
```

æ­¤æ—¶æƒ³ä¿®æ”¹ state ä¸­çš„å¦ä¸€å±æ€§å€¼

```js
this.props.dispatch({
  type: 'userModel/setStore',
  payload: {
    key: 'testName',
    values: '1', // è¿™é‡Œæƒ³ä¿®æ”¹ testName å±æ€§çš„å€¼
  },
});
```

æåº¦ä¸åˆç†ï¼Œå› ä¸ºä½ åœ¨ state ä¸­å¹¶æ²¡æœ‰å£°æ˜æ­¤å±æ€§ï¼Œ rc-redux-model ä¼šé»˜è®¤å¸®ä½ åšæ£€æµ‹

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/297af08ca0b94602b30009c52791d0b8~tplv-k3u1fbpfcp-watermark.image)

### C. æ ¸å¿ƒæºç è§£è¯»

ä¸Šè¯‰æ›´å¤šçš„æ˜¯å¯¹ä¸­é—´ä»¶çš„æ€è€ƒå’ŒåŠŸèƒ½çš„è®¾è®¡ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç»“åˆä»£ç ï¼Œæ¥çœ‹çœ‹ä¸€æ¬¾ redux ä¸­é—´ä»¶è¯¥å¦‚ä½•å¼€å‘ã€‚åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘å¸Œæœ›ä½ èƒ½å¯¹ redux æœ‰ä¸€å®šçš„äº†è§£ï¼Œæˆ‘ç»™ä½ ä»¬å‡†å¤‡äº†å‡ ç¯‡æ–‡ç« ï¼Œéƒ½æ˜¯æˆ‘åœ¨å¼€å‘ä¸­é—´ä»¶å‰çœ‹çš„æ–‡ç« å†…å®¹ï¼Œå¦‚æœä½ æ„Ÿå…´è¶£ï¼Œå¯ä»¥ç‚¹å‡»ä¸‹æ–¹é“¾æ¥æŸ¥çœ‹

- [è½»æ¾æå®š Redux æºç è§£è¯»ä¸ç¼–ç¨‹è‰ºæœ¯](https://juejin.cn/post/6844904183426973703)
- [redux ä»è®¾è®¡åˆ°æºç â€”â€”ç¾å›¢æŠ€æœ¯å›¢é˜Ÿ](https://tech.meituan.com/2017/07/14/redux-design-code.html)
- [redux ä¹‹æ´‹è‘±æ¨¡å‹çš„æºç åˆ†æä¸æ„Ÿæ‚Ÿ](https://cloud.tencent.com/developer/news/41333)
- [æ·±å…¥æµ…å‡º Event Sourcing å’Œ CQRS](https://cloud.tencent.com/developer/news/41333)
- [âœ¨ redux å®˜æ–¹æ•™ç¨‹ï¼ˆæ¨èï¼‰](http://cn.redux.js.org/tutorials/essentials/part-1-overview-concepts)

> æœ€èµ·ç ä¸Šé¢ Part B éƒ¨åˆ†ä¸­çš„ actionã€reducer ç­‰ä½ éƒ½å¾—æ˜ç™½å§ï¼Ÿä½ å¾—çŸ¥é“ä¸€ä¸ª action æ˜¯æ€æ ·çš„ï¼Œreducer æ˜¯æ€æ ·çš„ï¼Œä¸ç„¶ä¸‹é¢ä½ ç†è§£æ—¶ä¼šéå¸¸å›°éš¾ã€‚

çœ‹å®Œä¹‹åï¼Œæˆ‘ä»¬éœ€è¦æŒæ¡å‡ ä¸ªæœ€åŸºç¡€ä¸”é‡è¦çš„è¯æ±‡ï¼š`å‡½æ•°å¼ç¼–ç¨‹`ã€`compose`ã€`æ´‹è‘±æ¨¡å‹`ï¼Œä¸è¦æ€¥ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸ªæ¥è¿‡çŸ¥è¯†ç‚¹ã€‚

#### å‡½æ•°å¼ç¼–ç¨‹

1. å‡½æ•°æ˜¯ç¬¬ä¸€ç­‰å…¬æ°‘

æ€ä¹ˆç†è§£ï¼Œåœ¨ JS ä¸­ï¼Œå‡½æ•°å¯ä»¥å½“ä½œæ˜¯å˜é‡ä¼ å…¥ï¼Œä¹Ÿå¯ä»¥èµ‹å€¼ç»™ä¸€ä¸ªå˜é‡ï¼Œç”šè‡³äºï¼Œå‡½æ•°æ‰§è¡Œçš„è¿”å›ç»“æœä¹Ÿå¯ä»¥æ˜¯å‡½æ•°ã€‚

```js
const func = function () {};

// 1. å½“ä½œå‚æ•°
function demo1(func) {}

// 2. èµ‹å€¼ç»™å¦ä¸€ä¸ªå˜é‡
const copy_func = func;

// 3. å‡½æ•°æ‰§è¡Œçš„è¿”å›ç»“æœæ˜¯å‡½æ•°
function demo2() {
  return func;
}
```

2. æ•°æ®æ˜¯ä¸å¯å˜çš„(Immutable)

åœ¨å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œæ•°æ®æ˜¯ä¸å¯å˜çš„ï¼Œæ‰€æœ‰çš„æ•°æ®ä¸€æ—¦äº§ç”Ÿï¼Œå°±ä¸èƒ½æ”¹å˜å…¶ä¸­çš„å€¼ï¼Œå¦‚æœè¦æ”¹å˜ï¼Œé‚£å°±åªèƒ½ç”Ÿæˆä¸€ä¸ªæ–°çš„æ•°æ®ã€‚

æ‰€ä»¥æˆ‘ä»¬åœ¨ redux ä¸­å¼ºè°ƒäº†ï¼Œä¸èƒ½ç›´æ¥ä¿®æ”¹ state çš„å€¼ï¼Œ**[ä»£ç å¿…éœ€å…ˆå¤åˆ¶åŸæ¥çš„ object/arrayï¼Œç„¶åæ›´æ–°å®ƒçš„å¤åˆ¶ä½“ã€‚Redux æœŸæœ›æ‰€æœ‰çŠ¶æ€æ›´æ–°éƒ½æ˜¯ä½¿ç”¨ä¸å¯å˜çš„æ–¹å¼](http://cn.redux.js.org/tutorials/essentials/part-1-overview-concepts#%E4%B8%8D%E5%8F%AF%E5%8F%98%E6%80%A7-immutability)ã€‚**

> é¢å¤–è¡¥å……ä¸€ä¸‹ï¼Œä¸‹è¾¹çš„ä¸¤å¥è¯å¼•ç”¨æ¥è‡ª `Dan Abramov` çš„åšå®¢: [How Are Function Components Different from Classes?](https://overreacted.io/how-are-function-components-different-from-classes/) åœ¨ react ä¸­ï¼Œæˆ‘ä»¬ä» `this.props.xxx` ä¸­è¯»å–æ•°æ®ã€‚ä¸ºä»€ä¹ˆæˆ‘ä»¬å¯ä»¥å¾—åˆ°æœ€æ–°çš„å®ä¾‹ï¼Ÿå…¶å®ä¸æ˜¯å› ä¸º props æ”¹å˜äº†ï¼Œåœ¨ react ä¸­ï¼Œprops æ˜¯ä¸å¯å˜(immutable)çš„ï¼Œä»–ä»¬æ°¸è¿œä¸ä¼šæ”¹å˜ã€‚ç„¶è€Œï¼Œthis æ˜¯å¯å˜(mutable)çš„ã€‚è¿™å°±æ˜¯ react ç±»ç»„ä»¶ this å­˜åœ¨çš„æ„ä¹‰ã€‚

3. å‡½æ•°åªæ¥å—ä¸€ä¸ªå‚æ•°

æ€ä¹ˆç†è§£ï¼Œå¤§ä¼™ä¼°è®¡éƒ½å†™äº†å¾ˆä¹…çš„å¤šå‚æ•°ï¼Œçœ‹åˆ°è¿™ä¸ªæ‡µäº†å•Šï¼Œæˆ‘ä¹Ÿæ‡µäº†ï¼Œä½†æ˜¯è¿™å°±æ˜¯è§„çŸ©ï¼Œæ— è§„çŸ©ï¼Œä¸æˆæ–¹åœ† ï½

æ‰€ä»¥å½“ä½ çœ‹**ä¸­é—´ä»¶**çš„ä»£ç æ—¶ï¼Œä½ å°±ä¸ä¼šå¥‡æ€ªäº†ï¼Œæ¯”å¦‚è¿™è¡Œä»£ç  ï½

```ts
const middleware = (store) => (next) => (action) => {};
```

æ¢æˆæˆ‘ä»¬èƒ½å¤Ÿç†è§£çš„å½¢å¼ï¼Œé‚£å°±æ˜¯ :

```ts
const middleware = (store) => {
  return (next) => {
    return (action) => {};
  };
};
```

è¿™é‡Œæœ‰äººå°±ç–‘é—®äº†ï¼Œè¿™ä¸å°±æ˜¯ä¾èµ–äº†ä¸‰ä¸ªå‚æ•°å—ï¼Œé‚£èƒ½ä¸èƒ½è¿™æ ·å†™å•Šï¼Ÿ

```js
const middleware = (store, next, action) => {};
```

å¯ä»¥ï¼Œä½†è¿™æ˜¯è§„çŸ©ï¼Œæ˜¯å‡½æ•°å¼ç¼–ç¨‹å°±æ˜¯è¦æ±‚åªèƒ½æœ‰ä¸€ä¸ªå‚æ•°ï¼Œæ‡‚ ?

#### ç»„åˆ compose

è¯´è¯´ç»„åˆ composeï¼Œè¿™ä¸ªæ˜¯ä¸ªå•¥ç©æ„ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€æ®µä»£ç  :

```js
const compose = (f, g) => {
  return (x) => {
    return f(g(x));
  };
};

const add = function (x) {
  return x + 2;
};

const del = function (x) {
  return x - 1;
};

// ä½¿ç”¨ç»„åˆå‡½æ•°ï¼ŒğŸ§¬ åŸºå› çªå˜ï¼Œå¼ºå¼ºè”åˆ
const composeFunction = compose(add, del)(100);
```

çŒœä¸€ä¸‹ï¼Œæ‰§è¡Œ composeFunction æ‰“å°ä»€ä¹ˆï¼Ÿç­”å¯¹çš„ï¼Œç»™è‡ªå·±é¼“ä¸ªæŒ ğŸ‘

å¥½äº†ï¼Œæˆ‘å·²ç»æŠŠæœ€ä¸ºå¼ºå¤§çš„å¿æœ¯ï¼šå‡½æ•°å¼ç¼–ç¨‹æœ¯è¯­ä¹‹ compose ç»„åˆå‡½æ•°ï¼Œæ•™ç»™ä½ äº†ï½ ä½ å¤šçœ‹å‡ éï¼Œä¹‹åä½ çœ‹ redux çš„æºç ä½ å°±æœ‰ç§é†é†çŒåœ°çš„æ„Ÿè§‰ã€‚

#### æ´‹è‘±æ¨¡å‹

æ´‹è‘±æ¨¡å‹æ˜¯æœ¬è´¨ä¸Šæ˜¯ä¸€å±‚å±‚çš„å¤„ç†é€»è¾‘ï¼Œè€Œåœ¨å‡½æ•°å¼ç¼–ç¨‹ä¸–ç•Œé‡Œï¼Œæ„å‘³ç€ç”¨å‡½æ•°æ¥åšå¤„ç†å•å…ƒã€‚å…ˆä¸è¯´å…¶ä»–ï¼Œæˆ‘ä»¬å…ˆä¸Šä¸€ä¸ªä¾‹å­ï¼Œå¸®åŠ©å¤§å®¶ç†è§£ï½

```js
let middleware = [];
middleware.push((next) => {
  console.log('A');
  next();
  console.log('A1');
});
middleware.push((next) => {
  console.log('B');
  next();
  console.log('B1');
});
middleware.push((next) => {
  console.log('C');
});

// è¿™é‡Œçš„ run ä¸ç”¨ care
let func = run(middleware);
func();
```

çŒœçŒœæ‰“å°é¡ºåºæ˜¯ä¸ªå•¥ ï¼Ÿæ²¡é”™ï¼Œæ‰“å°ç»“æœä¸º : A -> B -> C -> B1 -> A1

å½“ç¨‹åºè¿è¡Œåˆ° `next()` çš„æ—¶å€™ä¼šæš‚åœå½“å‰ç¨‹åºï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ï¼Œå¤„ç†å®Œä¹‹åæ‰ä¼šä»”å›è¿‡å¤´æ¥ç»§ç»­å¤„ç†ã€‚

<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c6c7365ec7224aae815de0b4ddaa72fb~tplv-k3u1fbpfcp-zoom-1.image" width=200 />

æˆ‘ä»¬çœ‹è¿™å¼ å›¾ï¼Œå¾ˆæœ‰æ„æ€ï¼Œä¼šæœ‰ä¸¤æ¬¡è¿›å…¥åŒä¸€ä¸ªä¸­é—´ä»¶çš„è¡Œä¸ºï¼Œè€Œä¸”æ˜¯åœ¨æ‰€æœ‰ç¬¬ä¸€æ¬¡çš„ä¸­é—´ä»¶æ‰§è¡Œä¹‹åï¼Œæ‰ä¾æ¬¡è¿”å›ä¸Šä¸€ä¸ªä¸­é—´ä»¶ã€‚ä½ å“ï¼Œä½ ç»†å“ï½

<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/09c6b76fffb64795bcd663f883bb3a75~tplv-k3u1fbpfcp-zoom-1.image" width=200 />

å¦‚æœä½ èƒ½çœ‹æ‡‚ä¸Šé¢è¿™æ®µä¸­é—´ä»¶çš„ä»£ç ï¼Œé‚£ä¹ˆæˆ‘ç¨å¾®æ”¹å†™ä¸€ä¸‹ï¼Œä½ ä¹Ÿåº”è¯¥çœ‹å¾—æ‡‚

```js
function f1(store) {
  return function (next) {
    return function (action) {
      console.log('step1 ä¸­é—´ä»¶1 å¼€å§‹');
      next(action);
      console.log('step2 ä¸­é—´ä»¶1 ç»“æŸ');
    };
  };
}

function f2(store) {
  return function (next) {
    return function (action) {
      console.log('step3 ä¸­é—´ä»¶2 å¼€å§‹');
      next(action);
      console.log('step4 ä¸­é—´ä»¶2 ç»“æŸ');
    };
  };
}

function f3(store) {
  return function (next) {
    return function (action) {
      console.log('step5 ä¸­é—´ä»¶3 å¼€å§‹');
      next(action);
      console.log('step6 ä¸­é—´ä»¶3 ç»“æŸ');
    };
  };
}

function reducer(state, action) {
  if (action.type === 'INIT_STORE') {
    console.log('æˆ‘æ˜¯å¤§å¸…å“¥');
  }
  return {};
}

var store = Redux.createStore(reducer, Redux.applyMiddleware(f1, f2, f3));

store.dispatch({ type: 'INIT_STORE' });
```

è¿™æ—¶å€™æƒ³å¿…å¤§å®¶è¿˜æ˜¯æœ‰äº›éš¾ä»¥ç†è§£ï¼Œå¤§æ¦‚è§£è¯»ä¸€ä¸‹ï¼Œåœ¨è¿™ä¸ªç¤ºä¾‹ä»£ç ä¸­ï¼Œæ´‹è‘±æ¨¡å‹è¿è¡Œè¿‡ç¨‹å°±æ˜¯ï¼š

æ´¾å‘ action â†’ ç»è¿‡ `applyMiddleware API` çš„ç»„åˆ -> action ä¼ å…¥ f1 å‰¯ä½œç”¨ â†’ æ‰“å° step1 â†’ æ‰§è¡Œ f1 çš„ nextï¼ˆè¿™ä¸ª next æŒ‡å‘ f2 å‰¯ä½œç”¨ï¼‰â†’ æ‰“å° step3 â†’ æ‰§è¡Œ f2 çš„ nextï¼ˆè¿™ä¸ª next æŒ‡å‘ f3 å‰¯ä½œç”¨ï¼‰â†’ æ‰“å° step5 â†’ æ‰§è¡Œ f3 çš„ nextï¼ˆè¿™ä¸ª next æŒ‡å‘`store.dispatch`ï¼‰â†’ æ‰§è¡Œå®Œæ¯• -> æ‰“å°æˆ‘æ˜¯å¤§å¸…å“¥ -> è¿”å›åˆ° f3 å‰¯ä½œç”¨æ‰“å° step6 â†’ è¿”å›åˆ° f2 æ‰“å° step4 â†’ è¿”å›åˆ° f1 å‰¯ä½œç”¨æ‰“å° step2 -> dispatch æ‰§è¡Œå®Œæ¯•ã€‚

æœ‰äººå°±ä¼šå¥½å¥‡äº†ï¼Œè¿™é‡Œçš„ `next` åˆ°åº•æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Œå…¶å®ä»–å°±æ˜¯ `store.dispatch`ï¼Œæœ‰ç‚¹é¥¶ï¼Ÿæˆ‘ä»¬æ¥æ¢³ç†ä¸€ä¸‹ã€‚

å¦‚æœä½ è¿˜ä¸å¤ªèƒ½ç†è§£ï¼Œè¯·æ”¾è½»æ¾ï¼Œå…ˆæŠŠä¸Šè¾¹æˆ‘ç»™çš„å‡ ä¸ªé“¾æ¥æ–‡ç« çœ‹ä¸€çœ‹ï¼Œå¹¶ä¸”å»æœç´¢ç›¸å…³çŸ¥è¯†ï¼Œè‡ªå·±è¡¥å……è¡¥å……çŸ¥è¯†ã€‚å¦‚æœä½ èƒ½çœ‹æ‡‚ä¸Šé¢è¿™æ®µä¸­é—´ä»¶çš„ store ä¾‹å­ï¼Œé‚£ä¹ˆè¯·æ·±å‘¼å¸ä¸€å£æ°”ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å†æ·±å…¥ä¸€ç‚¹ã€‚çœ‹çœ‹ `applyMiddleware` çš„æºç ï¼Œä¸è¦æ€€ç–‘ï¼Œè¿™çœŸçš„æ˜¯ redux çš„æºç ã€‚

```ts
export default function applyMiddleware(...middlewares) {
  return (createStore) =>
    (reducer, ...args) => {
      const store = createStore(reducer, ...args);
      let dispatch: Dispatch = () => {};

      const middlewareAPI = {
        getState: store.getState,
        dispatch: (action, ...args) => dispatch(action, ...args),
      };

      const chain = middlewares.map((middleware) => middleware(middlewareAPI));
      dispatch = compose(...chain)(store.dispatch);

      return {
        ...store,
        dispatch,
      };
    };
}
```

çŸ­çŸ­åå‡ è¡Œä»£ç ï¼Œå°†æˆ‘ä»¬ä¸Šè¾¹è¯´çš„çŸ¥è¯†ç‚¹éƒ½åŒ…å«äº†ã€‚ä¸è¦æ€€ç–‘ï¼Œè¿™å°±æ˜¯æºç ï¼Œå…ˆè¯•ç€ç†è§£ä¸€ä¸‹ã€‚

é¦–å…ˆï¼Œä¼ å…¥äº†ä¸€ä¸ªä¸­é—´ä»¶æ•°ç»„ `middlewares`ï¼Œæˆ‘ä»¬å°†å®ƒè¿›è¡Œå‰¥çš®ï¼Œå¹¶ç»™ä¸­é—´ä»¶ middleware éƒ½ä»¥æˆ‘ä»¬å®šä¹‰çš„ middlewareAPI ä½œä¸ºå‚æ•°æ³¨å…¥ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¯ä¸€ä¸ªä¸­é—´ä»¶çš„ä¸Šä¸‹æ–‡æ˜¯ dispatch å’Œ getStateï¼Œä¸ºä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆè¦æ³¨å…¥è¿™ä¸¤ä¸ªç©æ„ï¼Ÿå› ä¸º

- getStateï¼šæ¯ä¸€å±‚æ´‹è‘±éƒ½å¯ä»¥è·å–åˆ°å½“å‰çš„çŠ¶æ€ã€‚
- dispatchï¼šä¸ºäº†å¯ä»¥å°†æ“ä½œä¼ é€’ç»™ä¸‹ä¸€ä¸ªæ´‹è‘±ã€‚

é‚£å®ƒæ˜¯å¦‚ä½•ç»™æ¯ä¸€ä¸ª middleware æ³¨å…¥çš„å‘¢ï¼Ÿçœ‹è¿™æ®µä»£ç ï¼š

```ts
const chain = middlewares.map((middleware) => middleware(middlewareAPI));
```

éå† middlewaresï¼Œç„¶åæ¯ä¸€ä¸ªä¸­é—´ä»¶éƒ½æ³¨å…¥ `store.getState` å’Œ `store.dispatch`ï¼Œé‚£ç»è¿‡è¿™æ ·å¤„ç†ä¹‹åï¼Œchain æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Ÿ

å¾ˆå¥½ç†è§£ï¼Œä¸Šé¢è¯´è¿‡äº†å‡½æ•°å¼ç¼–ç¨‹çš„è¦ç‚¹ï¼šå‡½æ•°åªæ¥å—ä¸€ä¸ªå‚æ•°ï¼Œå†å¤ä¹ ä¸€ä¸‹è¿™æ®µä»£ç 

```ts
const middleware = (store, next, action) => {};
```

æ˜¯å¦æœ‰äº›çœ¼ç†Ÿï¼Œæ”¹å†™æˆæˆ‘ä»¬ç†ŸçŸ¥çš„å‡½æ•°å¼ç¼–ç¨‹ï¼Œå°±å˜æˆä¸‹é¢è¿™æ ·äº†

```ts
const middleware = (store) => (next) => (action) => {};
```

ä¹Ÿå°±æ˜¯è¯´ï¼Œchain å…¶å®æ˜¯ä¸€ä¸ª `(store) => (next) => (action) => {}` å‡½æ•°çš„æ•°ç»„ï¼Œä¹Ÿå°±æ˜¯ä¸­é—´ä»¶å‰¥å¼€åè¿”å›çš„å‡½æ•°ç»„æˆçš„æ•°ç»„ã€‚

æˆ‘ä»¬å†çœ‹çœ‹è¿™è¡Œä»£ç 

```ts
dispatch = compose(...chain)(store.dispatch);
```

`compose` åº”è¯¥ä¸é™Œç”Ÿäº†ï¼Œç»„åˆå‡½æ•°ï¼Œè¿™é‡Œçš„ä»£ç æ”¹æˆæˆ‘ä»¬å¸¸è§çš„æ ·å­ï¼Œå°±æ˜¯ä¸‹é¢è¿™ç§å½¢å¼

```ts
function compose(...chain) {
  return (store.dispatch) => {
    return chain.reduce((a, b) => (store.dispatch) => a(b(store.dispatch)))
  }
}
```

æˆ‘ä»¬ä»¥ store.dispatch ä½œä¸ºå‚æ•°è¿›è¡Œæ³¨å…¥ï½ é€šè¿‡ compose å¯¹ä¸­é—´ä»¶æ•°ç»„å†…å‰¥å‡ºæ¥çš„é«˜é˜¶å‡½æ•°è¿›è¡Œç»„åˆå½¢æˆä¸€ä¸ªè°ƒç”¨é“¾ã€‚è°ƒç”¨ä¸€æ¬¡ï¼Œä¸­é—´ä»¶å†…çš„æ‰€æœ‰å‡½æ•°éƒ½å°†è¢«æ‰§è¡Œã€‚

çŸ¥è¯†é‡æœ‰ç‚¹å¤šï¼Œå¦‚æœè§‰å¾—æœ‰ç‚¹ä¹±ï¼Œæˆ‘ä»¬å†æ¥æ‹ä¸€æ‹ã€‚

- æŠ›å‡ºç¬¬ä¸€ä¸ªé—®é¢˜ï¼Ÿ`dispatch æ˜¯ç”¨æ¥å¹²å˜›çš„ï¼Ÿ`

dispatch æ˜¯ç”¨æ¥åˆ†å‘ action çš„`ï¼Œgoodï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ç¬¬ä¸€ä¸ªå‡½æ•°

```js
(store.dispatch) => (action) => {}
```

- è¿™é‡ŒæŠ›å‡ºç¬¬äºŒä¸ªé—®é¢˜ï¼Œä¸ºäº†åœ¨æ¯ä¸€ä¸ªä¸­é—´ä»¶ä¸­ï¼Œéƒ½éœ€è¦å¾—åˆ°å®æ—¶çš„ store æ•°æ®ï¼Œæ€ä¹ˆæï¼Ÿ

é‚£å°±ä¸éœ€è¦åªä¼  `store.dispatch`ï¼Œå†ç»™å®ƒä¼ ä¸€ä¸ª `store.getState`ï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¿®æ”¹åçš„å‡½æ•°

```js
(store.dispatch, store.getState) => (action) => {}
```

- ç¬¬ä¸‰ä¸ªé—®é¢˜ï¼Œä¸ºäº†è®©ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ï¼Œå…·å¤‡ dispatch çš„èƒ½åŠ›ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ

é‚£å°±æŠŠ store.dispatch ä¼ ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ï¼Œè®©å®ƒå…·å¤‡ `dispatch` èƒ½åŠ›ï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¿®æ”¹åçš„å‡½æ•°

```js
(store.dispatch, store.getState) => (store.dispatch) => (action) => {}
```

- ç¬¬å››ä¸ªé—®é¢˜ï¼Œä¸ºäº†èƒ½å¤Ÿè®©æ¯ä¸€ä¸ªä¸­é—´ä»¶æŒæœ‰æœ€ç»ˆçš„ dispatchï¼Œå¦‚ä½•å¤„ç†ï¼Ÿ

redux å¼€å‘è€…åˆ©ç”¨äº†é—­åŒ…çš„ç‰¹æ€§ï¼Œå°†å†…éƒ¨çš„ dispatch ä¸å¤–éƒ¨è¿›è¡Œå¼ºç»‘å®šï¼Œä¹Ÿå°±æ˜¯è¿™æ®µä»£ç 

```js
// è¿™æ˜¯æˆ‘ä»¬æ„yinçš„ä»£ç 
let dispatch = () => {};

middlewares.map((middleware) =>
  middleware({
    getState,
    dispatch() {
      return dispatch;
    },
  })
);
```

```js
// æ˜ å°„åˆ° redux ä¸­çš„çœŸå®æºç 
let middlewareAPI = {
  getState: store.getState,
  dispatch: (action, ...args) => dispatch(action, ...args),
};

// å…¶å®ä½ æŠŠ middlewareAPI å†™åˆ° middleware é‡Œè¾¹ï¼Œå°±ç­‰ä»·äºä¸Šè¾¹é‚£ç©æ„äº†
const chain = middlewares.map((middleware) => middleware(middlewareAPI));
dispatch = compose(...chain)(store.dispatch);
```

æ‰€ä»¥æœ€ç»ˆæˆ‘ä»¬å¯¹ä¸€ä¸ªä¸­é—´ä»¶å½¢å¼å°±æ˜¯ï¼š

```ts
middleware = (store.dispatch, store.getState) => (store.dispatch) => (action) => {}

// æ”¹ä¸€ä¸‹åç§°
middleware = (store.dispatch, store.getState) => (next) => (action) => {}
```

- é—®é¢˜äº”ï¼Œdispatch åœ¨è¿™é‡Œè¾¹æ‰®æ¼”äº†ä»€ä¹ˆè§’è‰²ï¼Ÿ

- ç»‘å®šäº†å„ä¸ªä¸­é—´ä»¶çš„ nextï¼Œè¯´äº† next å®é™…ä¸Šå°±æ˜¯ store.dispatch
- æš´éœ²ä¸€ä¸ªæ¥å£ç”¨æ¥æ¥æ”¶ action

> ä½ å¯ä»¥è¿™ä¹ˆç†è§£ï¼Œä¸­é—´ä»¶å…¶å®å°±æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰äº†ä¸€ä¸ª dispatchï¼Œç„¶åè¿™ä¸ª dispatch ä¼šæŒ‰ç…§æ´‹è‘±æ¨¡å‹è¿›è¡Œ pipe

**æœ‰ä¸ªç–‘æƒ‘: ä¸ºä»€ä¹ˆåœ¨ middlewareAPI ä¸­ï¼Œdispatch ä¸æ˜¯ç›´æ¥å†™æˆ store.dispatch, è€Œæ˜¯ç”¨çš„åŒ¿åå‡½æ•°çš„é—­åŒ…å¼•ç”¨ï¼Ÿ**

```ts
// ä¸ºä»€ä¹ˆä¸è¿™ä¹ˆå†™....
let middlewareAPI = {
  getState: store.getState,
  dispatch: (action) => store.dispatch(action),
};
```

**å…¶å®å†™æˆåŒ¿åå‡½æ•°çš„é—­åŒ…å¼•ç”¨æ˜¯ä¸ºäº†æ¯ä¸€ä¸ªä¸­é—´ä»¶éƒ½å–çš„æ˜¯æœ€æ–°çš„ dispatch**ï¼Œå‡è®¾æˆ‘ä»¬ç°åœ¨æ‰§è¡ŒæŸä¸€ä¸ªä¸­é—´ä»¶ m1ï¼Œç„¶å dispatch äº† action1ï¼Œå½“æ­¤ action1 æ‰§è¡Œå®Œæ¯•ï¼Œæ¥ç€åº”è¯¥æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶ m2ï¼Œåœ¨ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ä¸­ï¼Œdispatch åº”å½“æ˜¯æœ€æ–°çš„å¼•ç”¨ï¼Œä¸ç„¶è¿™ä¸ª action2 èµ°çš„æ˜¯æ²¡æœ‰ç»è¿‡ä»»ä½•ä¸­é—´ä»¶ä¿®é¥°çš„ store.dispatchï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸è¡Œçš„ã€‚æ‰€ä»¥è¦å†™æˆåŒ¿åå‡½æ•°çš„é—­åŒ…å¼•ç”¨ã€‚

### ç»“åˆ rc-redux-model æºç 

ä¸Šé¢çœ‹å®Œä¹‹åï¼Œæœ€ä¸ºé‡è¦çš„æ˜¯ä½ éœ€è¦çŸ¥é“ï¼Œä¸€ä¸ªä¸­é—´ä»¶çš„ç»„æˆ

```js
const middleware = (store.dispatch, store.getState) => (next) => (action) => {}
```

è®°ä½è¿™ä¸€ç‚¹ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±å¥½åŠäº†ï¼Œå› ä¸ºæˆ‘ä»¬åšçš„æ˜¯ä¸€ä¸ª redux ä¸­é—´ä»¶ï¼Œåœ¨ä½¿ç”¨ä¸Šæ˜¯

```js
import { createStore, applyMiddleware, combineReducers } from 'redux';
import models from './models';
import RcReduxModel from 'rc-redux-model';

const reduxModel = new RcReduxModel(models);

// ğŸ‘‰ åˆ©ç”¨ combineReducers æŠŠæˆ‘ä»¬å†™çš„ reducers æè¿›å»
const reducerList = combineReducers(reduxModel.reducers);
// ğŸ‘‰ åˆ©ç”¨ applyMiddleware å°†æˆ‘ä»¬å†™çš„ä¸­é—´ä»¶æè¿›å»
return createStore(reducerList, applyMiddleware(reduxModel.thunk));
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¼€å§‹å†™ä»£ç 

#### D. å¼€å§‹å®ç° RcReduxModel ç±»

ä¸‹é¢è¿™å¼ å›¾æ˜¯ UML å›¾ï¼Œæˆ‘ä»¬å¯ä»¥æ¥çœ‹ä¸€ä¸‹ï¼Œå…±æœ‰ 3 ä¸ªæˆå‘˜å˜é‡åŠ 1 ä¸ªç§æœ‰æ–¹æ³•ã€‚

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b3eed17f36714742975252bdf6bd18f3~tplv-k3u1fbpfcp-watermark.image)

- modelsï¼šä½ ä¼ è¿›æ¥çš„ models ç»è¿‡ä¸€ç³»åˆ—å¤„ç†ä¹‹åçš„æœ€ç»ˆ models
- reducersï¼šæ‰€æœ‰ model ä¸‹çš„ reducersï¼Œæ•´åˆåœ¨ä¸€èµ·ï¼Œç”¨äº redux.combineReducers
- thunkï¼šè‡ªå·±å®ç°çš„ thunk ä¸­é—´ä»¶ï¼Œå¯¹ dispatch çš„å¢å¼ºï¼Œç”¨äº redux.applyMiddleware
- start()ï¼šä¸»é€»è¾‘ï¼Œè¯¥æ–¹æ³•ä¸‹çš„ä¸»è¦å·¥ä½œä¸º
  - è‡ªåŠ¨ä¸ºæ¯ä¸€ä¸ª state å€¼æ³¨å†Œ action
  - è‡ªåŠ¨æ³¨å†Œæ¯ä¸€ä¸ª model çš„ reducers
  - å®ç° dispatch å¯¹ä¸­é—´ä»¶çš„å¢å¼º

åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä¸€ä¸ª model çš„ç±»å‹å£°æ˜

```ts
export interface RModel {
  namespace: string; // å‘½åç©ºé—´
  openSeamlessImmutable?: boolean;
  state: {
    [key: string]: any;
  };
  action?: {
    [key: string]: ({
      dispatch,
      getState,
      currentAction,
      commit,
      call,
    }) => void;
  };
  reducers?: {
    [key: string]: any;
  };
}
```

ä¸‹é¢æ˜¯ä¼ªä»£ç ï¼Œå…·ä½“è¯·çœ‹çº¿ä¸Šä»£ç ï¼šğŸ‘‰ [index.ts](https://github.com/SugarTurboS/rc-redux-model/blob/master/core/index.ts)

```ts
class RcReduxModel {
  public models: {
    [key: string]: RModel;
  };
  public thunk: any;
  public reducers: any;

  public constructor(models: RModel[]) {
    this.models = {};
    this.reducers = {};
    this.thunk = [];
    this.start(models);
  }

  private start(models: RModel[]) {
    // step1. è‡ªåŠ¨ä¸ºæ¯ä¸€ä¸ª state éƒ½æ³¨å†Œä¸€ä¸ª actionï¼Œå¹¶ä¸”æä¾›é»˜è®¤ä¿®æ”¹ state çš„ action
    // returns è¿”å›ç»è¿‡å¤„ç†ä¹‹åçš„ model é›†åˆ
    let autoActionAndReducerModel = models.map((model: RModal) => {
      return registerAutoAction(model);
    });

    // step2. æ¯ä¸€ä¸ª model ä¸­çš„ reducers åªæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œåœ¨ redux ä¸­ï¼Œreducer æ˜¯ä¸€ä¸ªæ–¹æ³•
    // è¯¥æ–¹æ³•çš„å†™æ³•ä¸ºï¼š(state, action) => newState; æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ”¹é€ æˆç¬¦åˆ redux çš„å†™æ³•
    // æ‰èƒ½æ”¯æŒ redux.combineReducers å»ä½¿ç”¨ï¼Œè®©æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹
    autoActionAndReducerModel.forEach((model: RModal) => {
      this.reducers[model.namespace] = this.registerReducers(model); // è¯¥æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªå‡½æ•°
    });

    // step3. ä¸­é—´ä»¶å¢å¼ºï¼Œæ ¸å¿ƒä¹‹å¤„ï¼š(dispatch, getState) => (next) => (action) => {}
    // æ³¨å…¥è‡ªå®šä¹‰çš„ callAPIã€commit ç­‰åŠŸèƒ½ï¼Œå…·ä½“çœ‹ä¸‹é¢ä»£ç 
    this.thunk = middleware(autoActionAndReducerModel);

    // step4. æ£€æµ‹ model æ˜¯å¦æœ‰é‡å¤ï¼Œå¹¶å°†å¤„ç†ä¹‹åçš„ model èµ‹å€¼ç»™æˆå‘˜å˜é‡
    autoActionAndReducerModel.forEach((model: RModal) => {
      this.registerModel(model, models);
    });
  }
}
```

ä¸Šé¢å°±æ˜¯æ•´ä¸ª `RcReduxModel` ç±»çš„æ ¸å¿ƒè¦ç‚¹ï¼Œç›¸æ¯”ç»“åˆæ³¨é‡Šï¼Œå¤§å®¶éƒ½èƒ½ç†è§£ï¼Œæ¥ä¸‹æ¥æˆ‘å°†ä¸€æ­¥æ­¥å¸¦å¤§å®¶å®ç°å¯¹åº”çš„æ–¹æ³•

- registerAutoAction()ï¼šè‡ªåŠ¨ä¸ºæ¯ä¸€ä¸ª state éƒ½æ³¨å†Œä¸€ä¸ª actionï¼Œå¹¶ä¸”æä¾›é»˜è®¤ä¿®æ”¹ state çš„ action
- registerReducers()ï¼šå°† model ä¸­çš„ reducer å¯¹è±¡å˜ä¸º (state, action) => newState å‡½æ•°
- middleware()ï¼šä¸­é—´ä»¶ (dispatch, getState) => (next) => (action) => {}
- registerModel()ï¼šæ‰€æœ‰ model çš„é›†åˆ

#### registerAutoAction()

è¯¥æ–¹æ³•æ¥æ”¶çš„æ˜¯ä¸€ä¸ª modelï¼Œä¸Šé¢è¯´äº†ä¸€ä¸ª model éƒ½å…·å¤‡ä»€ä¹ˆå±æ€§ï¼Œå¦‚æœä½ æ‹¿åˆ°äº†ä¸€ä¸ª modelï¼Œä½ æœŸæœ›ä¸ºæ¯ä¸€ä¸ª state æä¾›å¯¹åº”çš„ actionï¼Œè¯¥å¦‚ä½•å®ç°å‘¢ï¼Ÿ

```js
// ç”Ÿæˆè‡ªåŠ¨æ³¨å†Œä¿®æ”¹ state çš„ action.type
const generateReducerActionType = (namespace: string, key: string): string => {
  return `SET_${namespace.toUpperCase()}_${key.toUpperCase()}`;
};

export default function (model: RModel): RModel {
  let nextAction: any = {};
  let nextReducers: any = {};

  const {
    namespace,
    state = {},
    action = {},
    reducers = {},
    openSeamlessImmutable,
  } = model;

  // step1. å¦‚æœæ²¡æœ‰ stateï¼Œé‚£å°±ä¸éœ€è¦è‡ªåŠ¨æ³¨å†Œäº†
  if (Object.keys(state).length === 0) return model;

  // step2. å¦‚æœå­˜åœ¨ state å€¼ï¼Œé‚£å°±éå† stateKey
  Object.keys(state).forEach((stateKey: string) => {
    const actionTypeToReducer = generateReducerActionType(namespace, stateKey);

    // step3. ç»™æ¯ä¸€ä¸ª state éƒ½è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªèƒ½ä¿®æ”¹ state çš„ action
    if (!nextAction[`set${stateKey}`]) {
      nextAction[`set${stateKey}`] = autoAction(actionTypeToReducer);
    }

    // step4. æ³¨å†Œäº† actionï¼Œå¯¹åº”çš„ reducer åº”è¯¥è¦æœ‰ä¸€ä¸ª action.type æ˜ å°„ï¼Œå¥½ä¿®æ”¹ state å€¼
    if (!nextReducers[`${actionTypeToReducer}`]) {
      nextReducers[`${actionTypeToReducer}`] = autoReducers(
        stateKey,
        openSeamlessImmutable
      );
    }
  });

  // step5. å¦‚æœæœ‰å¤ªå¤šçš„ stateï¼Œç”¨æˆ·è®°ä¸ä½æ³¨å†Œçš„ action
  // æ‰€ä»¥è¿™é‡Œæä¾›ä¸¤ä¸ªé»˜è®¤çš„ action
  nextAction['setStore'] = autoSetStoreAction(namespace);
  nextAction['setStoreList'] = autoSetStoreListAction(namespace);

  // step6. å¦‚æœå­˜åœ¨é‡å¤ï¼Œä»¥ç”¨æˆ·å®šä¹‰çš„ä¸ºä¸»
  nextAction = { ...nextAction, ...action };
  nextReducers = { ...nextReducers, ...reducers };
  return {
    ...model,
    action: nextAction,
    reducers: nextReducers,
  };
}
```

è‡ªåŠ¨æ³¨å†Œ action çš„ä»£ç å°±è¿™ä¹ˆç‚¹ï¼Œä½†æ ¸å¿ƒåœ¨äº [autoAction](https://github.com/SugarTurboS/rc-redux-model/blob/master/core/registerAutoAction.ts#L10) çš„å®ç°å’Œ [autoReducers](https://github.com/SugarTurboS/rc-redux-model/blob/master/core/registerAutoAction.ts#L25) çš„å®ç°ã€‚

è¿™è¾¹ç»™å¤§å®¶ç•™ä¸€ä¸ªæ‚¬å¿µï¼Œæˆ‘æ€•ä½ ä»¬æ‡’å¾—å»çœ‹æºç ï¼Œæ‰€ä»¥æˆ‘è¿™é‡Œå°±ä¸è´´ä»£ç äº†ï¼Œå®ç°ä¹Ÿå¾ˆç®€å•ï¼Œå°ä¼™ä¼´ä»¬å¿«[ğŸ‘‰ ç‚¹å‡»è¿™é‡Œ](https://github.com/SugarTurboS/rc-redux-model/blob/master/core/registerAutoAction.ts) å»çœ‹æºç å•Šï¼

#### registerReducers()

è¯¥æ–¹æ³•æ¥æ”¶çš„æ˜¯ä¸€ä¸ª modelï¼Œé‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•å°† model.reducers å¯¹è±¡ï¼Œå˜æˆæˆ‘ä»¬æœŸæœ›çš„ (state, action) => newState å‘¢ï¼Ÿ

```ts
function registerReducers(model: RModel) {
  const { namespace, state, reducers } = model;

  invariant(reducers, `model's reducers must be defined, but got undefined`);

  const reducersActionTypes = Object.keys(reducers);

  return (storeState: any, storeAction: any) => {
    const newState = storeState || state;
    const reducersActionKeys = storeAction.type.split('/');
    // step1. å› ä¸ºæˆ‘ä»¬è§„å®šæ¯ä¸€ä¸ª action type éƒ½å¿…é¡»æ˜¯ [namespace]/[actionName] è¿™ç§æ ¼å¼
    const reducersActionModelName = reducersActionKeys[0];
    const reducersActionSelfName = reducersActionKeys[1];

    // step2. å¦‚æœå‘½åç©ºé—´å¯¹ä¸ä¸Šï¼Œç›´æ¥è¿”å›æ•°æ®
    if (reducersActionModelName !== namespace) return newState;

    // step3. å¦‚æœè‡ªåŠ¨æ³¨å†Œçš„ reducer type å­˜åœ¨å½“å‰è¿™ä¸ª actionNameï¼Œå°±ä¼šè§¦å‘æ‰§è¡Œï¼Œå°† state å€¼ä¿®æ”¹
    // å…¶å®çœŸæ­£ä¿®æ”¹çš„åœ¨äºä¸Šé¢çš„ autoReducers æ–¹æ³•ï¼Œä¸€å®šè¦å»çœ‹è¿™ä¸ªæ–¹æ³•
    if (reducersActionTypes.includes(reducersActionSelfName)) {
      return reducers[reducersActionSelfName](newState, storeAction.payload);
    }
    return newState;
  };
}
```

#### middleware()

è¯¥æ–¹æ³•æ¥æ”¶çš„æ˜¯ä¸€ä¸ª model é›†åˆï¼Œä¹Ÿå°±æ˜¯ `RModel[]`ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¦‚ä½•å®ç°ä¸€ä¸ªä¸­é—´ä»¶ï¼Ÿ

ä¸­é—´ä»¶çš„æ ¸å¿ƒä¹‹å¤„ `(dispatch, getState) => (next) => (action) => {}`

```ts
const getCurrentModel = (actionModelName: string, models: Array<RModel>) => {
  if (models.length === 0) return null;
  const findModel = models.filter(
    (model: RModel) => model.namespace === actionModelName
  );
  if (findModel.length > 0) return findModel[0];
  return null;
};

const actionToReducer = (
  currentModel: RModal,
  actionModelName: string,
  next: any
) => {
  return (reducerAction: any) => {
    if (currentModel && currentModel.reducers) {
      if (currentModel.reducers[reducerAction.type]) {
        next({
          type: `${actionModelName}/${reducerAction.type}`,
          payload: reducerAction.payload,
        });
      }
    }
  };
};

const callAPI = (dispatch: any) => async (service: any, params: any) => {
  let result = {};
  try {
    result = await service(params);
  } catch (error) {
    return Promise.reject(params);
  }

  return Promise.resolve(result);
};

export default function (models: RModel[]) {
  return ({ dispatch, getState }: any) =>
    (next: any) =>
    (action: any) => {
      // step1. å› ä¸ºæˆ‘ä»¬è§„å®šæ¯ä¸€ä¸ª action type éƒ½å¿…é¡»æ˜¯ [namespace]/[actionName] è¿™ç§æ ¼å¼
      const actionKeyTypes = action.type.split('/');
      invariant(actionKeyTypes.length <= 2, `dispatch action only accept [namespace/actionName], but got ${action.type}`);
      const actionModelName = actionKeyTypes[0];
      const actionSelfName = actionKeyTypes[1];

      // step2. å¾—åˆ°å½“å‰çš„ model
      const currentModel = getCurrentModel(actionModelName, models);
      if (currentModel) {
        // step3. å½“å‰è¿™ä¸ª action å¯¹è±¡ä¸­æ˜¯å¦å­˜åœ¨å½“å‰å‘çš„è¿™ä¸ª action
        const currentModelAction = currentModel.action ? currentModel.action[actionSelfName] : null;
        invariant(currentModelAction, `[${actionSelfName}] does not exist [${actionModelName}]!`);

        // step4. å¦‚æœå½“å‰è¿™ä¸ª action å­˜åœ¨å¹¶ä¸”æ˜¯ä¸€ä¸ªå‡½æ•° ï¼ˆautoAction è¿”å›çš„æ˜¯ä¸€ä¸ª Functionï¼Œæ‰€ä»¥ä¸€å®šè¦å»çœ‹è¿™ä¸ªæ–¹æ³•ï¼‰
        if (currentModelAction && typeof currentModelAction === 'function') {
          const commitActionToReducer = actionToReducer(currentModel, actionModelName, next);
          // step5. å‘èµ·ä¸€ä¸ª åŒæ­¥ actionï¼Œä¹Ÿå°±æ˜¯å‘ä¸€ä¸ªåˆ° reducer çš„ action
          // å½“ reducer æ¥æ”¶åˆ° action.type ä¸æˆ‘ä»¬å‘è¿‡æ¥çš„ä¸€è‡´æ—¶ï¼Œå°±è¿›è¡Œ state å€¼ä¿®æ”¹
          return currentModelAction({
            dispatch,
            getState,
            currentAction: action,
            commit: commitActionToReducer,
            call: callAPI(dispatch),
          });
        }
      }

      // step6. æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶ï¼Œå› ä¸º applyMiddleware å¯èƒ½ä¸ä»…æ˜¯é›†æˆæˆ‘ä»¬çš„ä¸­é—´ä»¶
      // æ„å‘³ç€å½“å‰è¿™ä¸ª action ä¹Ÿè®¸ä¸æ˜¯æˆ‘ä»¬æ‰€æœŸæœ›çš„ actionï¼Œæˆ‘ä»¬ä¸è¿™ä¸ªä¸­é—´ä»¶ä¸å¤„ç†äº†
      return next(action);
    };
}
```

#### registerModel()

è¯¥æ–¹æ³•å°±æ˜¯æ£€æµ‹ model æ˜¯å¦æœ‰é‡å¤

```ts
function registerModel(model: RModal, models: RModal[]) {
  invariant(model.namespace, `model's namespace is undefined`);
  invariant(typeof model.namespace === 'string', `model's namespace should be string, but got ${typeof model.namespace}`);
  
  const duplicateModel = models.filter((mod: RModal) => mod.namespace === model.namespace);
  invariant(duplicateModel.length <= 1, `model's namespace should be unique, but now got the same namespace length = ${duplicateModel.length}, with the same namespace is ${model.namespace}`);
  
  if (!this.models[model.namespace]) {
    this.models[model.namespace] = model;
  }
}
```

#### æ€»ç»“

ä¸Šè¿°å°±æ˜¯æ•´ä¸ª [rc-redux-model](https://github.com/SugarTurboS/rc-redux-model) æ ¸å¿ƒä»£ç ï¼Œå®ç°ä¸éš¾ï¼Œæˆ‘è¿˜æ˜¯æœŸæœ›å°ä¼™ä¼´ä»¬éƒ½èƒ½å»çœ‹æºç ï¼Œå½“ç„¶æˆ‘çš„ä»£ç å†™çš„ä¹Ÿä¸ä¸€å®šæ˜¯æœ€ä½³çš„ï¼Œå¸Œæœ›èƒ½ç»™ä½ å¸¦æ¥ä¸€äº›æ€è·¯ã€‚

å¦‚æœä½ èƒ½æ‹æ¸…æ¥šå¹¶ä¸”çœ‹æ‡‚æºç ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å®ç°ä¸€ä¸ªä¾‹å¦‚è‘—åçš„ [redux-logger](https://github.com/LogRocket/redux-logger)ï¼Œæˆ‘ä»¬ç»ƒæ‰‹å®ç°å®ƒçš„ç®€æ˜“ç‰ˆæœ¬ï¼Œå®ç°èµ·æ¥å¤§åŒå°å¼‚ï¼Œåªéœ€è¦å°†æœªä¿®æ”¹å‰çš„ redux å’Œä¿®æ”¹ä¹‹åçš„ redux æ‰“å°å‡ºæ¥ï¼Œå†æŠŠä¿®æ”¹çš„ action æ‰“å°å‡ºæ¥ï¼Œä¸€ä¸ªæœ€å°åŒ–çš„ redux æ•°æ®æ‰“å°ä¸­é—´ä»¶å°±å®Œæˆäº†ã€‚

## æœ€å

è¯¥ç¯‡å¹…ç‰¹åˆ«é•¿ï¼Œæˆ‘å¾ˆæƒ³æ‹†æˆä¸¤ç¯‡å»å†™ï¼Œä½†æœ€åæƒ³æƒ³è¿˜æ˜¯ç®—äº†ï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯ä»æˆ‘ä¸ºä»€ä¹ˆè¦åšä¸€ä¸ªä¸­é—´ä»¶ï¼Œåˆ°æˆ‘æœŸæœ›åšæˆæ€ä¹ˆæ ·ï¼Œå†åˆ°åšä¹‹å‰çš„çŸ¥è¯†å‚¨å¤‡ï¼ŒåŠæœ€ç»ˆçš„åšæˆä»€ä¹ˆæ ·ã€‚

å¸Œæœ›æˆ‘çš„ä¸€äº›æ€è€ƒå’Œå®ç°èƒ½ç»™ä½ å¸¦æ¥ä¸€äº›æ”¶è·ã€‚æœ€åå¦‚æœä½ è§‰å¾—è¯¥ä¸­é—´ä»¶è¿˜è¡Œï¼Œèƒ½ç»™ä½ ä¸€äº›å¸®åŠ©ï¼Œé‚£æˆ‘ä¸çŸ¥å»‰è€»çš„æ±‚ä¸ªå°æ˜Ÿæ˜Ÿ âœ¨ [rc-redux-model](https://github.com/SugarTurboS/rc-redux-model) 

