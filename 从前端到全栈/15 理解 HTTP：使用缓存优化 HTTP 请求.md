ä¸Šä¸€èŠ‚è¯¾ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªç®€å•çš„é™æ€èµ„æº HTTP æœåŠ¡å™¨ã€‚

è¿™ä¸ªæœåŠ¡å™¨èƒ½å¤Ÿå¤„ç†é™æ€èµ„æºè¯·æ±‚ï¼Œæ‰¾åˆ°å¯¹åº”çš„æ–‡ä»¶ï¼Œç„¶åè¿”å›æ–‡ä»¶å†…å®¹ã€‚ä½†æ˜¯è¿™ä¸ªæœåŠ¡å™¨è¿˜æœ‰å¾ˆå¤šå¯ä»¥ä¼˜åŒ–çš„åœ°æ–¹ã€‚é¦–å…ˆï¼Œå› ä¸ºé™æ€èµ„æºæ–‡ä»¶ä¸€èˆ¬ä¸ä¼šå˜åŒ–ï¼Œæ‰€ä»¥å½“å®¢æˆ·ç«¯è¯·æ±‚è¿‡æŸä¸ªæ–‡ä»¶ä¹‹åï¼Œæµè§ˆå™¨å¯ä»¥å°†è¿™ä¸ªæ–‡ä»¶ç¼“å­˜ä¸‹æ¥ã€‚è¿™ä¹ˆåšï¼Œå¯ä»¥èŠ‚çœ HTTP è¯·æ±‚ï¼Œæ—¢èƒ½å¤Ÿé™ä½æœåŠ¡å™¨çš„å¸¦å®½æ¶ˆè€—ï¼Œä¹Ÿèƒ½å¤Ÿæå‡ç”¨æˆ·çš„è®¿é—®é€Ÿåº¦ã€‚

ç¬¬ 11 èŠ‚ä¸­æˆ‘ä»¬è¯´è¿‡ï¼Œåœ¨ HTTP åè®®ä¸­ï¼ŒåŠ¨ä½œ GET å’Œ OPTIONS æ˜¯æ”¯æŒç¼“å­˜çš„ã€‚æµè§ˆå™¨æ”¯æŒä¸¤ç§æ ‡å‡†çš„ç¼“å­˜ç­–ç•¥ï¼šå¼ºç¼“å­˜å’Œåå•†ç¼“å­˜ã€‚è¿™ä¹Ÿæ˜¯å‰ç«¯é¢è¯•ä¸­ç»å¸¸æåŠçš„é—®é¢˜ã€‚

é‚£è¿™ä¸€èŠ‚è¯¾ï¼Œæˆ‘ä»¬å°±é€šè¿‡å®è·µæ¥ä½“ä¼šä¸€ä¸‹è¿™ä¸¤ç§ç¼“å­˜çš„å…·ä½“ç­–ç•¥ã€‚

## å¼ºç¼“å­˜

æµè§ˆå™¨çš„ç¼“å­˜è§„èŒƒå…è®¸æœåŠ¡å™¨è¿”å›èµ„æºçš„æ—¶å€™å¸¦æœ‰`Cache-Control`å“åº”å¤´ã€‚è¿™ä¸ªç­–ç•¥å«åš**å¼ºç¼“å­˜**ã€‚

`Cache-Control`å“åº”å¤´çš„æœ€å¸¸ç”¨æ ¼å¼ä¸ºï¼š

```
Cache-Control: max-age=<seconds>
```

å…¶ä¸­ seconds æ˜¯ç¼“å­˜çš„æ—¶é—´ï¼Œå•ä½æ˜¯ç§’ã€‚

å½“æµè§ˆå™¨è¯·æ±‚èµ„æºå¾—åˆ°çš„å“åº”å¸¦æœ‰`Cache-Control`å“åº”å¤´æ—¶ï¼Œæµè§ˆå™¨ä¼šå°†è¯¥èµ„æºç¼“å­˜åˆ°æœ¬åœ°ã€‚å½“æµè§ˆå™¨ä¸‹ä¸€æ¬¡è®¿é—®è¯¥èµ„æºæ—¶ï¼ŒåŒæ—¶æ»¡è¶³ä»¥ä¸‹ 3 ä¸ªæ¡ä»¶ï¼Œæµè§ˆå™¨ä¼šç›´æ¥ä½¿ç”¨æœ¬åœ°çš„èµ„æºï¼Œä¸å‘èµ· HTTP è¯·æ±‚ï¼š

1. ä¸¤æ¬¡è¯·æ±‚çš„ url å®Œå…¨ç›¸åŒï¼ˆåŒ…æ‹¬äº† hostã€pathnameã€queryï¼‰
2. è¯·æ±‚çš„åŠ¨ä½œæ˜¯ GET
3. è¯·æ±‚å¤´ä¸å¸¦æœ‰`Cache-Control: no-cache`å’Œ`Pragma: no-cache`è¿™ä¸¤ä¸ªä¿¡æ¯

æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ä¸Šä¸€èŠ‚è¯¾çš„ HTTP æœåŠ¡å™¨ï¼Œåœ¨å“åº”å¤´ä¸­æ·»åŠ `cache-control`è®¾ç½®ã€‚

```js
...
// http-cache-control.js

const server = http.createServer((req, res) => {
  let filePath = path.resolve(__dirname, path.join('www', url.fileURLToPath(`file:///${req.url}`)));

  if(fs.existsSync(filePath)) {
    const stats = fs.statSync(filePath);
    if(stats.isDirectory()) {
      filePath = path.join(filePath, 'index.html');
    }
    if(fs.existsSync(filePath)) {
      const {ext} = path.parse(filePath);
      res.writeHead(200, {
        'Content-Type': mime.getType(ext),
        'Cache-Control': 'max-age=86400', // ç¼“å­˜ä¸€å¤©
      });
      const fileStream = fs.createReadStream(filePath);
      fileStream.pipe(res);
    }
  } else {
    res.writeHead(404, {'Content-Type': 'text/html'});
    res.end('<h1>Not Found</h1>');
  }
});

...
```

å¦‚ä¸Šé¢ä»£ç ï¼Œæˆ‘ä»¬å¢åŠ äº†ä¸€ä¸ªå“åº”å¤´`'Cache-Control': 'max-age=86400'`ï¼Œè¡¨ç¤ºç¼“å­˜ä¸€å¤©ã€‚å¯åŠ¨ HTTP æœåŠ¡ï¼Œæˆ‘ä»¬è®¿é—®`http://localhost:8080/index.html`ã€‚çœ‹åˆ°çš„å†…å®¹å’Œä¸Šä¸€èŠ‚è¯¾çš„ä¸€æ ·ï¼š

![](https://p3.ssl.qhimg.com/t0178700f186debc72b.jpg)

ä½†æ˜¯ï¼Œå¦‚æœä½ å†æ¬¡åˆ·æ–°é¡µé¢ï¼Œåœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­æŸ¥çœ‹ Network é€‰é¡¹ï¼Œä½ ä¼šçœ‹åˆ°ä»¥ä¸‹ç»“æœï¼š

![](https://p3.ssl.qhimg.com/t0108682e06db9e5639.jpg)

æ³¨æ„ç¬¬äºŒè¡Œ logo.pngï¼ŒSize é‚£ä¸€æ æ˜¯`(memory cache)`ï¼ŒTime æ˜¯ 0msï¼Œè¿™å°±è¡¨ç¤ºæµè§ˆå™¨ç›´æ¥ä½¿ç”¨äº†ç¼“å­˜çš„å†…å®¹ï¼Œå¹¶æ²¡æœ‰å‘æœåŠ¡å™¨å‘èµ·è¯·æ±‚ã€‚

ä¸ºäº†éªŒè¯è¿™ä¸ªç»“æœï¼Œæˆ‘ä»¬å°† logo.png è¿™å¼ å›¾ç‰‡æ¢æˆç°è‰²ï¼š

![](https://p3.ssl.qhimg.com/t01154608041a9c9148.png)

ç„¶åå†åˆ·æ–°é¡µé¢ï¼Œæˆ‘ä»¬çœ‹åˆ°çš„ç»“æœé‡Œï¼Œå›¾ç‰‡è¿˜æ˜¯åŸæ¥çš„é¢œè‰²ã€‚åªæœ‰æˆ‘ä»¬è®©æµè§ˆå™¨å¼ºåˆ¶åˆ·æ–°ï¼ˆæŒ‰ä¸‹ shift ç‚¹å‡»åˆ·æ–°æŒ‰é’®ï¼‰é¡µé¢ï¼Œæ‰èƒ½çœ‹åˆ°å›¾ç‰‡çš„å˜åŒ–ã€‚

è¿™ä¸ªä¾‹å­ä¸­ï¼Œè™½ç„¶æˆ‘ä»¬ä¿®æ”¹äº† index.html é‡Œçš„å›¾ç‰‡åœ°å€ï¼Œä½†ä¸ºä»€ä¹ˆåªæœ‰å›¾ç‰‡è¢«ç¼“å­˜äº†ï¼Œè€Œ index.html é¡µé¢æ²¡æœ‰è¢«ç¼“å­˜å‘¢ï¼Ÿ

è¿™æ˜¯å› ä¸ºåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œindex.html é¡µé¢æ˜¯ç›´æ¥é€šè¿‡æµè§ˆå™¨åœ°å€æ è®¿é—®çš„ã€‚æ ¹æ®æµè§ˆå™¨çš„æ ‡å‡†ï¼Œé€šè¿‡åœ°å€æ è®¿é—®ã€ä»¥åŠå¼ºåˆ¶åˆ·æ–°ç½‘é¡µçš„æ—¶å€™ï¼ŒHTTP è¯·æ±‚å¤´è‡ªåŠ¨ä¼šå¸¦ä¸Š`Cache-Control: no-cache`å’Œ`Pragma: no-cache`çš„ä¿¡æ¯ã€‚åªè¦æœ‰è¿™ä¸¤ä¸ªè¯·æ±‚å¤´ä¹‹ä¸€ï¼Œæµè§ˆå™¨å°±ä¼šå¿½ç•¥å“åº”å¤´ä¸­çš„`Cache-Control`å­—æ®µã€‚

![](https://p2.ssl.qhimg.com/t0171d9265d914d3b86.jpg)
_æµè§ˆå™¨è¯·æ±‚ä¸­å¸¦æœ‰ Cache-Control:no-cache å’Œ Pragam:no-cache_

ğŸ’¡æ³¨æ„ï¼Œè¿™å¹¶ä¸æ˜¯è¯´ç½‘é¡µä¸ä¼šè¢«ç¼“å­˜ï¼Œè€Œæ˜¯ _èµ„æºè¢«è®¿é—®çš„æ–¹å¼_ ï¼ˆæ¯”å¦‚ç›´æ¥é€šè¿‡åœ°å€æ ï¼‰ä¼šå¯¼è‡´æœåŠ¡å™¨è¿”å›ç»™æµè§ˆå™¨å“åº”å¤´ä¸­çš„`Cache-Control`ä¿¡æ¯è¢«å¿½ç•¥ã€‚å¦‚æœè¿™ä¸ªç½‘é¡µæ˜¯é€šè¿‡ iframe åŠ è½½çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªç½‘é¡µå°±å¯èƒ½è¢«æµè§ˆå™¨ç¼“å­˜ã€‚

é€šå¸¸ï¼Œåœ¨å¼€å‘ Web åº”ç”¨æ—¶ï¼ŒæœåŠ¡å™¨éƒ½ä¼šå¸¦æœ‰å¼ºç¼“å­˜ç­–ç•¥ã€‚ä¸€èˆ¬çš„ç½‘ç«™ï¼Œé™æ€èµ„æºçš„å†…å®¹è¿˜ä¼šè¢«æ”¾åˆ° CDNï¼ˆå†…å®¹åˆ†å‘ç½‘ç»œï¼‰ä¸­ï¼Œä»¥æå‡è®¿é—®é€Ÿåº¦ã€‚CDN ç½‘å…³ä¼šç»™èµ„æºæ–‡ä»¶æ·»åŠ å¾ˆé•¿æ—¶é—´çš„å¼ºç¼“å­˜ç­–ç•¥ç”šè‡³æ˜¯æ°¸ä¹…çš„ç¼“å­˜ã€‚æ‰€ä»¥æˆ‘ä»¬æ›´æ–° Web åº”ç”¨æ—¶ï¼Œå¦‚æœæœ‰éƒ¨åˆ†é™æ€èµ„æºæ–‡ä»¶ï¼Œæ¯”å¦‚å›¾ç‰‡ã€JSã€CSS çš„å†…å®¹æ”¹å˜ï¼Œä½†æ˜¯æ–‡ä»¶åæ²¡æœ‰æ”¹å˜ï¼Œåº”ç”¨æ›´æ–°åï¼Œä¼šå‘ç° html å†…å®¹æ›´æ–°äº†ï¼Œè€Œé¡µé¢ä¸­çš„å›¾ç‰‡ã€è„šæœ¬è¿˜æ˜¯æ—§çš„ï¼Œä½†æ˜¯ç”¨æµè§ˆå™¨åœ°å€æ è®¿é—®è¿™äº›æ–‡ä»¶ï¼Œçœ‹åˆ°çš„åˆæ˜¯æ–°çš„ã€‚äº§ç”Ÿè¿™ç§â€œå¥‡æ€ªâ€çš„ç°è±¡ï¼Œå°±æ˜¯å› ä¸º**æˆ‘ä»¬æµè§ˆå™¨çš„å¼ºç¼“å­˜ç­–ç•¥ï¼Œåœ¨ä¸æ˜¯é€šè¿‡åœ°å€æ è®¿é—®èµ„æºçš„æƒ…å†µä¸‹ï¼Œéœ€è¦å¼ºåˆ¶åˆ·æ–°æ‰èƒ½æ›´æ–°èµ„æº**ã€‚

æˆ‘ä»¬æ— æ³•å¼ºè¿«ç”¨æˆ·å»å¼ºåˆ¶åˆ·æ–°æµè§ˆå™¨ï¼Œæ‰€ä»¥ä¸€èˆ¬æ¥è¯´ï¼ŒWeb åº”ç”¨æ›´æ–°æ—¶åº”è¯¥ä¸»åŠ¨å˜æ›´ä¿®æ”¹è¿‡çš„èµ„æºæ–‡ä»¶çš„ URLã€‚è¦æ”¹å˜ URLï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹æ–‡ä»¶åï¼Œæˆ–è€…åœ¨ URL ä¸Šå¢åŠ éšç€å‘å¸ƒç‰ˆæœ¬æ”¹å˜çš„ query å­—æ®µï¼Œä»¥é¿å…å¼ºç¼“å­˜è¢«è§¦å‘ã€‚è¿™ä¸ªæ­¥éª¤åœ¨ç°åœ¨çš„ Web å¼€å‘ä¸­ï¼Œä¸€èˆ¬äº¤ç»™å·¥ç¨‹åŒ–è„šæœ¬å»å®Œæˆã€‚

## åå•†ç¼“å­˜

ä¸Šé¢ä»‹ç»çš„å¼ºç¼“å­˜ï¼Œèµ„æºä¸€æ—¦è¢«ç¼“å­˜ï¼Œåœ¨è¿‡æœŸæ—¶é—´ä¹‹å‰ï¼Œæµè§ˆå™¨ä¸ä¼šå†å‘æœåŠ¡å™¨å‘èµ·è¯·æ±‚ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨ç¼“å­˜çš„æ–‡ä»¶ï¼Œè¿™æ ·å®Œå…¨é¿å…äº†HTTPè¯·æ±‚ã€‚ä¸è¿‡å¼ºç¼“å­˜çš„ä½¿ç”¨æ¡ä»¶æ¯”è¾ƒä¸¥æ ¼ï¼Œå¯¹æµè§ˆå™¨åœ°å€æ è®¿é—®çš„èµ„æºæ— æ•ˆã€‚

å¼ºç¼“å­˜å¯¹æµè§ˆå™¨åœ°å€æ è®¿é—®çš„èµ„æºæ— æ•ˆï¼Œä½†æµè§ˆå™¨æä¾›äº†å¦ä¸€ç§ç¼“å­˜ç­–ç•¥ï¼Œå¯ä»¥ç¼“å­˜åœ°å€æ è®¿é—®çš„æ–‡ä»¶ï¼Œè¿™ç§ç­–ç•¥å«åš**åå•†ç¼“å­˜**ã€‚

åå•†ç¼“å­˜ï¼Œé¡¾åæ€ä¹‰ï¼Œä»¥ HTTP å†…å®¹åå•†çš„æ–¹å¼æ¥å®ç°çš„ç¼“å­˜ã€‚åå•†ç¼“å­˜è§„å®šï¼Œæµè§ˆå™¨å†å‘èµ· HTTP è¯·æ±‚çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨å¯ä»¥è¿”å›`Last-Modified`å“åº”å¤´ï¼Œè¿™ä¸ªå“åº”å¤´çš„å€¼æ˜¯ä¸€ä¸ªæ—¶é—´æˆ³ã€‚å¦‚æœæœåŠ¡å™¨è¿™ä¹ˆåšäº†ï¼Œé‚£ä¹ˆæµè§ˆå™¨ä¼šç¼“å­˜è¿™ä¸ªèµ„æºï¼Œå¹¶ä¸”åœ¨ä»Šåè¯·æ±‚è¯¥èµ„æºçš„æ—¶å€™ï¼Œä¼šå¸¦æœ‰`if-modified-since`è¯·æ±‚å¤´ï¼Œå®ƒçš„å€¼æ˜¯ä¸Šä¸€æ¬¡`Last-Modified`å“åº”å¤´ä¸­çš„æ—¶é—´æˆ³ã€‚

æœåŠ¡å™¨æ”¶åˆ°å¸¦æœ‰`if-modified-since`è¯·æ±‚å¤´çš„è¯·æ±‚ï¼Œæ ¹æ®è¯·æ±‚å¤´ä¸­çš„æ—¶é—´æˆ³ï¼Œå¯¹æ–‡ä»¶è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ–‡ä»¶å†…å®¹åœ¨è¯¥æ—¶é—´æˆ³ä¹‹ååˆ°å½“å‰æ—¶é—´é‡Œæ²¡æœ‰è¢«ä¿®æ”¹ï¼Œé‚£ä¹ˆæœåŠ¡å™¨è¿”å›ä¸€ä¸ª 304 å“åº”ï¼Œè¯¥å“åº”è¡¨ç¤ºåªæœ‰ HEAD æ²¡æœ‰ BODYã€‚æµè§ˆå™¨å¦‚æœæ”¶åˆ° 304 å“åº”ï¼Œå°±ä¼šä»¥ç¼“å­˜çš„å†…å®¹ä½œä¸º BODYã€‚

æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ä»£ç ï¼š

```js
// http-last-modified.js

const server = http.createServer((req, res) => {
  let filePath = path.resolve(__dirname, path.join('www', url.fileURLToPath(`file:///${req.url}`)));

  if(fs.existsSync(filePath)) {
    const stats = fs.statSync(filePath);
    if(stats.isDirectory()) {
      filePath = path.join(filePath, 'index.html');
    }
    if(fs.existsSync(filePath)) {
      const {ext} = path.parse(filePath);
      const stats = fs.statSync(filePath);
      const timeStamp = req.headers['if-modified-since'];
      let status = 200;
      if(timeStamp && Number(timeStamp) === stats.mtimeMs) {
        // å¦‚æœtimeStampå’Œstats.mtimeMSç›¸ç­‰ï¼Œè¯´æ˜æ–‡ä»¶å†…å®¹æ²¡æœ‰ä¿®æ”¹
        status = 304;
      }
      res.writeHead(status, {
        'Content-Type': mime.getType(ext),
        'Cache-Control': 'max-age=86400', // å¼ºç¼“å­˜ä¸€å¤©
        'Last-Modified': stats.mtimeMs, // åå•†ç¼“å­˜å“åº”å¤´
      });
      if(status === 200) {
        const fileStream = fs.createReadStream(filePath);
        fileStream.pipe(res);
      } else { 
        res.end(); // å¦‚æœçŠ¶æ€ç ä¸æ˜¯200ï¼Œä¸ç”¨è¿”å›Body
      }
    }
  } else {
    res.writeHead(404, {'Content-Type': 'text/html'});
    res.end('<h1>Not Found</h1>');
  }
});
```

å¦‚ä¸Šé¢ä»£ç æ‰€ç¤ºï¼Œæˆ‘ä»¬é€šè¿‡`fs.statSync(filePath)`è·å–æ–‡ä»¶ä¿¡æ¯ï¼Œå…¶ä¸­çš„`stats.mtimeMs`è¡¨ç¤ºæ–‡ä»¶çš„ä¿®æ”¹æ—¶é—´ã€‚æˆ‘ä»¬è®¾ç½®`Last-Modified`å“åº”å¤´çš„å€¼ä¸º`stats.mtimeMs`ã€‚è¿™æ ·ï¼Œå½“æµè§ˆå™¨ç¬¬ä¸€æ¬¡æ”¶åˆ°å“åº”æ—¶ï¼Œå°±ä¼šç¼“å­˜å“åº”å†…å®¹ï¼Œå¹¶ä¸”åœ¨ä»¥åè®¿é—®åŒä¸€ä¸ª URL çš„æ—¶å€™ï¼Œè‡ªåŠ¨å¸¦ä¸Š`If-Modified-Since`è¯·æ±‚å¤´ï¼Œå†…å®¹ä¸ºä¹‹å‰`Last-Modified`å“åº”å¤´çš„æ—¶é—´æˆ³ã€‚

![](https://p2.ssl.qhimg.com/t013f8676928edeaa8f.jpg)

æˆ‘ä»¬åˆ¤æ–­å¦‚æœ`If-Modified-Since`è¯·æ±‚å¤´å­˜åœ¨ï¼Œæˆ‘ä»¬æ¯”è¾ƒ`stats.mtimeMs`å’Œè¯·æ±‚å¤´æ‰€å¸¦çš„æ—¶é—´æˆ³ï¼Œå¦‚æœç›¸ç­‰ï¼Œé‚£ä¹ˆè¯´æ˜æ–‡ä»¶æ²¡æœ‰ä¿®æ”¹ï¼Œè¿™æ—¶å€™è¿”å›å“åº”çŠ¶æ€ç  304ï¼Œå¹¶ä¸”ä¸éœ€è¦è¿”å›å“åº”çš„ Body å†…å®¹ã€‚

æˆ‘ä»¬åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·å¯ä»¥çœ‹åˆ°ï¼Œç¬¬äºŒæ¬¡è®¿é—® index.html æ–‡ä»¶çš„æ—¶å€™ï¼Œè¿”å›çš„çŠ¶æ€ç æ˜¯ 304ï¼Œè€Œä¸”å“åº”å†…å®¹çš„ size å¾ˆå°ï¼Œåªæœ‰ 179 å­—èŠ‚ï¼Œè¿™æ˜¯å› ä¸ºæœåŠ¡å™¨åªè¿”å›äº†å“åº”å¤´ï¼Œè€Œä¸ç”¨è¿”å›å“åº”å†…å®¹ã€‚

![](https://p1.ssl.qhimg.com/t016901819b8ab3f51d.jpg)

æ­¤æ—¶ï¼Œå¦‚æœæˆ‘ä»¬ä¿®æ”¹äº† index.js æ–‡ä»¶ï¼š

```html
  <h1>å›å–»æ•™è‚²2</h1>
  <img src="assets/image/logo.png">
```

é‚£è¿™æ—¶å€™æ–‡ä»¶çš„ä¿®æ”¹æ—¶é—´å‘ç”Ÿäº†å˜åŒ–ï¼ŒtimeStamp ä¸å†ç­‰äº`stats.mtimeMs`ï¼Œæ‰€ä»¥æœåŠ¡å™¨åˆè¿”å› 200ï¼Œæµè§ˆå™¨å°±èƒ½ç†è§£è·å¾—çš„æ˜¯æœ€æ–°çš„èµ„æºã€‚

å› ä¸ºåå•†ç¼“å­˜æ˜¯æµè§ˆå™¨å’Œå®¢æˆ·ç«¯é€šè¿‡å†…å®¹åå•†å®ç°çš„ç¼“å­˜æœºåˆ¶ï¼Œæ‰€ä»¥ä¸€èˆ¬æ¥è¯´ï¼Œä¸ä¼šåƒå¼ºç¼“å­˜é‚£æ ·å‡ºç°æœåŠ¡å™¨ä¸Šçš„å†…å®¹æ›´æ–°äº†ï¼Œä½†æ˜¯å®¢æˆ·ç«¯æµè§ˆå™¨å› ä¸ºç¼“å­˜è€Œæ²¡æœ‰è·å–åˆ°æœ€æ–°å†…å®¹çš„æƒ…å†µã€‚

ä½†ä¹Ÿä¼šæœ‰ä¾‹å¤–ï¼Œæ¯”å¦‚æœåŠ¡å™¨æ„å¤–åˆ¤æ–­é”™äº†åå•†ç¼“å­˜çš„è¿‡æœŸæ¡ä»¶ï¼Œè¿”å›äº† 304 çŠ¶æ€ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæµè§ˆå™¨çš„å¼ºåˆ¶åˆ·æ–°ä¹Ÿå¯ä»¥æ¸…é™¤åå•†ç¼“å­˜ï¼Œå› ä¸ºå½“æµè§ˆå™¨å¼ºåˆ¶åˆ·æ–°çš„æ—¶å€™ï¼Œè¯·æ±‚å¤´ä¸ä¼šå¸¦ä¸Š`if-modified-since`ä¿¡æ¯ã€‚

åå•†ç¼“å­˜ä¸æ­¢`Last-Modified`ä¸€ç§ï¼Œè¿˜æœ‰ä¸€ç§åå•†ç¼“å­˜æ˜¯`Etag`ï¼Œå®ƒçš„æœºåˆ¶å’Œ`Last-Modified`å¤§åŒå°å¼‚ï¼Œåªæ˜¯æŠŠ`Last-Modified`çš„æ—¶é—´æˆ³æ¢æˆ`Etag`ç­¾åï¼Œç›¸åº”åœ°æŠŠ`If-Modified-Since`å­—æ®µæ¢æˆ`If-None-Match`å­—æ®µã€‚`Etag`çš„å€¼å¯ä»¥ç”¨èµ„æºæ–‡ä»¶çš„ MD5 æˆ– sha ç­¾åã€‚

åå•†ç¼“å­˜ä¸ºä»€ä¹ˆè¦æœ‰ä¸¤ç§å‘¢ï¼Ÿå› ä¸ºï¼Œæœ‰æ—¶å€™æˆ‘ä»¬çš„ç½‘ç«™æ˜¯åˆ†å¸ƒå¼éƒ¨ç½²åœ¨å¤šå°æœåŠ¡å™¨ä¸Šï¼Œä¸€ä¸ªèµ„æºæ–‡ä»¶å¯èƒ½åœ¨æ¯å°æœåŠ¡å™¨ä¸Šéƒ½æœ‰å‰¯æœ¬ï¼Œç›¸åº”åœ°èµ„æºæ–‡ä»¶è¢«ä¿®æ”¹æ—¶å€™ï¼Œæ–°çš„æ–‡ä»¶è¦åŒæ­¥åˆ°å„ä¸ªæœåŠ¡å™¨ä¸Šï¼Œå¯¼è‡´å„ä¸ªæ–‡ä»¶å‰¯æœ¬çš„ä¿®æ”¹æ—¶é—´ä¸ä¸€å®šç›¸åŒã€‚é‚£ä¹ˆå½“ç”¨æˆ·ä¸€æ¬¡è®¿é—®è¯·æ±‚çš„æœåŠ¡å™¨å’Œå¦ä¸€æ¬¡è®¿é—®è¯·æ±‚çš„æœåŠ¡å™¨ä¸åŒæ—¶ï¼Œå°±æœ‰å¯èƒ½å› ä¸ºä¸¤ä¸ªæ–‡ä»¶å‰¯æœ¬çš„ä¿®æ”¹æ—¶é—´ä¸åŒè€Œä½¿å¾—`Last-Modified`å½¢å¼çš„åå•†ç¼“å­˜å¤±æ•ˆã€‚

å¦‚æœè¿™ç§æƒ…å†µé‡‡ç”¨`Etag`å½¢å¼çš„åå•†ç¼“å­˜ï¼Œæ ¹æ®æ–‡ä»¶å†…å®¹è€Œä¸æ˜¯ä¿®æ”¹æ—¶é—´æ¥åˆ¤æ–­ç¼“å­˜ï¼Œå°±ä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜äº†ã€‚ä½¿ç”¨`Etag`å®ç°åå•†ç¼“å­˜çš„æ€è·¯ï¼Œä¸ä½¿ç”¨`Last-Modified`ç±»ä¼¼ï¼Œåªæ˜¯ç”¨æ–‡ä»¶å†…å®¹çš„ checksum æ ¡éªŒä»£æ›¿æ–‡ä»¶ä¿¡æ¯ä¸­çš„`stats.mtimeMs`æ¥åˆ¤æ–­æ–‡ä»¶å†…å®¹æ˜¯å¦è¢«ä¿®æ”¹ã€‚è¿™é‡Œå°±ä¸èµ˜è¿°äº†ï¼Œæ”¾ä¸Šå…·ä½“ä»£ç ï¼Œå¤§å®¶å¯ä»¥å¯¹æ¯”ä¸€ä¸‹ï¼š

```js
// http-etag.js

const checksum = require('checksum');

const server = http.createServer((req, res) => {
  const srvUrl = url.parse(`http://${req.url}`);
  let path = srvUrl.path;
  if(path === '/') path = '/index.html';

  const resPath = `resource${path}`;

  if(!fs.existsSync(resPath)) {
    res.writeHead(404, {'Content-Type': 'text/html'});
    return res.end('<h1>404 Not Found</h1>');
  }

  checksum.file(resPath, (err, sum) => {
    const resStream = fs.createReadStream(resPath);
    sum = `"${sum}"`; // etag è¦åŠ åŒå¼•å·

    if(req.headers['if-none-match'] === sum) {
      res.writeHead(304, {
        'Content-Type': getMimeType(resPath),
        etag: sum,
      });
      res.end();
    } else {
      res.writeHead(200, {
        'Content-Type': getMimeType(resPath),
        etag: sum,
      });
      resStream.pipe(res);
    }
  });
});

server.on('clientError', (err, socket) => {
  socket.end('HTTP/1.1 400 Bad Request\r\n\r\n');
});

server.listen(8080, () => {
  console.log('opened server on', server.address());
});
```

### æ€»ç»“

åœ¨ HTTP åè®®ä¸­ï¼Œåªæœ‰ GET å’Œ OPTIONS æ˜¯æ”¯æŒç¼“å­˜çš„ã€‚å®ƒæœ‰ä¸¤ç§ç¼“å­˜ç­–ç•¥ï¼Œåˆ†åˆ«æ˜¯å¼ºç¼“å­˜å’Œåå•†ç¼“å­˜ã€‚

å¼ºç¼“å­˜é€šè¿‡`Cache-Control`å“åº”å¤´è®¾ç½®ã€‚å¦‚æœå¼ºç¼“å­˜ç”Ÿæ•ˆï¼Œæµè§ˆå™¨ä¸ä¼šå‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨ç¼“å­˜çš„å†…å®¹ã€‚ä½†æ˜¯å¦‚æœèµ„æºæ˜¯é€šè¿‡åœ°å€æ è®¿é—®ï¼Œæˆ–è€…å¼ºåˆ¶åˆ·æ–°ç½‘é¡µçš„æ—¶å€™ï¼Œæµè§ˆå™¨çš„è¯·æ±‚å¤´å°±ä¼šå¸¦æœ‰`Cache-Control: no-cache`å’Œ`Pragma: no-cache`ï¼Œè¿™ä¼šå¯¼è‡´äº†æœåŠ¡å™¨å“åº”å¤´çš„å¼ºç¼“å­˜è¢«æµè§ˆå™¨å¿½ç•¥ã€‚

å¼ºç¼“å­˜å‘ç”Ÿçš„æ¡ä»¶æ¯”è¾ƒä¸¥æ ¼ï¼Œåªæœ‰åŒæ—¶æ»¡è¶³ä»¥ä¸‹ 3 ä¸ªæ¡ä»¶æ‰ä¼šå‘ç”Ÿï¼š
1. ä¸¤æ¬¡è¯·æ±‚çš„ url å®Œå…¨ç›¸åŒï¼ˆåŒ…æ‹¬äº† hostã€pathnameã€queryï¼‰
2. è¯·æ±‚çš„åŠ¨ä½œæ˜¯ GET æˆ–è€…æ˜¯ OPTIONS
3. è¯·æ±‚å¤´ä¸å¸¦æœ‰`Cache-Control: no-cache`å’Œ`Pragma: no-cache`è¿™ä¸¤ä¸ªä¿¡æ¯

å¦‚æœé€šè¿‡åœ°å€æ ç›´æ¥è®¿é—®çš„èµ„æºä¹Ÿèƒ½è¢«æµè§ˆå™¨ç¼“å­˜çš„è¯ï¼Œæˆ‘ä»¬éœ€è¦è¿›è¡Œåå•†ç¼“å­˜ã€‚åå•†ç¼“å­˜æ˜¯é€šè¿‡`Last-Modified`æˆ–`Etag`å“åº”å¤´è®¾ç½®ã€‚å¦‚æœåå•†ç¼“å­˜ç”Ÿæ•ˆï¼Œæµè§ˆå™¨ä»ç„¶ä¼šå‘é€è¯·æ±‚ï¼Œä½†æ˜¯æœåŠ¡å™¨ä¼šè¿”å› 304 å“åº”ï¼Œå¹¶ä¸”ä¸ä¼šè¿”å› Body å†…å®¹ã€‚

å¦‚æœæµè§ˆå™¨è¢«ç”¨æˆ·å¼ºåˆ¶åˆ·æ–°ï¼Œé‚£ä¹ˆå¼ºç¼“å­˜å’Œåå•†ç¼“å­˜éƒ½ä¼šå¤±æ•ˆã€‚å› ä¸ºå¼ºåˆ¶åˆ·æ–°ä¼šå¸¦ä¸Š`Cache-Control: no-cache`å’Œ`Pragma: no-cache`è¯·æ±‚å¤´ä¸”ä¸ä¼šå¸¦ä¸Š`If-Modified-Scene`å’Œ`If-None-Match`è¯·æ±‚å¤´ã€‚